(()=>{var H=(e=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(e,{get:(t,n)=>(typeof require<"u"?require:t)[n]}):e)(function(e){if(typeof require<"u")return require.apply(this,arguments);throw Error('Dynamic require of "'+e+'" is not supported')});var T=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports);var k=T(A=>{"use strict";A.TEMP_CHANNEL_NAME="JinnSelectionChannel";A.INPUTIMAGE="INPUTIMAGE";A.INPUTIMAGEMASK="INPUTIMAGEMASK";A.INPUTREGIONMASK="INPUTREGIONMASK";A.OUTPUTIMAGE="OUTPUTIMAGE";A.OUTPUTTEXT="OUTPUTTEXT";A.SEED="SEED";A.PROMPTTEXT="PROMPTTEXT";A.TEXTFIELD="TEXTFIELD";A.SLIDER="SLIDER";A.FIELDENUM="FIELDENUM";A.CHECKBOX="CHECKBOX";A.RADIO="RADIO";A.IMAGE_AUTO="IMAGE_AUTO";A.EXTRA_BUILDIN_KONTEXT_CHANGE="BUILDIN_KONTEXT_CHANGE";A.WFGROUP_BASE="WFGROUP_BASE";A.WFGROUP_API="WFGROUP_API";A.WFGROUP_IMGEDIT="WFGROUP_IMGEDIT";A.SETAILAYERCLOSE="close";A.SETAILAYERDEL="del";A.SETAILAYEROMIT="omit";A.DEFAULT_COMFYUI_URL="http://127.0.0.1:8188";A.OUTPUT_ZOOM="OUTPUT_ZOOM";A.OUTPUT_NOZOOM="OUTPUT_NOZOOM";A.OUTPUT_LESSZOOM="OUTPUT_LESSZOOM";A.OUTPUT_LESSREAL="OUTPUT_LESSREAL";A.OUTPUT_MOREZOOM="OUTPUT_MOREZOOM";A.OUTPUT_MOREREAL="OUTPUT_MOREREAL";A.PROMPTMODE_COMMON="COMMON";A.PROMPTMODE_BATCH="BATCH";A.PROMPTMODE_LIVE="LIVE";A.MINETYPES={".jpg":"image/jpeg",".jpeg":"image/jpeg",".png":"image/png",".bmp":"image/bmp",".gif":"image/gif",".webp":"image/webp",".avif":"image/avif",".jfif":"image/jfif"};A.VALID_IMAGE_EXTENSIONS=[".jpg",".jpeg",".png",".gif",".bmp",".webp",".avif",".jfif"];A.BATCH_TASK_FILE_NAME="task.json";A.BATCH_OUTPUT_FILE_NAME="output.json";A.LIVE_ACTIVE_PS_TOOLS=["Pencil","Brush Tool","Color Replacement Tool","Mixer Brush","Eraser","Background Eraser","Magic Eraser","Dodge Tool","Burn Tool","Sponge Tool"]});var F=T((Lu,no)=>{var{storage:nn}=H("uxp"),z=nn.localFileSystem,Su=k();async function qa(){return z.getTemporaryFolder()}async function eo(){return z.getDataFolder()}async function Na(e){return z.createSessionToken(e)}async function $a(e){return z.getFileForSaving(e)}async function Ra(e){let n=await(await eo()).createEntry("error.log",{overwrite:!0});return await n.write(e),n.nativePath}async function Fa(){return z.getFolder()}async function ja(){let e=await z.getFileForOpening();if(e)return e}async function Ha(e){return z.getEntryWithUrl(e)}async function za(e){return z.getFileForOpening(e)}async function Wa(e,t){try{let o=await(await z.getEntryWithUrl(`file:${e}`)).getEntries(),r=[];for(let a of o)if(a.isFile){let i=a.name.slice(a.name.lastIndexOf(".")).toLowerCase();t.includes(i)&&r.push(a.name)}return r}catch(n){throw console.error(n),new Error(`\u83B7\u53D6\u6587\u4EF6\u5939\u5185\u56FE\u7247\u65F6\u51FA\u9519:${e}`)}}async function Ga(e,t){try{let o=await(await z.getEntryWithUrl(`file:${e}`)).getEntries(),r=[];for(let a of o){let i=a.name.slice(a.name.lastIndexOf(".")).toLowerCase();if(a.isFile&&t.includes(i))return!0}return!1}catch{return!1}}async function Ka(e){let t;try{t=await z.getEntryWithUrl(e)}catch{try{await z.createEntryWithUrl(e,{type:"folder"})}catch(o){throw console.log(o),new Error(`\u521B\u5EFA\u76EE\u5F55\u5931\u8D25${e}`)}}try{if(t=await z.getEntryWithUrl(e),t.isFolder)return t;throw new Error(`\u76EE\u5F55\u4E0D\u6B63\u786E${e}`)}catch{throw new Error(`\u76EE\u5F55\u4E0D\u6B63\u786E${e}`)}}async function Va(e){try{return!!(await z.getEntryWithUrl(e)).isFile}catch{return!1}}function Xa(e,...t){let n=e.includes("/")?"/":"\\",o=e;(o.endsWith("/")||o.endsWith("\\"))&&(o=o.slice(0,-1));for(let r of t)(r.startsWith("/")||r.startsWith("\\"))&&(r=r.slice(1)),o+=`${n}${r}`;return o}async function Ya(e){return e.read({format:nn.formats.binary})}async function Za(e,t){return e.write(t,{format:nn.formats.binary})}async function Ja(e){let t=await z.getEntryWithUrl(e),n=await t.read(),o=JSON.parse(n);return[t,o]}async function Qa(e,t){let n=await z.createEntryWithUrl(e,{overwrite:!0});return to(n,t),n}async function to(e,t){await e.write(JSON.stringify(t,null,2))}async function ei(e,t){await e.write(t)}async function ti(e){return await(await z.getPluginFolder()).getEntry(e)}no.exports={getTemporaryFolder:qa,getDataFolder:eo,createSessionToken:Na,getFileForSaving:$a,getFileForOpening:za,getFolder:Fa,getEntryWithUrl:Ha,getImageFilePath:ja,getImageFileNamesFromFolder:Wa,getFolderWithCreate:Ka,fileExists:Va,joinPath:Xa,hasImageFile:Ga,readArrayBuffer:Ya,writeArrayBuffer:Za,writeJsonFile:to,readJsonFile:Ja,createJsonFile:Qa,writeTEXTFile:ei,writeErrorToFile:Ra,getPluginFile:ti}});var q=T((Du,co)=>{"use strict";var Pu=k(),ku=F(),L=null;function oo(){let e=new Date().toLocaleTimeString("en-US",{hour12:!1,hour:"2-digit",minute:"2-digit",second:"2-digit"}),t=Math.round(new Date().getMilliseconds());return`${e}.${t}`}function ni(e,t,n,o){let r=L.querySelector(`[data-node-id="${t}"]`);if(r){r.value=o,r.max=n;return}r=on("sp-progressbar"),r.style.margin="5 0px",r.setAttribute("data-node-id",t),r.value=o,r.max=n,window.config.showDetailLog,L.appendChild(r),L.scrollTop=L.scrollHeight}var ro=30;function on(e,t,n=!1){let o=null;return window.config.showDetailLog||L.children.length===0?o=document.createElement(e):L.children.length>0&&(L.children[L.children.length-1].style.display="none",o=document.createElement(e)),o.setAttribute("size","s"),o.style.width="100%",o}function ao(e,t){let n=on("div");if(window.config.showDetailLog){let o=oo();n.textContent=`${o} ${e}`}else n.textContent=e;L.appendChild(n),L.childNodes.length>ro&&L.removeChild(L.firstChild),L.scrollTop=L.scrollHeight,t?(n.style.color="chocolate",n.setAttribute("data-log-callback",!0),n.addEventListener("click",t)):n.addEventListener("click",lo)}function io(e){let t=on("div");if(t.addEventListener("click",lo),window.config.showDetailLog){let n=oo();t.textContent=`${n} ${e}`}else t.textContent=e;t.style.color="#ff5555",L.appendChild(t),L.childNodes.length>ro&&L.removeChild(L.firstChild),L.scrollTop=L.scrollHeight}var oi=(e,t)=>{ao(e,t),window.config.showDetailLog&&console.log(e)},ri=e=>{io(e),window.config.showDetailLog&&console.log(e)},ai=(e,t="")=>{let n="";e instanceof Error?n=`${t}${e.message}`:n=`${t}${String(e)}`,io(n),window?.config?.showDetailLog&&console.error(t,e)},ii=(e,t,n,o)=>{ni(e,t,n,o)};async function si(){document.getElementById("logArea").innerHTML=""}async function li(){let e=document.getElementById("logArea");try{let t=Array.from(e.childNodes).map(n=>n.textContent).join(`\r
`);navigator.clipboard.write({"text/plain":t})}catch(t){ao(`Copy failed: ${t.message}`)}}function so(e){window.config.showDetailLog=e,window.saveConfig(),window.config.showDetailLog?(L.className="logArea-normal",document.getElementById("logtoolbar").style.display="flex",Array.from(L.children).forEach(t=>{t.style.display="block"}),L.scrollTop=L.scrollHeight):(document.getElementById("logtoolbar").style.display="none",L.className="logArea-single",Array.from(L.children).forEach(t=>{t.style.display="none"}),L.children.length>0&&(L.children[L.children.length-1].style.display="block"))}function lo(){so(!window.config.showDetailLog)}function ci(){so(!1)}var di;function ui(){L=document.getElementById("logArea"),di=document.getElementById("logtoolbar"),document.getElementById("btnCopyLog").addEventListener("click",li),document.addEventListener("wfChangeLogSimpleEvent",ci)}co.exports={clearLog:si,initPanel:ui,log:oi,warn:ri,error:ai,progress:ii}});var G=T((qu,po)=>{"use strict";var W=H("photoshop"),{storage:Ou}=H("uxp"),Bu=H("photoshop").imaging,fi=q(),Uu=k(),Pt=F();async function mi(e,t){let o=await(await Pt.getTemporaryFolder()).createFile(t,{overwrite:!0}),r=new Uint8Array(e);return await o.write(r),o}async function pi(e,t,n){e&&await W.core.executeAsModal(async o=>{e.layers.forEach(async r=>{r.name===t&&!uo(r,n)&&r.delete()})})}async function gi(e){e&&await W.core.executeAsModal(async t=>{e.layers.forEach(async n=>{n.delete()})})}function uo(e,t){return e&&t&&e._id===t._id&&e._docId===t._docId}async function fo(e){await kt({_obj:"select",_target:[{_ref:"document",_id:e}]})}function wi(e){if(e===-1)return W.app.activeDocument;for(let t of W.app.documents)if(t.id===e)return t}async function yi(){try{let e=await W.action.batchPlay([{_obj:"get",_target:[{_property:"selection"},{_ref:"document",_enum:"ordinal",_value:"targetEnum"}]}],{});return e[0].selection&&e[0].selection.bottom?!0:null}catch(e){return console.error(e),null}}function hi(e){if(Array.isArray(e),e.length,e.length>0&&e[0]&&e[0]._obj==="error")throw new Error(`\u6267\u884C\u51FA\u9519: ${e[0].message||"\u672A\u77E5\u9519\u8BEF"}`)}async function kt(e,t){if(Array.isArray(e)||(e=[e]),!e||e.length===0)throw new Error("\u672A\u63D0\u4F9B\u4EFB\u4F55\u547D\u4EE4");let n=await W.core.executeAsModal(async o=>{let r,a;try{return r=await W.action.batchPlay(e,{synchronousExecution:!0,modalBehavior:"execute"}),hi(r),r}catch(i){throw console.error(i),r&&console.log(JSON.stringify(r,null,2)),fi.warn(JSON.stringify(e,null,2)),new Error("\u6267\u884C\u52A8\u4F5C\u51FA\u9519")}finally{}})}async function vi(e="AI\u56FE\u7247",t=1024,n=1024){let o=await W.core.executeAsModal(async r=>await W.app.documents.add({name:e,width:t,height:n,resolution:72,fill:"black"}));if(!W.app.activeDocument)throw new Error("\u521B\u5EFA\u65B0\u56FE\u7247\u5931\u8D25")}function Ei(){let e=[],t=W.app.documents;return t&&t.length>0&&t.forEach(n=>{e.push({id:n.id,name:n.name})}),e}function bi(e){let t=e.width,n=e.height;return{width:t,height:n}}function mo(){return W.app.activeDocument}function xi(e){if(!e||e<0)return!1;for(let t of W.app.documents)if(t.id===e)return!0}function _i(e){for(let t of W.app.documents)if(t.name===e)return t.id;return null}function Ci(){try{return mo().pixelAspectRatio===1}catch{return!0}}function Ii(e){let t=e.bounds,n=t.left,o=t.top,r=t.right,a=t.bottom,i=r-n,s=a-o,l=(r+n)/2,c=(a+o)/2;return{left:n,top:o,right:r,bottom:a,width:i,height:s,centerX:l,centerY:c}}async function Ai(e){let n={_obj:"open",dontRecord:!0,forceNotify:!0,null:{_kind:"local",_path:await Pt.createSessionToken(e)},template:!1};return await kt(n),W.app.activeDocument.id}function Ti(e,t,n,o){let r=e/t,a=n/o,i,s,l,c,d;return r>a?(i=n/e,s=n,l=t*i,c=0,d=(o-l)/2):(i=o/t,l=o,s=e*i,c=(n-s)/2,d=0),{scale:i,width:s,height:l,x:c,y:d}}function Mi(e){W.action.addNotificationListener(["historyStateChanged"],e)}function Si(e){W.action.removeNotificationListener(["historyStateChanged"],e)}async function Li(e,t){fo(e.id);let o=await(await Pt.getTemporaryFolder()).createFile(t,{overwrite:!0}),r=await Pt.createSessionToken(o);return await kt({_obj:"save",as:{_obj:"JPEGFormat",extendedQuality:10,matteColor:{_enum:"matteColor",_value:"none"}},in:{_path:r,_kind:"local"},embedColorProfile:!1,copy:!0,lowerCase:!0}),o}po.exports={getDocuments:Ei,createDocument:vi,getDocumentSize:bi,activateDocument:fo,getActiveDocument:mo,existsDocument:xi,getDocumentByName:_i,getDocumentByID:wi,hasSelection:yi,deleteAllLayers:gi,deleteLayerByName:pi,saveTempFile:mi,executeCommand:kt,layerEqual:uo,getLayerBounds:Ii,addNotificationListenerForHistory:Mi,removeNotificationListenerForHistory:Si,openImageFile:Ai,saveDocumentFile:Li,isNormalRatio:Ci,scaleImageToFit:Ti}});var me=T((Nu,yo)=>{"use strict";async function Pi(e,t){try{let n=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}),o;try{o=await n.json()}catch(r){throw new Error(`\u65E0\u6CD5\u89E3\u6790\u670D\u52A1\u5668\u8FD4\u56DE\u7684JSON\uFF1A${r.message}`)}if("error"in o)throw o.error.message?new Error("serverlog=\u5DE5\u4F5C\u6D41\u672A\u901A\u8FC7\u68C0\u67E5\uFF0C\u8BF7\u67E5\u770BComfyUI\u540E\u53F0\u65E5\u5FD7"):new Error(`serverlog=${o.error}`);if(!n.ok)throw new Error(`\u8BBF\u95EECOMFYUI\u51FA\u9519 ${e}  ${n.status} ${n.statusText}`);if("comfy_error"in o)throw new Error(`serverlog=${o.comfy_error}`);return o}catch(n){throw n.message&&n.message==="Network request failed"?new Error("\u7F51\u7EDC\u9519\u8BEF\uFF0C\u65E0\u6CD5\u8FDE\u63A5\u5230COMFYUI"):n}}async function ki(e,t){try{let n=e;if(t){let a=new URLSearchParams(t).toString();n=`${e}${e.includes("?")?"&":"?"}${a}`}let o=await fetch(n,{method:"GET",headers:{"Content-Type":"application/json"}});if(!o.ok)throw new Error(`\u8BBF\u95EECOMFYUI\u51FA\u9519 ${n}  ${o.status} ${o.statusText}`);let r=await o.json();if(r&&"comfy_error"in r)throw new Error(`serverlog=${r.comfy_error}`);if("comfy_error"in r)throw new Error(`serverlog=${r.comfy_error}`);return r}catch(n){throw n.message&&n.message==="Network request failed"?new Error("\u7F51\u7EDC\u9519\u8BEF\uFF0C\u65E0\u6CD5\u8FDE\u63A5\u5230COMFYUI"):n}}async function Di(e,t){try{let n=await fetch(e,{method:"POST",body:t});if(!n.ok)throw new Error(`\u4E0A\u4F20\u56FE\u7247\u5931\u8D25  ${e},${n.status},${n.statusText}`);let o=await n.json();if("comfy_error"in o)throw new Error(`serverlog=${o.comfy_error}`);return o}catch(n){throw n.message&&n.message==="Network request failed"?new Error("\u7F51\u7EDC\u9519\u8BEF\uFF0C\u65E0\u6CD5\u8FDE\u63A5\u5230COMFYUI"):n}}async function Oi(e){try{let t=await fetch(e);if(!t.ok)throw new Error(`\u8BBF\u95EECOMFYUI\u51FA\u9519 ${e}  ${t.status} ${t.statusText}`);let n=t.headers.get("Content-Type");if(n&&n.includes("application/json")){let i=await t.json();throw new Error(`serverlog=${i.comfy_error}`)}let o=await t.arrayBuffer();if(o.byteLength<=0)throw new Error("arrayBuffer\u4E3A\u7A7A");let r=t.headers.get("X-Image-Width"),a=t.headers.get("X-Image-Height");return{arrayBuffer:o,width:r,height:a}}catch(t){throw t.message&&t.message==="Network request failed"?new Error("\u7F51\u7EDC\u9519\u8BEF\uFF0C\u65E0\u6CD5\u8FDE\u63A5\u5230COMFYUI"):t}}async function Bi(e,t){try{let n=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!n.ok)throw new Error(`\u8BBF\u95EECOMFYUI\u51FA\u9519 ${e}  ${n.status} ${n.statusText}`);let o=n.headers.get("Content-Type");if(o&&o.includes("application/json")){let a=await n.json();throw new Error(`serverlog=${a.comfy_error}`)}return await n.blob()}catch(n){throw n.message&&n.message==="Network request failed"?new Error("\u7F51\u7EDC\u9519\u8BEF\uFF0C\u65E0\u6CD5\u8FDE\u63A5\u5230COMFYUI"):n}}function Ui(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=Math.random()*16|0,n=e==="x"?t:t&3|8;return n.toString(16)})}function qi(e){return new Promise(t=>setTimeout(t,e))}function Ni(e,t="userSettings"){let n=wx.getStorageSync(t);(n==null||n==="")&&(n=[]),n.length>=10&&n.shift(),n.push(e),setLocal(n,t)}function $i(e){return e==null||e.trim()===""}function Ri(e,t){return Math.floor(Math.random()*(t-e+1))+e}var wo=e=>{let t=e.getFullYear(),n=e.getMonth()+1,o=e.getDate(),r=e.getHours(),a=e.getMinutes(),i=e.getSeconds();return`${[t,n,o].map(go).join("/")} ${[r,a,i].map(go).join(":")}`},go=e=>(e=e.toString(),e[1]?e:`0${e}`),Fi=()=>{let e=getCurrentPages();return e[e.length-1].route},ji=()=>wo(new Date);function Hi(e){try{let t=e.lastIndexOf(".");if(t===-1)return[e,""];let n=e.substring(0,t),o=e.substring(t).toLowerCase();return[n,o]}catch(t){throw console.error("\u63D0\u53D6\u6587\u4EF6\u540D\u548C\u6269\u5C55\u540D\u5931\u8D25:",t),t}}function zi(){let e=new Date().toLocaleTimeString("en-US",{hour12:!1,hour:"2-digit",minute:"2-digit",second:"2-digit"}),t=Math.round(new Date().getMilliseconds()/100);return`${e}`}function Wi(e){return/[\u4e00-\u9fa5]/.test(e)}yo.exports={post:Pi,get:ki,generateUUID:Ui,downloadImage:Oi,downloadImagePost:Bi,randInt:Ri,uploadImage:Di,appendLocal:Ni,formatTime:wo,now:ji,getCurrPageRoute:Fi,isEmpty:$i,sleep:qi,extractFileNameAndExtension:Hi,getCurrentTime:zi,containsChinese:Wi}});var N=T((Ru,Eo)=>{"use strict";var $u=G(),_=me(),he=q(),te=k();async function Gi(e){return await _.get(`${window.config.comfyuiURL}/models/checkpoints`)}async function Ki(e){return await _.get(`${e}/system_stats`)}async function Vi(e){try{return[!0,(await _.get(`${e}/jinn_test`)).buildin]}catch{return[!1,!1]}}async function Xi(){return await _.get(`${window.config.comfyuiURL}/jinn_get_wf_api_run`)}async function Yi(e,t){return await _.get(`${window.config.comfyuiURL}/jinn_get_wf_params?${new URLSearchParams({wfname:e,wfcode:t}).toString()}`)}async function Zi(e,t){return await _.get(`${window.config.comfyuiURL}/jinn_get_wf_api?${new URLSearchParams({wfname:e,wfcode:t}).toString()}`)}async function Ji(){return(await _.get(`${window.config.comfyuiURL}/jinn_get_workflows_i2t`)).items}async function Qi(){return(await _.get(`${window.config.comfyuiURL}/jinn_get_workflows_custom`)).items}async function es(){return(await _.get(`${window.config.comfyuiURL}/jinn_get_workflows_buildin`)).items}async function ts(e){return e?await _.get(`${window.config.comfyuiURL}/jinn_get_workflows_recover_buildin`):await _.get(`${window.config.comfyuiURL}/jinn_get_workflows_recover_custom`)}async function ns(e){let t=await _.post(`${window.config.comfyuiURL}/jinn_workflows_recover`,e)}async function os(e){return(await _.post(`${window.config.comfyuiURL}/jinn_save_wf_new_run`,e)).wfid}async function rs(e){let t=await _.post(`${window.config.comfyuiURL}/jinn_save_wf_edit`,e)}async function as(e){let t=await _.post(`${window.config.comfyuiURL}/jinn_save_wf_del`,e)}async function is(e){return(await _.post(`${window.config.comfyuiURL}/jinn_save_wf_copy`,e)).wfid}async function ss(e,t,n){let o=await _.post(`${window.config.comfyuiURL}/jinn_workflows_visible`,{wfid:e,wfcode:t,visible:n})}async function ls(){let e={},t=await _.post(`${window.config.comfyuiURL}/jinn_interrupt`,e)}async function cs(e){let t={preview:e},n=await _.post(`${window.config.comfyuiURL}/jinn_set_output_preview`,t)}var Dt=class extends Error{constructor(t,n){super(t),this.name=this.constructor.name,this.needinfo=n}};async function ds(e){let t=await _.post(`${window.config.comfyuiURL}/jinn_registry_user`,{user_id:e})}async function us(e,t,n,o,r,a,i,s,l=null){l!==!1&&he.log("\u6B63\u5728\u8BF7\u6C42COFMYUI.");let c=_.generateUUID(),d={client_id:c,wfname:e,wfcode:t,params:n,debug:r},u=await _.post(`${window.config.comfyuiURL}/jinn_prompt_byid`,d);if(u.verify===!1)throw new Dt(u.message,u.needinfo);u.verify_message&&(he.warn(u.verify_message),alert(u.verify_message));let f=u.prompt_id;if(l!==!1&&he.log("\u6B63\u5728\u8FD0\u884C\u5DE5\u4F5C\u6D41"),await ys(c,f,o,s,l),n.output.kind===te.OUTPUTIMAGE)return l!==!1&&he.log("\u6B63\u5728\u4E0B\u8F7D\u56FE\u7247."),ms(f,n.output.nodeid,n.output.field,a,i,l);if(n.output.kind===te.OUTPUTTEXT)return l!==!1&&he.log("\u6B63\u5728\u83B7\u53D6\u6587\u672C."),fs(f,n.output.nodeid,n.output.field,a,i,l);throw new Error(`\u672A\u77E5\u8F93\u51FA\u7C7B\u578B${n.output.kind}`)}async function fs(e,t,n,o,r,a){let i={prompt_id:e,nodeid:t,field:n},s=await _.post(`${window.config.comfyuiURL}/jinn_prompt_result_text_byid`,i);return{kind:te.OUTPUTTEXT,text:s.result}}async function ms(e,t,n,o,r,a){let i={prompt_id:e,nodeid:t,field:n},s=await _.post(`${window.config.comfyuiURL}/jinn_prompt_result_byid`,i),l=[],c=".jpg";for(let d of s){d.docwidth=r.width,d.docheight=r.height,d.zoom=o,c=d.filename.toLowerCase().endsWith(".png")?".png":".jpg";let u=new URLSearchParams(d),f=`${window.config.comfyuiURL}/jinn_view?${u.toString()}`;a!==!1&&he.log(f);let m=await _.downloadImage(f);l.push(m)}return[l,c]}async function ps(e){let t=await _.downloadImagePost(`${window.config.comfyuiURL}/jinn_prompt_preview`,{images:e});return URL.createObjectURL(t)}async function gs(e,t){let n=`${window.config.comfyuiURL}/view?filename=${e}&subfolder=${t}&type=temp`;return await _.downloadImage(n)}async function ws(e){return(await _.get(`${window.config.comfyuiURL}/jinn_get_queue/${e}`)).queue_index}async function ys(e,t,n,o,r){return new Promise((a,i)=>{let s=!1,l=g=>{try{m.close()}catch{}i(new Error(g))},c=window.config.comfyuiURL.replace(/^https?:\/\//,""),u=`${window.config.comfyuiURL.toLowerCase().startsWith("https")?"wss":"ws"}://${c}/ws?clientId=${e}`,f=0,m=new WebSocket(u);m.onerror=function(g){l("WebSocket\u51FA\u9519")},m.onclose=function(g){g.wasClean||l("WebSocket\u610F\u5916\u5173\u95ED: "+g.reason)},m.onmessage=async function(g){let w=g.data;if(typeof w=="string"){let p=JSON.parse(w);switch(p.type){case"executing":if(p.data&&p.data.node&&p.data.node in n){let P=n[p.data.node];P&&P._meta&&P._meta.title&&r!==!1&&he.log(`\u6B63\u5728\u6267\u884C${P._meta.title}(${p.data.node})`)}break;case"executed":try{if(window.config.loadTempImage&&window.config.promptMode===te.PROMPTMODE_COMMON&&p.data&&p.data.output&&p.data.output.images&&p.data.output.images[0].type==="temp"){let P=new CustomEvent("wfLoadTempImageEvent",{detail:{filename:p.data.output.images[0].filename,subfolder:p.data.output.images[0].subfolder}});document.dispatchEvent(P)}}catch{}break;case"execution_error":l("\u7B49\u5F85\u65F6\u51FA\u9519,\u8BF7\u67E5\u770BCOMFYUI\u65E5\u5FD7.");break;case"execution_interrupted":l("\u7528\u6237\u4E2D\u6B62\u751F\u56FE.");break;case"execution_success":s=!0;break;case"status":if(s===!0){m.close(),a(!0);break}if(p.data.status.exec_info.queue_remaining==0){l("\u7531\u4E8E\u79CD\u5B50\u6570\u56FA\u5B9A\u7B49\u7CFB\u7EDF\u7F13\u5B58\u539F\u56E0\uFF0C\u5DE5\u4F5C\u6D41\u672A\u88AB\u6267\u884C.");break}let b=await ws(t);if(b<0){l(`${t}\u4E0D\u5728\u961F\u5217\u4E2D`);break}else b>0&&he.log(`\u5F53\u524D\u6392\u961F\u7B2C${b+1}\u4F4D`);break;case"progress":let{value:y,max:h,node:S}=p.data,B=n[S]._meta?n[S]._meta.title:n[S].class_type;h>1&&r!==!1&&he.progress(B,S,h,y);break;default:}}}})}async function hs(e,t,n="psupload"){let o=new FormData;o.append("image",e,t),o.append("subfolder",n),o.append("filename",t);let r=await _.uploadImage(`${window.config.comfyuiURL}/jinn_upload_image_live`,o);return{path:`${r.subfolder}/${r.name}`,filename:r.name,subfolder:r.subfolder}}async function vs(e,t,n){let o="psupload",r=new FormData;r.append("image",e,t),r.append("subfolder",o),r.append("filename",t),r.append("minsize",window.config.pszoomMinsize),r.append("maxsize",window.config.pszoomMaxsize),n&&r.append("bounds",`${n.left},${n.top},${n.right},${n.bottom}`);let a=await _.uploadImage(`${window.config.comfyuiURL}/jinn_upload_image`,r);return{path:`${a.subfolder}/${a.name}`,filename:a.name,subfolder:a.subfolder}}async function Es(e,t){let n="psupload",o=new FormData;o.append("image",e,t),o.append("subfolder",n),o.append("filename",t);let r=await _.uploadImage(`${window.config.comfyuiURL}/jinn_upload_image`,o);return{path:`${r.subfolder}/${r.name}`,filename:r.name,subfolder:r.subfolder}}async function bs(e,t,n,o){let r="psupload",a=new FormData;a.append("image",e,t),a.append("maskfilename",t),a.append("maskfolder",r),a.append("imagefilename",n.filename),a.append("imagefolder",n.subfolder),a.append("minsize",window.config.pszoomMinsize),a.append("maxsize",window.config.pszoomMaxsize),o&&a.append("bounds",`${o.left},${o.top},${o.right},${o.bottom}`);let i=await _.uploadImage(`${window.config.comfyuiURL}/jinn_upload_mask`,a);return`${i.subfolder}/${i.name}`}async function xs(e){return await _.post(`${window.config.comfyuiURL}/jinn_cloud_qwen_vl`,e)}async function _s(e){return await _.post(`${window.config.comfyuiURL}/jinn_cloud_zhipu_chat`,e)}async function Cs(e){return await _.post(`${window.config.comfyuiURL}/jinn_cloud_zhipu_vision`,e)}async function Is(e){return await _.post(`${window.config.comfyuiURL}/jinn_cloud_zhipu_kontext`,e)}async function As(e){return ho(e,"zh","en","\u6C49\u8BED","\u82F1\u8BED")}async function Ts(e){return ho(e,"en","zh","\u82F1\u8BED","\u6C49\u8BED")}async function ho(e,t,n,o,r){let a;if(!window.config.transEnable)throw new Error("\u8BF7\u6253\u5F00\u53C2\u6570\u8BBE\u7F6E\uFF0C\u5F00\u542F\u7FFB\u8BD1\u529F\u80FD");if(!window.config.transBaiduAppID||!window.config.transBaiduAppKey)throw new Error("\u8BF7\u6253\u5F00\u53C2\u6570\u8BBE\u7F6E\uFF0C\u586B\u5199\u767E\u5EA6APPID\u548C\u767E\u5EA6\u79D8\u94A5");let i={text:e,appid:window.config.transBaiduAppID,appkey:window.config.transBaiduAppKey,from_lang:t,to_lang:n};return a=await _.post(`${window.config.comfyuiURL}/jinn_translate`,i),a.result}async function Ms(e){let t={duration:8,model_name:"medium"};return(await _.post(`${window.config.comfyuiURL}/jinn_sound_to_text`,t)).result}async function Ss(e,t){let n=await vo(e,t);try{return n[0]}catch{return[]}}async function vo(e,t){return await _.get(`${window.config.comfyuiURL}/jinn_get_wf_nodefield_info/${e}/${t}`)}var Ls=new Map;async function Ps(e,t){let n=`${e},${t}`;try{let o=await vo(e,t),r=o[0],a=o.length>1?o[1]:{},i;if(t.toLowerCase()==="seed"?i=te.SEED:t.toLowerCase()==="image"||a.hasOwnProperty("image_upload")&&a.image_upload===!0||r==="IMAGE"?i=te.INPUTIMAGE:Array.isArray(r)?i=te.FIELDENUM:r==="INT"?a.hasOwnProperty("min")&&a.hasOwnProperty("max")&&t.toLowerCase()==="steps"?(a="1,20,1",i=te.SLIDER):i=te.TEXTFIELD:r==="FLOAT"?a.hasOwnProperty("min")&&a.hasOwnProperty("max")&&a.hasOwnProperty("step")&&(a="0,1,0.01",i=te.SLIDER):r==="STRING"&&a.hasOwnProperty("multiline")&&a.multiline===!0&&(i=te.PROMPTTEXT),i)return Ls.set(n,i),[i,a]}catch(o){console.error("Error guessing field kind:",o)}return[null,null]}async function ks(){return await _.get(`${window.config.comfyuiURL}/jinn_wf_group_list`)}async function Ds(e){let t=await _.post(`${window.config.comfyuiURL}/jinn_wf_group_add`,{wfgroupname:e})}async function Os(e){let n=await _.post(`${window.config.comfyuiURL}/jinn_wf_group_del`,{wfgroupid:e,wfgroupname:""})}async function Bs(e,t){let n=await _.post(`${window.config.comfyuiURL}/jinn_wf_group_edit`,{wfgroupid:e,wfgroupname:t})}async function Us(e,t,n,o,r){let a=await _.post(`${window.config.comfyuiURL}/jinn_wf_group_sort`,{wfid1:e,wfid2:t,wfgroupid1:n,wfgroupid2:o,wfcode:r})}Eo.exports={VerifyError:Dt,registry_user:ds,loadTempImage:gs,loadPreviewImage:ps,prompt:us,uploadImage:vs,uploadImageBatch:Es,uploadMask:bs,load_checkpoints:Gi,get_wf_params:Yi,get_workflows_custom:Qi,get_workflows_buildin:es,get_workflows_i2t:Ji,test_comfyui:Ki,connect_comfyui:Vi,get_wf_api:Zi,save_wf_new_run:os,save_wf_edit:rs,save_wf_del:as,save_wf_copy:is,get_wf_api_run:Xi,soundToText:Ms,get_workflows_recover:ts,workflows_recover:ns,workflows_visible:ss,wf_group_list:ks,wf_group_add:Ds,wf_group_del:Os,wf_group_edit:Bs,wf_group_sort:Us,interrupt:ls,setOutputPreview:cs,translateToZH:Ts,translateToEN:As,get_wf_nodefield_enum:Ss,guessFieldKind:Ps,uploadImageLive:hs,cloud_qwen_vl:xs,cloud_zhipu_chat:_s,cloud_zhipu_vision:Cs,cloud_zhipu_kontext:Is}});var Io=T((Fu,Co)=>{"use strict";var bo=N(),qs=k();function lt(e,t=!0){let n=document.getElementById("divTestInfo");n.innerHTML=`${e}`,t?n.style.color="#ff5555":n.style.color="lightgreen"}async function Ns(e,t){let n=document.getElementById("btnConnect"),o=document.getElementById("tfComfyuiURL"),r=o.value.trim();try{r=r.match(/^https?:\/\//)?r:`http://${r}`,r=r.replace(/\/+$/,""),new URL(r)}catch(l){lt(`URL\u4E0D\u5408\u6CD5:${r}`),console.log(l);return}lt(`\u5C1D\u8BD5\u8FDE\u63A5\u5230:${r}`),n.disabled=!0;try{await bo.test_comfyui(r)}catch(l){lt("\u8FDE\u63A5COMFYUI\u5931\u8D25<br>\u8BF7\u590D\u5236\u4E0A\u9762\u7684\u5730\u5740\u5230\u6D4F\u89C8\u5668\uFF0C\u4EE5\u68C0\u67E5COMFYUI\u662F\u5426\u542F\u52A8"),console.log(l),n.disabled=!1;return}let[a,i]=await bo.connect_comfyui(r);if(a!==!0){lt("COMFYUI\u5DF2\u8FDE\u63A5,\u4F46\u662F\u6CA1\u6709\u5B89\u88C5comfyui_jinn_ps\u63D2\u4EF6<br>\u8BF7\u5C06\u5B89\u88C5\u5305\u4E2D\u7684comfyui_jinn_ps\u76EE\u5F55\u590D\u5236\u5230COMFYUI\u4E0B\u7684custom_nodes\u76EE\u5F55\uFF0C\u91CD\u542FCOMFYUI\u670D\u52A1\u518D\u8BD5"),n.disabled=!1;return}window.config.comfyuiURL=r,window.saveConfig(),o.value=window.config.comfyuiURL,lt("\u8FDE\u63A5COMFYUI\u6210\u529F!",!1),n.disabled=!1;try{await e(t)}catch(l){throw console.error(l),alert(l),l}document.getElementById("wfConnectDialog").close()}async function $s(){let e=document.getElementById("btnResetComfyuiURL"),t=document.getElementById("btnConnect");e.addEventListener("click",()=>{let n=document.getElementById("tfComfyuiURL");n.value=qs.DEFAULT_COMFYUI_URL}),t.addEventListener("click",async n=>{await Ns(xo,_o)})}var xo=null,_o=null;async function Rs(e,t){let n=document.getElementById("wfConnectDialog");if(!n){let i=await(await fetch("html/connect.html")).text(),s=document.createElement("div");s.innerHTML=i,document.body.appendChild(s.firstElementChild),n=document.getElementById("wfConnectDialog"),await $s()}let o=document.getElementById("divTestInfo");o.innerHTML="";let r=document.getElementById("tfComfyuiURL");r.value=config.comfyuiURL,xo=e,_o=t,n.showModal()}document.addEventListener("comfyuiConnectEvent",e=>{try{let{data:t,callback:n}=e.detail;Rs(n,t)}catch(t){console.error(t)}});Co.exports={}});var Ot=T((zu,So)=>{"use strict";var rn=H("photoshop"),{storage:ju}=H("uxp"),Hu=H("photoshop").imaging,ct=q(),Se=k(),dt=F(),E=G();async function Fs(e,t){if(window.config.setAILayer===Se.SETAILAYERCLOSE)try{let n=E.getDocumentByID(e);if(!n)throw new Error(`\u6CA1\u6709\u627E\u5230\u6307\u5B9A\u7684\u56FE\u7247,docid=${e}`);await rn.core.executeAsModal(async o=>{n.layers.forEach(async r=>{r.name===t&&(r.visible=!1)})})}catch(n){ct.error(n)}else if(window.config.setAILayer===Se.SETAILAYERDEL)try{let n=E.getDocumentByID(e);if(!n)throw new Error(`\u6CA1\u6709\u627E\u5230\u6307\u5B9A\u7684\u56FE\u7247,docid=${e}`);ct.log(`\u5220\u9664\u6240\u6709"${t}"\u56FE\u5C42`),await E.deleteLayerByName(n,t,null)}catch(n){ct.error(n)}}async function js(e,t,n){let o=E.getDocumentByID(e);if(!o)throw new Error(`\u6CA1\u6709\u627E\u5230\u6307\u5B9A\u7684\u56FE\u7247,docid=${e}`);return await E.saveDocumentFile(o,t)}function Ao(e,t){let n=e.channels,o=n.length;for(let r=0;r<o;r++)try{let a=n[r];if(a&&a.name===t)return!0}catch{continue}return!1}async function To(e){Ao(e,Se.TEMP_CHANNEL_NAME)&&await E.executeCommand([{_obj:"select",_target:[{_name:Se.TEMP_CHANNEL_NAME,_ref:"channel"}]},{_obj:"delete",_target:[{_enum:"ordinal",_ref:"channel",_value:"targetEnum"}]}]),await E.executeCommand([{_obj:"duplicate",_target:[{_property:"selection",_ref:"channel"}],name:Se.TEMP_CHANNEL_NAME},{_obj:"set",_target:[{_property:"selection",_ref:"channel"}],to:{_enum:"ordinal",_value:"none"}}])}async function Mo(e){if(Ao(e,"JinnSelectionChannel")){let t=[{_obj:"select",_target:[{_name:Se.TEMP_CHANNEL_NAME,_ref:"channel"}]},{_obj:"set",_target:[{_property:"selection",_ref:"channel"}],to:{_enum:"ordinal",_ref:"channel",_value:"targetEnum"}},{_obj:"delete",_target:[{_enum:"ordinal",_ref:"channel",_value:"targetEnum"}]}];await E.executeCommand(t)}}function Hs(e,t,n,o,r){let a=E.getDocumentSize(e),i=a.width,s=a.height,l=E.getLayerBounds(t),c=100;if(!(n>=i||o>=s))if(r.lesszoom===Se.OUTPUT_LESSZOOM){if(!(l.width===i||l.height===s)){let d=l.width/l.height,u=i/s;d>u?c=100*s/l.height:c=100*i/l.width}}else n===l.width||o===l.height||(c=100*n/l.width);return[c,i/2-l.centerX,s/2-l.centerY]}async function zs(e,t,n,o,r,a){if(o=parseInt(o),r=parseInt(r),await E.activateDocument(e),!E.isNormalRatio())if(await window.confirm("\u68C0\u6D4B\u5230\u975E\u6807\u51C6\u50CF\u7D20\u6BD4,\u53EF\u80FD\u5BFC\u81F4\u7A0B\u5E8F\u5361\u6B7B\u6216\u51FA\u9519\uFF0C\u5C06AI\u56FE\u7247\u65B0\u7684\u6587\u6863\u4E0A\u663E\u793A\u5417\uFF1F"))await E.createDocument(n,o,r),e=E.getActiveDocument().id;else{ct.error("\u68C0\u6D4B\u5230\u975E\u6807\u51C6\u50CF\u7D20\u6BD4,\u5DF2\u7ECF\u4E2D\u6B62\u751F\u6210");return}let i=E.getDocumentByID(e),s=await E.hasSelection(e);s&&await To(i);let l=E.getDocumentSize(i),c=l.width,d=l.height;if((o>c||r>d)&&a.morezoom===Se.OUTPUT_MOREREAL){let h={_obj:"canvasSize",canvasExtensionColorType:{_enum:"canvasExtensionColorType",_value:"backgroundColor"},width:{_unit:"pixelsUnit",_value:o},height:{_unit:"pixelsUnit",_value:r},horizontal:{_enum:"horizontalLocation",_value:"center"},vertical:{_enum:"verticalLocation",_value:"center"}};await E.executeCommand(h)}let u=i.activeLayers[0],m={_obj:"placeEvent",null:{_path:await dt.createSessionToken(t),_kind:"local"},freeTransformCenterState:{_enum:"quadCenterState",_value:"QCSAverage"},offset:{_obj:"offset",horizontal:{_unit:"pixelsUnit",_value:0},vertical:{_unit:"pixelsUnit",_value:0}}},g={_obj:"set",_target:[{_enum:"ordinal",_ref:"layer",_value:"targetEnum"}],to:{_obj:"layer",name:n}};await E.executeCommand([m,g]);let w=i.activeLayers[0];if(E.layerEqual(u,w))throw new Error("\u521B\u5EFA\u65B0\u56FE\u5C42\u5931\u8D25");let[p,b,y]=Hs(i,w,o,r,a);if(p!==100||b!==0||y!==0){let h={_obj:"transform",_target:[{_ref:"layer",_enum:"ordinal",_value:"targetEnum"}],freeTransformCenterState:{_enum:"quadCenterState",_value:"QCSCanvas"},offset:{_obj:"offset",horizontal:{_unit:"pixelsUnit",_value:b},vertical:{_unit:"pixelsUnit",_value:y}},width:{_unit:"percentUnit",_value:p},height:{_unit:"percentUnit",_value:p},linked:!0};await E.executeCommand(h)}return s&&await Mo(i),w}async function Ws(e,t,n){await E.activateDocument(e);let o=E.getDocumentByID(e),a={_obj:"placeEvent",null:{_path:await dt.createSessionToken(n),_kind:"local"},freeTransformCenterState:{_enum:"quadCenterState",_value:"QCSAverage"},offset:{_obj:"offset",horizontal:{_unit:"pixelsUnit",_value:0},vertical:{_unit:"pixelsUnit",_value:0}}},i={_obj:"set",_target:[{_enum:"ordinal",_ref:"layer",_value:"targetEnum"}],to:{_obj:"layer",name:t}};await E.executeCommand([a,i])}function Gs(e,t,n,o,r){let a=E.getLayerBounds(t);return[100*(r.right-r.left)/a.width,r.centerX-a.centerX,r.centerY-a.centerY]}async function Ks(e,t,n,o,r,a){await E.activateDocument(e);let i=E.getDocumentByID(e),s=await E.hasSelection(e);s&&await To(i);let l=i.activeLayers[0],d={_obj:"placeEvent",null:{_path:await dt.createSessionToken(t),_kind:"local"},freeTransformCenterState:{_enum:"quadCenterState",_value:"QCSAverage"},offset:{_obj:"offset",horizontal:{_unit:"pixelsUnit",_value:0},vertical:{_unit:"pixelsUnit",_value:0}}},u={_obj:"set",_target:[{_enum:"ordinal",_ref:"layer",_value:"targetEnum"}],to:{_obj:"layer",name:n}};await E.executeCommand([d,u]);let f=i.activeLayers[0];if(E.layerEqual(l,f))throw new Error("\u521B\u5EFA\u65B0\u56FE\u5C42\u5931\u8D25");let[m,g,w]=Gs(i,f,parseInt(o),parseInt(r),a);if(m>0){let p={_obj:"transform",_target:[{_ref:"layer",_enum:"ordinal",_value:"targetEnum"}],freeTransformCenterState:{_enum:"quadCenterState",_value:"QCSCanvas"},offset:{_obj:"offset",horizontal:{_unit:"pixelsUnit",_value:g},vertical:{_unit:"pixelsUnit",_value:w}},width:{_unit:"percentUnit",_value:m},height:{_unit:"percentUnit",_value:m}};await E.executeCommand(p)}return s&&await Mo(i),f}async function Vs(e,t){let n=e.selection,o=await e.createLayer({name:"AIMask",opacity:100,mode:"normal"}),r={_obj:"fill",using:{_enum:"fillContents",_value:"white"},opacity:{_unit:"percentUnit",_value:100},mode:{_enum:"blendMode",_value:"normal"}},a={_obj:"inverse"},i={_obj:"fill",using:{_enum:"fillContents",_value:"black"},opacity:{_unit:"percentUnit",_value:100},mode:{_enum:"blendMode",_value:"normal"}};await E.executeCommand([r,a,i]);let s=await E.saveDocumentFile(e,t);return await o.delete(),await E.executeCommand({_obj:"inverse"}),s}async function Xs(e,t){let n=E.getDocumentByID(e);if(await E.activateDocument(n.id),!await E.hasSelection())throw new Error("\u6CA1\u6709\u627E\u5230\u6709\u6548\u9009\u533A\uFF01");if(!n)throw new Error(`\u6CA1\u6709\u627E\u5230\u6307\u5B9A\u7684\u56FE\u7247,docid=${e}`);return await rn.core.executeAsModal(async o=>{try{return await Vs(n,t)}catch(r){throw ct.error(r),new Error("\u83B7\u53D6\u9009\u533A\u65F6\u51FA\u9519")}})}async function Ys(e){try{let t=E.getDocumentByID(e);await E.activateDocument(t.id);let n=await rn.action.batchPlay([{_obj:"get",_target:[{_property:"selection"},{_ref:"document",_enum:"ordinal",_value:"targetEnum"}]}],{});if(!(n[0].selection&&n[0].selection.bottom))return null;let o=E.getDocumentSize(t),r=o.width,a=o.height,i={left:n[0].selection.left._value,top:n[0].selection.top._value,right:n[0].selection.right._value,bottom:n[0].selection.bottom._value},s=i.right-i.left,l=i.bottom-i.top,c=0,d=Math.max(0,i.left-s*c),u=Math.max(0,i.top-l*c),f=Math.min(r,i.right+s*c),m=Math.min(a,i.bottom+l*c),g=f-d,w=m-u;g-=g%8,w-=w%8,f=d+g,m=u+w;let p={left:Math.round(d),top:Math.round(u),right:Math.round(f),bottom:Math.round(m)};return p.centerX=(p.right+p.left)/2,p.centerY=(p.bottom+p.top)/2,p}catch(t){return console.error(t),null}}async function Zs(e,t){await E.activateDocument(e);let n=E.getDocumentByID(e),o=E.getDocumentSize(n),r=o.width,a=o.height,i={_obj:"canvasSize",canvasExtensionColorType:{_enum:"canvasExtensionColorType",_value:"backgroundColor"},width:{_unit:"pixelsUnit",_value:r*2},horizontal:{_enum:"horizontalLocation",_value:"left"}};await E.executeCommand(i);let s=n.activeLayers[0],c={_obj:"placeEvent",null:{_path:await dt.createSessionToken(t),_kind:"local"},freeTransformCenterState:{_enum:"quadCenterState",_value:"QCSAverage"},offset:{_obj:"offset",horizontal:{_unit:"pixelsUnit",_value:0},vertical:{_unit:"pixelsUnit",_value:0}}};await E.executeCommand(c);let d=n.activeLayers[0];if(E.layerEqual(s,d))throw new Error("\u521B\u5EFA\u65B0\u56FE\u5C42\u5931\u8D25");d||(d=n.layers[0]);let u=E.getLayerBounds(d),f=E.scaleImageToFit(u.width,u.height,r,a).scale*100,m=r*1.5-u.centerX,g=a*.5-u.centerY,w={_obj:"transform",_target:[{_ref:"layer",_enum:"ordinal",_value:"targetEnum"}],freeTransformCenterState:{_enum:"quadCenterState",_value:"QCSCanvas"},offset:{_obj:"offset",horizontal:{_unit:"pixelsUnit",_value:m},vertical:{_unit:"pixelsUnit",_value:g}},width:{_unit:"percentUnit",_value:f},height:{_unit:"percentUnit",_value:f}};await E.executeCommand(w)}async function Js(e,t){await E.activateDocument(e);let n=E.getDocumentByID(e),o=E.getDocumentSize(n),r=o.width,a=o.height,i=n.activeLayers[0],l={_obj:"placeEvent",null:{_path:await dt.createSessionToken(t),_kind:"local"},freeTransformCenterState:{_enum:"quadCenterState",_value:"QCSAverage"},offset:{_obj:"offset",horizontal:{_unit:"pixelsUnit",_value:0},vertical:{_unit:"pixelsUnit",_value:0}}};await E.executeCommand(l);let c=n.activeLayers[0];if(E.layerEqual(i,c))throw new Error("\u521B\u5EFA\u65B0\u56FE\u5C42\u5931\u8D25");c||(c=n.layers[0]);let d=E.getLayerBounds(c),u=E.scaleImageToFit(d.width,d.height,r,a).scale*25,f={_obj:"transform",_target:[{_ref:"layer",_enum:"ordinal",_value:"targetEnum"}],freeTransformCenterState:{_enum:"quadCenterState",_value:"QCSCanvas"},width:{_unit:"percentUnit",_value:u},height:{_unit:"percentUnit",_value:u}};await E.executeCommand(f)}So.exports={addLayerImage:zs,addLayerImageRegion:Ks,preparePSImage:Fs,createPSImage:js,createSelectionMask:Xs,getSelectionSmartBounds:Ys,addLayerImageTemp:Ws,appendRight:Zs,resizeInPlace:Js}});var Oo=T((Ku,Do)=>{"use strict";var Wu=me(),Lo=F(),Gu=k(),Po="workflowstHistory.json",de={wf:{},group:{}},ut=!1;async function Bt(){try{let n=await(await(await Lo.getDataFolder()).getEntry(Po)).read();de=JSON.parse(n),de.wf||(de.wf={}),de.group||(de.group={})}catch{de={wf:{},group:{}}}finally{ut=!0}}async function ko(){try{await(await(await Lo.getDataFolder()).createEntry(Po,{overwrite:!0})).write(JSON.stringify(de,null))}catch(e){console.error("Error saving history:",e)}}async function Qs(e,t){try{ut||await Bt(),de.wf[e]=t,await ko()}catch(n){console.error(n)}}async function el(e){return ut||await Bt(),de.wf[e]}async function tl(e){return ut||await Bt(),de.group[e]}async function nl(e,t){try{ut||await Bt(),de.group[e]=t,await ko()}catch(n){console.error(n)}}Do.exports={addHistory:Qs,getHistory:el,getGroupHistory:tl,addGroupHistory:nl}});var sn=T((Vu,Ro)=>{"use strict";var ne=N(),ft=k(),qt=Oo(),mt=document.getElementById("wfButtonContainer"),Le=document.getElementById("wfGroupContainer"),ol=document.getElementById("wfGroupContainerDivider"),rl=document.getElementById("wfGroupContainerDivider2"),Xe=document.getElementById("wfButtonContainerRel"),al=document.getElementById("wfParamContainer");function il(e,t){mt.disabled=e,Array.from(mt.children).forEach(n=>{n.getAttribute("data-wfname")!==t.wfname&&(n.disabled=e)}),Array.from(Le.children).forEach(n=>{n.disabled=e}),Array.from(Xe.children).forEach(n=>{n.disabled=e})}async function sl(e){try{let t=e.target;Xe.querySelectorAll("sp-radio").forEach(s=>{s.checked=!1}),t.checked=!0;let n=t.getAttribute("data-wfname"),o=t.getAttribute("data-wfcode"),r=t.getAttribute("data-wfid"),a=t.getAttribute("data-wfidrel")||r,i=t.getAttribute("data-wfgroupid")||"";await Nt({wfid:r,wfname:n,wfcode:o||"",wfidrel:a||"",wfgroupid:i}),qt.addHistory(a,r)}catch(t){throw console.error(t),alert(`\u52A0\u8F7D\u5DE5\u4F5C\u6D41\u65F6\u51FA\u9519:${t}`),t}}async function ll(e){let t=e.currentTarget,n=t.getAttribute("data-wfgroupid"),o,r,a=await qt.getGroupHistory(n);for(let i=0;i<J.length;i++)if((J[i].wfgroupid||"")===n)if(r||(r=J[i]),a){if(J[i].wfid===a){o=J[i];break}}else{o=J[i];break}o||(o=r),Array.from(Le.children).forEach(i=>{i.setAttribute("quiet",!0),i.setAttribute("variant","secondary")}),t.removeAttribute("quiet"),t.setAttribute("variant","overBackground"),No(o)}async function Bo(e){try{let t=JSON.parse(e.getAttribute("data-rels")),n=e.getAttribute("data-wfname"),o=e.getAttribute("data-wfcode"),r=e.getAttribute("data-wfid"),a=e.getAttribute("data-wfidrel"),i=e.getAttribute("data-wfgroupid");if(n===qo.wfname)return;if(Xe.innerHTML="",t.length>0){let s=await qt.getHistory(r),l;for(let c of t){let d=document.createElement("sp-radio");d.size="s",d.style.marginLeft="10px",d.textContent=c.wfname,d.setAttribute("data-wfid",c.wfid),d.setAttribute("data-wfidrel",c.wfidrel||""),d.setAttribute("data-wfgroupid",c.wfgroupid||""),d.setAttribute("data-wfcode",c.wfcode||""),d.setAttribute("data-wfname",c.wfname),c.wfid===s&&(l=c,d.checked=!0),d.addEventListener("click",sl),Xe.appendChild(d)}l||(l=t[0],Xe.querySelector("sp-radio").checked=!0),await Nt(l)}else await Nt({wfid:r,wfname:n,wfcode:o||"",wfidrel:a||"",wfgroupid:i||""});Array.from(mt.children).forEach(s=>{s.setAttribute("quiet",!0),s.setAttribute("variant","secondary"),s.textContent=`${s.getAttribute("data-wfname")}`}),e.removeAttribute("quiet"),e.setAttribute("variant","overBackground"),localStorage.setItem("last_wfid",r),qt.addGroupHistory(i,r)}catch(t){throw console.error(t),alert(`\u52A0\u8F7D\u5DE5\u4F5C\u6D41\u65F6\u51FA\u9519:${t}`),t}}function cl(e,t){let n=e.filter(a=>a.visible!==!1),o={};n.forEach((a,i)=>{a._index=i,o[a.wfid]=a});for(let a of n)if(a.wfidrel){let i=o[a.wfidrel];i&&(i.rels||(i.rels=[]),i.rels.push(a))}let r=n.filter(a=>!a.wfidrel);for(let a of r){if(a.rels){let{rels:i,...s}=a;a.rels.push(s),a.rels.sort((l,c)=>l._index-c._index)}t[a.wfgroupid||""].num+=1}return r}var Nt,qo,J=[];async function dl(){let e={"":{name:"\u672A\u5206\u7EC4\u529F\u80FD",num:0}},t=await ne.wf_group_list();for(let o in t)t[o].num=0;let n={...e,...t};return n[ft.WFGROUP_IMGEDIT]={name:"Kontext",num:0},n[ft.WFGROUP_BASE]={name:"\u57FA\u7840\u529F\u80FD",num:0},n[ft.WFGROUP_API]={name:"\u63A5\u53E3\u670D\u52A1",num:0},n}async function ul(e,t){qo=e,Nt=t;let n=await dl(),o=localStorage.getItem("last_wfid"),r=null,a=await ne.get_workflows_custom(),i=await ne.get_workflows_buildin();J=cl([...a,...i],n);for(let s=0;s<J.length;s++)if(J[s].wfid===o){r=J[s];break}!r&&J.length>0&&(r=J[0]),Le.innerHTML="";for(let s in n){if(n[s].num===0)continue;let l=n[s].name,c=document.createElement("sp-action-button");c.style.padding="0px",c.style.height="18px",c.style.margin="0px",c.setAttribute("data-wfgroupid",s),c.setAttribute("quiet",!0),c.setAttribute("variant","secondary"),c.size="s",c.textContent=l,s===r?.wfgroupid&&(c.setAttribute("variant","overBackground"),c.removeAttribute("quiet")),c.addEventListener("click",ll),c.className="dynamic-button",Le.appendChild(c)}return Le.style.display=Le.children.length<=1?"none":"flex",ol.style.display=Le.children.length<=1?"none":"flex",rl.style.display=Le.children.length<=1?"none":"flex",No(r)}function No(e){mt.innerHTML="",al.innerHTML="",Xe.innerHTML="";let t;for(let n=0;n<J.length;n++){let o=J[n];if((o.wfgroupid||"")!==(e?.wfgroupid||""))continue;let r=document.createElement("sp-action-button");r.style.padding="0px",r.style.height="18px",r.style.margin="0px",r.setAttribute("data-wfid",o.wfid),r.setAttribute("data-wfidrel",o.wfidrel||""),r.setAttribute("data-wfgroupid",o.wfgroupid||""),r.setAttribute("data-wfcode",o.wfcode||""),r.setAttribute("data-wfname",o.wfname),r.setAttribute("data-rels",JSON.stringify(o.rels||[])),r.setAttribute("quiet",!0),r.setAttribute("variant","secondary"),r.size="s",r.textContent=o.wfname.slice(0,window.config.wfNameLength),o.wfid===e?.wfid&&(r.setAttribute("variant","overBackground"),r.removeAttribute("quiet"),t=r),r.addEventListener("click",a=>{let i=a.currentTarget;i.parentElement.disabled!==!0&&Bo(i)}),r.className="dynamic-button",mt.appendChild(r)}return t&&Bo(t),e}var $;async function Uo(e,t){try{e.preventDefault();let n=e.target.getAttribute("data-wfgroupid"),o=e.target.getAttribute("data-wfid"),r=e.target.getAttribute("data-wfcode");if($)if($.length==2)if(o){if(o===$[1]){$=null;return}pe=!0,await ne.wf_group_sort($[1],o,$[0],n,r),t?Pe():Ut()}else{if(n===$[0]){$=null;return}pe=!0,await ne.wf_group_sort($[1],"-1",$[0],n,""),t?Pe():Ut()}else if(o)$=null;else{if(n===$[0]){$=null;return}pe=!0,await ne.wf_group_sort("-1","-1",$[0],n,""),t?Pe():Ut()}else o?$=[n,o]:$=[n]}catch(n){throw console.error(n),alert(n),n}}function fl(e,t){let n=document.createElement("div");n.style.cssText="flex: 0 0 calc(25% - 2px);margin: 1px 1px;justify-content: flex-start; padding: 0;";let o=document.createElement("sp-checkbox");return o.setAttribute("data-wfid",t.wfid),o.setAttribute("data-wfname",t.wfname),o.setAttribute("data-wfgroupid",t.wfgroupid||""),o.setAttribute("data-wfcode",t.wfcode||""),o.style.paddingRight="5px",o.size="s",o.checked=t.visible!==!1,o.textContent=t.wfname,o.addEventListener("change",r=>{an(r.target)}),n.appendChild(o),e.appendChild(n),o}var pe=!1;function an(e){let t=e.getAttribute("data-wfid"),n=e.getAttribute("data-wfcode"),o=e.checked;ne.workflows_visible(t,n,o),pe=!0}async function $o(e,t=!0){let n=`
    <div style="display:flex;flex-direction:column;border:1px solid #ccc;padding:0px;margin-bottom: 15px">
      <div style="display:flex;justify-content:space-between;gap:10px;margin-top: 3px ">
        <sp-body class='title' size='s' style='padding-left:3px;'>\u81EA\u5B9A\u4E49\u5DE5\u4F5C\u6D41:</sp-body>
        <sp-textfield class="titlefield"  maxlength="12" size="s" style='padding-left:3px;width:100px;display:none'></sp-textfield>
        <div style="display:flex;justify-content:flex-end;gap:10px;padding-right:3px;">
            <sp-action-button  class='groupdel' size='s' style="display:none;">\u5220\u9664</sp-action-button>
            <sp-action-button  class='selectall' size='s' >\u5168\u9009</sp-action-button>
            <sp-action-button class='selectreverse' size='s'>\u53CD\u9009</sp-action-button>
        </div>
      </div>
      <div class='container' style="display:flex;flex-wrap:wrap;overflow-y:auto;max-height:200px;padding:3px 15px;"></div>
    </div>
      `,o=t?await ne.get_workflows_custom():await ne.get_workflows_buildin(),r=document.getElementById("workflowsConfigDialogContainer");r.innerHTML="",$=null;for(let a in e){let i=e[a].name,s=o.filter(g=>(g.wfgroupid||"")===a);if(a===""&&s.length===0)continue;let l=document.createElement("div");l.innerHTML=n;let c=l.querySelector(".container"),d=l.querySelector(".selectall"),u=l.querySelector(".selectreverse"),f=l.querySelector(".title"),m=l.querySelector(".titlefield");d.style.display=s.length===0?"none":"block",u.style.display=s.length===0?"none":"block",c.setAttribute("data-wfgroupid",a),f.innerHTML=`${i}:`,f.setAttribute("data-wfgroupid",a),m.value=i;for(let g=0;g<s.length;g++){let w=s[g];if((w.wfgroupid||"")!==a)continue;let p=fl(c,w);(t||window.buildin)&&p.addEventListener("contextmenu",b=>{Uo(b,t)})}if(a!==""&&t&&(f.addEventListener("click",()=>{f.style.display="none",m.style.display="flex",m.focus()}),m.addEventListener("change",async g=>{try{let w=m.value.trim();if(!w)return;pe=!0,await ne.wf_group_edit(a,w),Pe()}catch(w){throw console.error(w),alert(w),w}}),f.addEventListener("contextmenu",g=>{Uo(g,t)})),d.addEventListener("click",()=>{pe=!0,l.querySelectorAll("sp-checkbox").forEach(g=>{g.checked||(g.checked=!0,an(g))})}),u.addEventListener("click",()=>{pe=!0,l.querySelectorAll("sp-checkbox").forEach(g=>{g.checked=!g.checked,an(g)})}),t){let g=l.querySelector(".groupdel");g.style.display=s.length===0?"block":"none",g.setAttribute("data-wfgroupid",a),g.addEventListener("click",async w=>{await ne.wf_group_del(w.target.getAttribute("data-wfgroupid")),Pe()})}r.appendChild(l)}}async function Pe(){$=null;let e={"":{name:"\u672A\u5206\u7EC4\u529F\u80FD",num:0}},t=await ne.wf_group_list(),n={...e,...t};$o(n,!0)}async function Ut(){$=null;let e={};e[ft.WFGROUP_IMGEDIT]={name:"Kontext",num:0},e[ft.WFGROUP_BASE]={name:"\u57FA\u7840\u529F\u80FD",num:0},$o(e,!1)}async function ml(e){document.getElementById("wfConfigClose").addEventListener("click",()=>{e.close()}),e.addEventListener("click",()=>{$=null});let n=document.getElementById("workflowsConfigDialogBtnCustom"),o=document.getElementById("workflowsConfigDialogBtnBuildin"),r=document.getElementById("workflowsConfigDialogAddGroup");n.addEventListener("click",async()=>{n.removeAttribute("quiet"),n.setAttribute("variant","overBackground"),o.setAttribute("quiet",!0),o.setAttribute("variant","secondary"),r.style.display="block",Pe()}),o.addEventListener("click",()=>{o.removeAttribute("quiet"),o.setAttribute("variant","overBackground"),n.setAttribute("quiet",!0),n.setAttribute("variant","secondary"),r.style.display="none",Ut()}),r.addEventListener("click",async()=>{try{await ne.wf_group_add("\u65B0\u5EFA\u5206\u7EC4"),Pe()}catch(a){throw console.error(a),alert(a),a}}),e.addEventListener("close",()=>{pe&&(pe=!1,document.dispatchEvent(new CustomEvent("wfRefreshWorkflowEvent",{detail:{}})))})}async function pl(){let e=document.getElementById("workflowsConfigDialog");if(!e){let t=`
        <dialog id="workflowsConfigDialog" style="width:600px;height:900px;padding:10px;display:flex;flex-direction:column;gap:5px;text-align:left;overflow-y:auto;">
            <div style="display: flex;flex-direction: row; justify-content:space-between; ">
                <div style="display:flex;justify-content:flex-start;gap:10px;padding-right:3px;">
                    <sp-action-button id="workflowsConfigDialogBtnCustom"  size='s' >\u81EA\u5B9A\u4E49\u5DE5\u4F5C\u6D41</sp-action-button>
                    <sp-action-button id="workflowsConfigDialogBtnBuildin"  size='s' variant='overBackground' quiet>\u5185\u7F6E\u5DE5\u4F5C\u6D41</sp-action-button>
                </div>
                <sp-action-button variant="primary" id="workflowsConfigDialogAddGroup" size='s'>\u6DFB\u52A0\u5206\u7EC4</sp-action-button>
            </div>
            <sp-divider size="m" style="margin-bottom: 6px;margin-top: 2px "></sp-divider>
            <div id="workflowsConfigDialogContainer" style="display:flex;flex-direction: column;"></div>
            <div style="display: flex; justify-content:space-between; margin-top: auto;">
                <sp-label>\u7528\u9F20\u6807\u53F3\u952E\u4F9D\u6B21\u70B9\u51FB\u7532\u3001\u4E59\u4E24\u4E2A\u6807\u7B7E\uFF0C\u53EF\u4EE5\u5C06\u7532\u653E\u7F6E\u5230\u4E59\u7684\u524D\u9762</sp-label>
                <sp-action-button variant="primary" id="wfConfigClose">\u5173\u95ED</sp-action-button>
            </div>
        </dialog>
        `,n=document.createElement("div");n.innerHTML=t,document.body.appendChild(n.firstElementChild),e=document.getElementById("workflowsConfigDialog"),await ml(e)}pe=!1,Pe(),e.showModal()}Ro.exports={showWorkflowsPanel:ul,showWorkflowsConfigDialg:pl,disabledWorkflowButtons:il}});var Go=T((of,Wo)=>{"use strict";var Xu=me(),ue=N(),Ye=G(),ie=Ot(),U=q(),{app:Oe}=H("photoshop"),De=k(),Yu=sn(),Zu=document.getElementById("btnPrompt"),gl=document.getElementById("logContainer"),Ju=document.getElementById("btnSettings"),Qu=document.getElementById("btnInterrupt"),ef=document.getElementById("wfParamContainer"),wl=document.getElementById("wfPreviewImage"),tf=document.getElementById("lSimpleLog"),nf=document.getElementById("wfMainToolbar");function Fo(){cn=!1,ve=[],window.showSingle(gl),U.clearLog(),console.clear(),document.dispatchEvent(new CustomEvent("disabledAllUIEvent",{detail:{disabled:!0,showInterrupt:!0}}))}function pt(){cn=!1,document.dispatchEvent(new CustomEvent("disabledAllUIEvent",{detail:{disabled:!1,showInterrupt:!1}}))}async function ln(e,t,n,o=!0){U.log("\u6B63\u5728\u8BFB\u53D6PS\u56FE\u50CF");let r=n===0?"psimage.jpg":`psimage${n}.jpg`,a=await ie.createPSImage(t.docid,r,e);U.log(a.nativePath);let i=await ue.uploadImage(a,r);return U.log(i.path),ve.push({name:`\u8F93\u5165\u56FE\u7247-${t.title}`,tempFile:a}),t.value=i.path,o&&Ne.push(t.value),i}async function jo(e,t,n){let o=await ln(e,t,n,!1);U.log("\u6B63\u5728\u8BFB\u53D6PS\u9009\u533A");let r=n===0?"psmask.jpg":`psmask${n}.jpg`,a=n===0?"psmask.png":`psmask${n}.png`,i=await ie.createSelectionMask(t.docid,r),s=await ue.uploadMask(i,a,o);return U.log(s),ve.push({name:`\u8F93\u5165\u8499\u677F-${t.title}`,tempFile:i}),t.value=s,Ne.push(t.value),s}async function Ho(e,t,n){U.log("\u6B63\u5728\u8BFB\u53D6PS\u9009\u533A\u4F5C\u4E3A\u56FE\u50CF\u53CA\u8499\u677F");let o=n===0?"psareaimg.jpg":`psareaimg${n}.jpg`,r=await ie.getSelectionSmartBounds(t.docid);if(!r)throw new Error("\u6CA1\u6709\u627E\u5230\u9009\u533A");let a=await ie.createPSImage(t.docid,o,e),i=await ue.uploadImage(a,o,r);U.log(i.path),ve.push({name:`\u8F93\u5165\u5C40\u90E8\u56FE\u7247-${t.title}`,tempFile:a});let s=n===0?"psareamask.jpg":`psareamask${n}.jpg`,l=n===0?"psareamask.png":`psareamask${n}.png`,c=await ie.createSelectionMask(t.docid,s),d=await ue.uploadMask(c,l,i,r);return U.log(d),ve.push({name:`\u8F93\u5165\u5C40\u90E8\u8499\u677F-${t.title}`,tempFile:c}),t.value=d,Ne.push(t.value),r}function zo(e){let t=new Image;t.src=e,wl.src=t.src}async function yl(e,t,n,o,r){Fo();let a=null;Ne=[];try{if(!Oe.activeDocument){U.error("\u8BF7\u5148\u6253\u5F00\u4E00\u5F20\u56FE\u7247\uFF01"),pt();return}let i=n.params.filter(s=>s.kind===De.INPUTIMAGEMASK);for(let s=0;s<i.length;s++){let l=i[s];l.docid=-1,await jo(e,l,s+1)}i=n.params.filter(s=>s.kind===De.INPUTIMAGE);for(let s=0;s<i.length;s++){let l=i[s];l.docid=-1,await ln(e,l,s)}i=n.params.filter(s=>s.kind===De.INPUTREGIONMASK);for(let s=0;s<i.length;s++){let l=i[s];l.docid=-1,a=await Ho(e,l,s)}}catch(i){U.error(i),pt();return}try{let i=await ue.prompt(e,t,n,o,window.config.showDetailLog,{width:100,height:100},zo);U.log(i.text),r?r(i.text):Cl(i.text)}catch(i){U.error(i),i instanceof ue.VerifyError&&document.dispatchEvent(new CustomEvent("verifyUserEvent",{detail:{error:i}}))}finally{pt()}}var Ne=[],ke=[];async function hl(e,t,n,o,r){return t===-1?Oe.activeDocument?r.length===0?t=Oe.activeDocument.id:r.length===1?t=r[0]:t=-2:t=-2:t===-2||Ye.existsDocument(t)||(t=-2),t===-2&&(await Ye.createDocument(e,n,o),t=Oe.activeDocument.id,r.length>1&&document.dispatchEvent(new CustomEvent("refreshOutputImageMenuEvent",{detail:{docid:t,imageInputNum:r.length}}))),Ye.activateDocument(t),t}async function vl(e,t,n,o,r){Fo(),Ne=[],ke=[];let a=null,i,s=performance.now();try{for(let l=0;l<n.params.length;l++){let c=n.params[l];switch(c.kind){case De.INPUTIMAGEMASK:i=c.docid<=0?Oe.activeDocument.id:c.docid,ke.push(i),await ie.preparePSImage(i,e),await jo(e,c,ke.length);break;case De.INPUTIMAGE:i=c.docid<=0?Oe.activeDocument.id:c.docid,ke.push(i),await ie.preparePSImage(i,e),await ln(e,c,ke.length);break;case De.INPUTREGIONMASK:i=c.docid<=0?Oe.activeDocument.id:c.docid,ke.push(i),await ie.preparePSImage(i,e),a=await Ho(e,c,ke.length);break}}await El()}catch(l){U.error(l),pt();return}try{let l=n.output.lesszoom==De.OUTPUT_LESSREAL||n.output.morezoom==De.OUTPUT_MOREREAL,[c,d]=await ue.prompt(e,t,n,o,window.config.showDetailLog,l,{width:100,height:100},zo);U.log("\u6B63\u5728\u5B58\u50A8AI\u56FE\u50CF\u6587\u4EF6");let u=[];for(let p=0;p<c.length;p++){let{arrayBuffer:b,width:y,height:h}=c[p],S=await Ye.saveTempFile(b,p===0?`cfimage${d}`:`cfimage${p+1}${d}`);ve.push({name:p===0?"\u7ED3\u679C\u56FE\u7247":`\u7ED3\u679C\u56FE\u7247${p}`,tempFile:S}),U.log(`${S.nativePath} ${y}*${h}`),u.push([S,y,h])}if(U.log("\u6B63\u5728\u6DFB\u52A0\u5230\u56FE\u5C42,\u70B9\u51FB\u67E5\u770B\u8F93\u5165\u548C\u8F93\u51FA\u56FE\u7247",xl),r=await hl(e,r,u[0][1],u[0][2],ke),a)for(let[p,b,y]of u)await ie.addLayerImageRegion(r,p,e,b,y,a);else for(let[p,b,y]of u)await ie.addLayerImage(r,p,e,b,y,n.output);let[f,m,g]=u[0],w=((performance.now()-s)/1e3).toFixed(1);U.log(`\u751F\u56FE\u6210\u529F ${m}*${g} ${w}\u79D2`)}catch(l){U.error(l),l instanceof ue.VerifyError&&document.dispatchEvent(new CustomEvent("verifyUserEvent",{detail:{error:l}}))}finally{pt()}}async function El(){if(Ne.length<=1)return;let e=document.getElementById("promptPreviewDialog");if(!e){e=document.createElement("dialog"),e.id="promptPreviewDialog",e.style.cssText="width:800px;height:600px; padding:4px; display:flex; flex-direction:column; justify-content:space-between; align-items:center; text-align:center;";let n=document.createElement("img");n.style.maxWidth="100%",n.style.maxHeight="100%";let o=document.createElement("sp-button");o.textContent="\u751F\u6210",o.style.marginTop="10px",o.style.marginBottom="5px",o.style.width="200px",o.style.height="40px",o.addEventListener("click",()=>{e.close()}),e.appendChild(n),e.appendChild(o),document.body.appendChild(e)}let t=e.querySelector("img");t.src=await ue.loadPreviewImage(Ne),e.showModal(),await new Promise((n,o)=>{e.addEventListener("close",n),e.addEventListener("cancel",()=>{o("\u7528\u6237\u4E2D\u6B62\u751F\u56FE")})})}var cn=!1;async function bl(){try{cn=!0,await ue.interrupt(),U.warn("\u5C1D\u8BD5\u4E2D\u6B62\u751F\u56FE...")}catch(e){U.error(e)}}var ve=[];async function xl(){try{await Ye.createDocument("CF-TEMP",1024,1024);let e=Oe.activeDocument.id;for(let t=0;t<ve.length;t++){let n=ve[t];if(n.serverInfo){let{arrayBuffer:o,width:r,height:a}=await ue.loadTempImage(n.serverInfo.filename,n.serverInfo.subfolder),i=await Ye.saveTempFile(o,"cftemp.png"),s=n.serverInfo.filename.toLowerCase().endsWith(".png")?".png":".jpg";await ie.addLayerImageTemp(e,n.name,i)}else await ie.addLayerImageTemp(e,n.name,n.tempFile)}}catch(e){console.error(e),alert(e)}}async function _l(e){let{filename:t,subfolder:n}=e;ve.push({name:"\u4E2D\u95F4\u7ED3\u679C",serverInfo:{filename:t,subfolder:n}})}async function Cl(e){let t=document.getElementById("promptOutputTextDialog");if(!t){t=document.createElement("dialog"),t.id="promptOutputTextDialog",t.style.cssText="width:400px;height:300px; padding:10px; display:flex; flex-direction:column;justify-content:space-between; align-items:left; text-align:left;";let o=document.createElement("div"),r=document.createElement("sp-textarea");r.style.height="250px",r.setAttribute("maxlength","2500"),o.appendChild(r),r.style.width="100%",o.appendChild(r);let a=document.createElement("div");a.style.display="flex",a.style.justifyContent="flex-end";let i=document.createElement("sp-action-button");i.textContent="\u590D\u5236/\u5173\u95ED",i.style.marginTop="15px",i.addEventListener("click",()=>{let s=t.querySelector("sp-textarea");navigator.clipboard.write({"text/plain":s.value}),t.close()}),a.appendChild(i),t.appendChild(o),t.appendChild(a),document.body.appendChild(t)}let n=t.querySelector("sp-textarea");n.value=e,n.focus(),t.showModal()}Wo.exports={prompt:vl,promptOutputText:yl,interruptPrompt:bl,loadTempImage:_l}});var Vo=T((cf,Ko)=>{"use strict";var Il=H("photoshop"),{storage:rf}=H("uxp"),af=H("photoshop").imaging,Al=q(),sf=k(),Tl=F(),$e=G();async function Ml(e,t){try{await $e.deleteLayerByName(e,t,null)}catch(n){Al.error(n)}}function Sl(e,t,n,o){let r=$e.getDocumentSize(e),a=r.width,i=r.height,s=$e.getLayerBounds(t),l=s.width>=s.height?n*100/s.width:o*100/s.height,c,d;return c=a*3/4,d=i/2,[l,c-s.centerX,d-s.centerY]}var{ElementPlacement:lf}=Il.constants;async function Ll(e,t,n,o,r){let a=e.activeLayers,i=a.length>0?a[0]:null,l={_obj:"placeEvent",null:{_path:await Tl.createSessionToken(t),_kind:"local"},freeTransformCenterState:{_enum:"quadCenterState",_value:"QCSAverage"},offset:{_obj:"offset",horizontal:{_unit:"pixelsUnit",_value:0},vertical:{_unit:"pixelsUnit",_value:0}}},c={_obj:"set",_target:[{_enum:"ordinal",_ref:"layer",_value:"targetEnum"}],to:{_obj:"layer",name:n}};await $e.executeCommand([l,c],e.id);let d=e.activeLayers[0];await $e.deleteLayerByName(e,n,d);let[u,f,m]=Sl(e,d,o,r);if(u>0){let g={_obj:"transform",_target:[{_ref:"layer",_enum:"ordinal",_value:"targetEnum"}],freeTransformCenterState:{_enum:"quadCenterState",_value:"QCSCanvas"},offset:{_obj:"offset",horizontal:{_unit:"pixelsUnit",_value:f},vertical:{_unit:"pixelsUnit",_value:m}},width:{_unit:"percentUnit",_value:u},height:{_unit:"percentUnit",_value:u}};await $e.executeCommand(g,e.id)}try{if(i)try{let g={_obj:"select",_target:[{_ref:"layer",_id:i.id}],makeVisible:!1};await $e.executeCommand(g,e.id)}catch{}}catch{}return d}Ko.exports={preparePSImageLive:Ml,addLayerImageLive:Ll}});var Qo=T((df,Jo)=>{"use strict";var wt=N(),Pl=me(),$t=G(),kl=Vo(),Y=q(),{app:Xo}=H("photoshop"),gt=k(),Yo=document.getElementById("btnInterrupt"),Dl=document.getElementById("btnPrompt"),Ol=document.getElementById("logContainer"),Bl=document.getElementById("btnSettings"),Rt=document.getElementById("lSimpleLog");function Ul(){Re=!1,window.showSingle(Ol),Y.clearLog(),console.clear();let e=!0;document.dispatchEvent(new CustomEvent("disabledAllUIEvent",{detail:{disabled:!0,showInterrupt:!0}})),Dl.disabled=e,Bl.disabled=e,Yo.disabled=!e,Yo.style.display=e?"flex":"none",Rt.style.display="block",Rt.textContent=""}function Zo(){Re=!1,document.dispatchEvent(new CustomEvent("disabledAllUIEvent",{detail:{disabled:!1,showInterrupt:!1}}))}var dn=class{constructor(t,n,o,r){this.wfname=t,this.wfcode=n,this.params=o,this.apidata=r;let a=o.params.filter(s=>s.kind===gt.INPUTIMAGE);if(a.length!==1)throw new Error('\u6709\u4E14\u53EA\u80FD\u6709\u4E00\u4E2A"\u83B7\u53D6\u56FE\u7247"\u6761\u4EF6');this.param=a[0];let i=String(Math.round(new Date().getMilliseconds()));if(this.filename=`pslive${i}.jpg`,!Xo.activeDocument)throw new Error("\u8BF7\u5148\u6253\u5F00\u4E00\u5F20\u56FE\u7247\uFF01");this.doc=Xo.activeDocument,this.docid=this.doc.id,this.outputWidth=-1,this.outputHeight=-1,this.firstLivePrompt=!0,this.docLastChangedTime=0,this.liveRunning=!1,this.sensitivity=window.config.livePromptSensitivity*1e3,this.inactivityTimer=null,$t.addNotificationListenerForHistory(this.linstener),this.promptLiveOne()}linstener=async(t,n)=>{if(n.documentID===this.docid&&!this.liveRunning){if(!gt.LIVE_ACTIVE_PS_TOOLS.includes(n.name))return;clearTimeout(this.inactivityTimer),this.sensitivity===0?this.promptLiveOne():this.inactivityTimer=setTimeout(()=>{this.promptLiveOne()},this.sensitivity)}};promptLiveOne=async()=>{try{if(this.liveRunning=!0,Re)throw Re=!1,new Error("\u7528\u6237\u4E2D\u6B62\u751F\u56FE");Y.log("\u5F00\u59CB\u751F\u56FE"),Rt.textContent="\u{1F7E2}",this.firstLivePrompt&&Y.log("\u6B63\u5728\u8BFB\u53D6PS\u56FE\u50CF");let t=await $t.saveDocumentFile(this.doc,this.filename);this.firstLivePrompt&&Y.log(t.nativePath);let n=await wt.uploadImageLive(t,this.filename);this.firstLivePrompt&&Y.log(n.path),this.param.value=n.path;let o=this.outputWidth===-1?gt.OUTPUT_ZOOM:gt.OUTPUT_NOZOOM,[r,a]=await wt.prompt(this.wfname,this.wfcode,this.params,this.apidata,window.config.showDetailLog,o,{width:100,height:100},null,this.firstLivePrompt),{arrayBuffer:i,width:s,height:l}=r[0];this.outputWidth===-1&&(this.outputWidth=s,this.outputHeight=l),this.firstLivePrompt&&Y.log("\u6B63\u5728\u5B58\u50A8AI\u56FE\u50CF\u6587\u4EF6");let c=await $t.saveTempFile(i,"cfimage.png");this.firstLivePrompt&&Y.log(`${c.nativePath}  ${s}*${l}`),this.firstLivePrompt&&Y.log("\u6B63\u5728\u6DFB\u52A0\u5230\u56FE\u5C42");let d=await kl.addLayerImageLive(this.doc,c,this.wfname,this.outputWidth,this.outputHeight);if(this.firstLivePrompt=!1,Y.log(`${Pl.getCurrentTime()}\u751F\u56FE\u6210\u529F`),Re)throw Re=!1,new Error("\u7528\u6237\u4E2D\u6B62\u751F\u56FE")}catch(t){Y.error(t),this.stopLive(),t instanceof wt.VerifyError&&document.dispatchEvent(new CustomEvent("verifyUserEvent",{detail:{error:t}}))}finally{Rt.textContent="",this.liveRunning=!1}};stopLive=async()=>{try{$t.removeNotificationListenerForHistory(this.linstener)}catch(t){console.error(t)}Zo(),fe=null};paramChanged=async(t,n,o,r)=>{let a=this.params.params.find(i=>i.nodeid===n&&i.field===o);if(a){if(a.value=r,t===gt.PROMPTTEXT){let i=r;window.config.transEnable&&r&&(i=await wt.translateToEN(r)),a.valueen=i}this.liveRunning||this.promptLiveOne()}}},fe;async function ql(e,t,n,o){try{Ul(),fe=new dn(e,t,n,o)}catch(r){Y.error(r),fe&&fe.stopLive(),Zo()}}var Re=!1;async function Nl(){try{if(fe&&!fe.liveRunning){fe.stopLive(),Y.warn("\u7528\u6237\u4E2D\u6B62\u751F\u56FE");return}Re=!0,await wt.interrupt(),Y.warn("\u5C1D\u8BD5\u4E2D\u6B62\u751F\u56FE...")}catch(e){Y.error(e)}}function $l(){try{let e=document.getElementById("wfBatchPromptHelpDialog");if(e){e.showModal();return}e=document.createElement("dialog"),e.id="wfBatchPromptHelpDialog",e.style.cssText="width: 800px;height: 500px;display: flex;flex-direction: column;";let t=document.createElement("div");t.style.cssText="max-width: 100%;max-height: 100%;overflow: auto;margin: 5px;gap: 5px;display: flex;flex-direction: column;";let n=document.createElement("sp-body");n.innerHTML=`\u5B9E\u65F6\u7ED8\u753B\uFF1A<br>
        \u53EA\u9488\u5BF9\u5F53\u524D\u56FE\u7247\u64CD\u4F5C<br>
        \u5FC5\u987B\u6709\u4E00\u4E2A"\u83B7\u53D6\u56FE\u7247"\u6761\u4EF6<br>
        \u5728\u5F53\u524D\u56FE\u7247\u7684\u5DE6\u534A\u533A\u57DF\u6D82\u9E26\u7ED8\u5236\u8349\u56FE\uFF0C\u5728\u5F53\u524D\u56FE\u7247\u7684\u53F3\u534A\u533A\u57DF\u663E\u793A\u751F\u6210\u7684\u56FE\u7247<br>
        \u6BCF\u6B21\u53EA\u751F\u6210\u4E00\u5F20\u56FE\u7247(\u4E0D\u652F\u6301\u591A\u6279\u6B21)<br>
        \u751F\u56FE\u65F6\u4E0D\u8981\u53D8\u66F4\u5F53\u524D\u6587\u4EF6\uFF0C\u4E0D\u8981\u4FEE\u6539\u753B\u5E03\u5C3A\u5BF8<br>
        \u751F\u56FE\u7075\u654F\u5EA6:\u5047\u5982\u503C\u4E3A2,\u5219\u5F53\u505C\u6B62\u7ED8\u753B2\u79D2\u540E,\u5F00\u59CB\u7ED8\u5236\u4E00\u5F20AI\u56FE\u7247<br>
        \u53EA\u9488\u5BF9\u753B\u7B14\u5DE5\u5177\uFF08B\uFF09\uFF0C\u6A61\u76AE\u64E6\u5DE5\u5177\uFF08E\uFF09\u7B49\u5C11\u6570\u51E0\u79CD\u5DE5\u5177\u5B9E\u65F6\u751F\u56FE<br>
        \u5982\u679C\u4FEE\u6539\u753B\u5E03\u5185\u5BB9\u540E\u672A\u751F\u56FE\uFF0C\u53EF\u4EE5\u7528\u753B\u7B14\u5DE5\u5177\u968F\u610F\u753B\u4E00\u7B14<br>


        `,t.appendChild(n),e.appendChild(t),document.body.appendChild(e),e.showModal()}catch(e){Y.error(e)}}function Rl(e){try{let t=e.currentTarget.value;window.config.livePromptSensitivity=t,window.saveConfig(),fe&&(fe.sensitivity=parseInt(t*1e3))}catch(t){console.error(t)}}function Fl(e){try{if(fe){let t=e.currentTarget.value,n=e.currentTarget.getAttribute("data-kind"),o=e.currentTarget.getAttribute("data-nodeid"),r=e.currentTarget.getAttribute("data-field");fe.paramChanged(n,o,r,t)}}catch(t){console.error(t)}}Jo.exports={interruptPrompt:Nl,promptLive:ql,showHelp:$l,sensitivityChanged:Rl,paramChanged:Fl}});var tr=T((pf,er)=>{"use strict";var Ze=H("photoshop"),{storage:uf}=H("uxp"),ff=H("photoshop").imaging,un=q(),mf=k(),jl=F(),se=G();function Hl(e){switch(e){case 1:return[1024,512];case 2:return[1536,512];case 3:return[1024,1024]}}function zl(e,t,n,o){let r=se.getDocumentSize(e),a=r.width,i=r.height,s=se.getLayerBounds(t),l=s.width>=s.height?512*100/s.width:512*100/s.height,c,d;switch(n){case 1:c=256+512*o,d=256;break;case 2:c=256+512*o,d=256;break;case 3:let u=Math.floor(o/2),f=o%2;c=256+512*u,d=256+512*f;break}return[l,c-s.centerX,d-s.centerY]}async function Wl(e,t){try{await Ze.core.executeAsModal(async n=>{e.layers.forEach(async o=>{o.name!=="\u80CC\u666F"&&o.delete()})})}catch(n){un.error(n)}}async function Gl(e,t,n,o,r){if(await se.activateDocument(e.id),!se.isNormalRatio()){un.error("\u68C0\u6D4B\u5230\u975E\u6807\u51C6\u50CF\u7D20\u6BD4,\u4E0D\u663E\u793A\u5F53\u524D\u56FE\u50CF");return}let a=e.activeLayers[0],s={_obj:"placeEvent",null:{_path:await jl.createSessionToken(t),_kind:"local"},freeTransformCenterState:{_enum:"quadCenterState",_value:"QCSAverage"},offset:{_obj:"offset",horizontal:{_unit:"pixelsUnit",_value:0},vertical:{_unit:"pixelsUnit",_value:0}}},l={_obj:"set",_target:[{_enum:"ordinal",_ref:"layer",_value:"targetEnum"}],to:{_obj:"layer",name:n}};await se.executeCommand([s,l]);let c=e.activeLayers[0];if(se.layerEqual(a,c))throw new Error("\u521B\u5EFA\u65B0\u56FE\u5C42\u5931\u8D25");c||(c=e.layers[0]);let[d,u,f]=zl(e,c,o,r);if(d>0){let m={_obj:"transform",_target:[{_ref:"layer",_enum:"ordinal",_value:"targetEnum"}],freeTransformCenterState:{_enum:"quadCenterState",_value:"QCSCanvas"},offset:{_obj:"offset",horizontal:{_unit:"pixelsUnit",_value:u},vertical:{_unit:"pixelsUnit",_value:f}},width:{_unit:"percentUnit",_value:d},height:{_unit:"percentUnit",_value:d}};await se.executeCommand(m)}}function Kl(e,t){let n,o,r,a;switch(e){case 1:n=520,o=10,r=500,a=500;break;case 2:n=1030,o=10,r=500,a=500;break;case 3:n=520,o=520,r=500,a=500;break}return[n,o,r,a]}async function Vl(e,t,n,o,r){let a=t.length,[i,s,l,c]=Kl(o,r),d={_obj:"make",_target:[{_ref:"textLayer"}],using:{_obj:"textLayer",textKey:t,orientation:{_enum:"orientation",_value:"horizontal"},textShape:[{_obj:"textShape",char:{_enum:"char",_value:"box"},orientation:{_enum:"orientation",_value:"horizontal"},transform:{_obj:"transform",xx:1,xy:0,yx:0,yy:1,tx:i,ty:s},bounds:{top:0,left:0,bottom:l,right:c}}],textStyleRange:[{_obj:"textStyleRange",from:0,to:a,textStyle:{_obj:"textStyle",fontName:"ArialMT",size:{_unit:"pointsUnit",_value:20},color:{_obj:"RGBColor",red:255,green:255,blue:255}}}]},_options:{dialogOptions:"dontDisplay"}},u={_obj:"set",_target:[{_enum:"ordinal",_ref:"layer",_value:"targetEnum"}],to:{_obj:"layer",name:n}};await se.executeCommand([d,u])}async function Xl(e){try{un.log("\u6B63\u5728\u6E05\u9664\u5386\u53F2\u8BB0\u5F55"),await se.activateDocument(e.id);let t={_obj:"clearEvent",_target:[{_property:"historyStates",_ref:"property"},{_enum:"ordinal",_ref:"document",_value:"targetEnum"}]};await se.executeCommand(t)}catch(t){console.error(t)}}async function Yl(e){let[t,n]=Hl(e);if(Ze.app.activeDocument){let a=se.getDocumentSize(Ze.app.activeDocument);if(t===a.width&&n===a.height)return Ze.app.activeDocument}let o=await Ze.core.executeAsModal(async a=>await Ze.app.documents.add({name:"\u6279\u91CF\u751F\u56FE",width:t,height:n,resolution:72,fill:"black"}));if(!o)throw new Error("\u521B\u5EFA\u65B0\u56FE\u7247\u5931\u8D25");let r={_obj:"set",_target:[{_enum:"ordinal",_ref:"layer",_value:"targetEnum"}],to:{_obj:"layer",name:"\u80CC\u666F"}};return await se.executeCommand(r),o}er.exports={createDocumentForBatch:Yl,preparePSImageBatch:Wl,addLayerImageBatch:Gl,clearHistory:Xl,addLayerTextBatch:Vl}});var ar=T((gf,rr)=>{"use strict";var yt=N(),nr=me(),Zl=G(),Je=tr(),O=F(),V=q(),X=k(),Jl=document.getElementById("lSimpleLog"),Ql=document.getElementById("logContainer");function ec(){ht=!1,window.showSingle(Ql),V.clearLog(),console.clear(),document.dispatchEvent(new CustomEvent("disabledAllUIEvent",{detail:{disabled:!0,showInterrupt:!0}}))}function tc(){ht=!1,document.dispatchEvent(new CustomEvent("disabledAllUIEvent",{detail:{disabled:!1,showInterrupt:!1}}))}var fn=class{constructor(){}createDoc=async()=>{this.outputDoc=await Je.createDocumentForBatch(this.batchImageParams.length)};promptBatch=async(t,n,o,r,a)=>{let i=performance.now();ec();try{this.batchImageParams=a;let s=O.joinPath(o.output.folderbatch,X.BATCH_TASK_FILE_NAME),[l,c]=await O.readJsonFile(s),d=O.joinPath(o.output.folderbatch,X.BATCH_OUTPUT_FILE_NAME),[u,f]=await O.readJsonFile(d),m=await O.getEntryWithUrl(`file:${o.output.folderbatch}`),g=a.find(y=>y.batchnamed===!0);g||(g=a[0]);let w=c[g.valuefolder],p=0;for(let y=f.output.length;y<w.length;y++){if(ht)throw ht=!1,new Error("\u7528\u6237\u4E2D\u6B62\u751F\u56FE");window.config.batchPromptPreview&&!this.outputDoc&&await this.createDoc(),Jl.textContent=`${y+1}/${w.length}`;let h=w[y];V.log(`${y+1}/${w.length}`);let S=[];for(let B=0;B<a.length;B++){let P=a[B].valuefolder,ee=c[P][y];if(ee===void 0){V.warn(`\u6587\u4EF6\u5939\u4E2D\u56FE\u7247\u6570\u91CF\u4E0D\u8DB3(${X.VALID_IMAGE_EXTENSIONS.join(" ")}):${P}`);return}let ce=await O.getEntryWithUrl(O.joinPath(P,ee));S.push(ce)}await this.promptBatchOne(t,n,o,r,a,S,y,h,m,u,f),p>=2?document.dispatchEvent(new CustomEvent("wfChangeLogSimpleEvent",{detail:{}})):p+=1}let b=((performance.now()-i)/1e3).toFixed(1);V.log(`\u6279\u91CF\u6267\u884C\u5B8C\u6BD5  ${b}\u79D2`)}catch(s){V.error(s),s instanceof yt.VerifyError&&document.dispatchEvent(new CustomEvent("verifyUserEvent",{detail:{error:s}}))}finally{tc()}};promptBatchOne=async(t,n,o,r,a,i,s,l,c,d,u)=>{let f=performance.now();this.outputDoc&&await Je.preparePSImageBatch(this.outputDoc,t);for(let w=0;w<a.length;w++){let p=i[w],b=await yt.uploadImageBatch(p,p.name);V.log(b.path),a[w].value=b.path;try{this.outputDoc&&await Je.addLayerImageBatch(this.outputDoc,p,t,a.length,w)}catch(y){V.error(y,"\u5C55\u793A\u8F93\u5165\u56FE\u7247\u65F6\u51FA\u9519")}}let[m,g]=nr.extractFileNameAndExtension(l);if(o.output.kind===X.OUTPUTIMAGE){let[w,p]=await yt.prompt(t,n,o,r,window.config.showDetailLog,X.OUTPUT_NOZOOM,{width:100,height:100},null);V.log("\u6B63\u5728\u5B58\u50A8\u6587\u4EF6");let b=[];for(let P=0;P<w.length;P++){let{arrayBuffer:ee,width:ce,height:en}=w[P],st=P===0?`${m}${p}`:`${m}${P+1}${p}`,tn=await c.createFile(st,{overwrite:!0});if(await O.writeArrayBuffer(tn,ee),b.push(st),this.outputDoc)try{let Ke=await Zl.saveTempFile(ee,P===0?`cfimage${p}`:`cfimage${P+1}${p}`);V.log(`${Ke.nativePath}  ${ce}*${en}`),await Je.addLayerImageBatch(this.outputDoc,Ke,t,a.length,a.length)}catch(Ke){V.error(Ke,"\u663E\u793A\u8F93\u51FA\u56FE\u7247\u65F6\u51FA\u9519")}}u.output.push(b);let{_:y,width:h,height:S}=w[0],B=((performance.now()-f)/1e3).toFixed(1);V.log(window.config.batchPromptPause>0?`\u751F\u56FE\u6210\u529F  ${h}*${S} ${B}\u79D2   \u7761\u7720${window.config.batchPromptPause}\u79D2`:`\u6267\u884C\u6210\u529F  ${h}*${S} ${B}\u79D2`)}else if(o.output.kind===X.OUTPUTTEXT){let p=(await yt.prompt(t,n,o,r,window.config.showDetailLog,X.OUTPUT_NOZOOM,{width:100,height:100},null)).text,b=".txt";V.log(p);let y=[],h=`${m}${b}`,S=await c.createFile(h,{overwrite:!0});await O.writeTEXTFile(S,p),y.push(h),this.outputDoc&&await Je.addLayerTextBatch(this.outputDoc,p,t,a.length,a.length),u.output.push(y);let B=((performance.now()-f)/1e3).toFixed(1);V.log(window.config.batchPromptPause>0?`\u6267\u884C\u6210\u529F  ${B}\u79D2   \u7761\u7720${window.config.batchPromptPause}\u79D2`:`\u6267\u884C\u6210\u529F  ${B}\u79D2`)}else throw new Error(`\u672A\u77E5\u8F93\u51FA\u7C7B\u578B${o.output.kind}`);window.config.batchPromptPause>0&&await nr.sleep(window.config.batchPromptPause*1e3),await O.writeJsonFile(d,u),this.outputDoc&&await Je.clearHistory(this.outputDoc)}};async function nc(e){let t=O.joinPath(e,X.BATCH_TASK_FILE_NAME);if(!await O.fileExists(t))return!1;let n=O.joinPath(e,X.BATCH_OUTPUT_FILE_NAME);if(!await O.fileExists(n))return!1;let[o,r]=await O.readJsonFile(n);return r.output.length>0}async function oc(e,t,n,o){let r=O.joinPath(t.output.folderbatch,X.BATCH_TASK_FILE_NAME),a={};for(let s=0;s<o.length;s++){let l=o[s].valuefolder,c=await O.getImageFileNamesFromFolder(l,X.VALID_IMAGE_EXTENSIONS);if(c.length===0)throw new Error(`\u6587\u4EF6\u5939\u4E2D\u6CA1\u6709\u6709\u6548\u7684\u56FE\u7247(${X.VALID_IMAGE_EXTENSIONS.join(" ")}):${l}`);a[l]=c}await O.createJsonFile(r,a);let i=O.joinPath(t.output.folderbatch,X.BATCH_OUTPUT_FILE_NAME);await O.createJsonFile(i,{output:[]})}async function rc(e,t,n,o){let r=O.joinPath(t.output.folderbatch,X.BATCH_TASK_FILE_NAME),[a,i]=await O.readJsonFile(r),s=O.joinPath(t.output.folderbatch,X.BATCH_OUTPUT_FILE_NAME),[l,c]=await O.readJsonFile(s);for(let d=0;d<o.length;d++){let u=o[d].valuefolder;if(!i.hasOwnProperty(u))throw new Error(`\u7B2C${d+1}\u4E2A\u6587\u4EF6\u5939\uFF0C${u},\u8BE5\u76EE\u5F55\u5728\u4EFB\u52A1\u6587\u4EF6\u4E2D\u4E0D\u5B58\u5728\uFF0C\u8BF7\u4FEE\u6539\u5DE5\u4F5C\u6D41\u6216\u91CD\u65B0\u9009\u62E9\u7A7A\u7684\u8F93\u51FA\u6587\u4EF6\u5939`);if(d===0&&i[u].length<=c.output.length)throw new Error(`\u8F93\u5165\u76EE\u5F55${u}\u4E2D\u6709${i[u].length}\u5F20\u56FE\u7247,\u5DF2\u751F\u6210${c.output.length}\u5F20\u7ED3\u679C\u56FE\u7247.\u5F53\u524D\u4EFB\u52A1\u5DF2\u7ECF\u5B8C\u7ED3.`)}}function ac(){try{let e=document.getElementById("wfBatchPromptHelpDialog");if(e){e.showModal();return}e=document.createElement("dialog"),e.id="wfBatchPromptHelpDialog",e.style.cssText="width: 800px;height: 500px;display: flex;flex-direction: column;";let t=document.createElement("div");t.style.cssText="max-width: 100%;max-height: 100%;overflow: auto;margin: 5px;gap: 5px;display: flex;flex-direction: column;";let n=document.createElement("sp-body");n.innerHTML=`\u6279\u91CF\u751F\u56FE\uFF1A<br>
        \u53EF\u4EE5\u6307\u5B9A\u4E00\u81F3\u4E09\u4E2A\u8F93\u5165\u76EE\u5F55<br>
        \u53EF\u4EE5\u4E2D\u65AD\u540E\u7EE7\u7EED\u6267\u884C\u672A\u5B8C\u6210\u7684\u4EFB\u52A1<br>
        \u652F\u6301\u7684\u56FE\u7247\u7C7B\u578B\u5305\u62EC${X.VALID_IMAGE_EXTENSIONS.join(" ")}<br>
        \u751F\u6210\u7684\u56FE\u7247\u5C06\u4EE5\u7B2C\u4E00\u4E2A\u8F93\u5165\u6587\u4EF6\u5939\u4E2D\u7684\u56FE\u7247\u540D\u79F0\u6765\u547D\u540D<br>
        \u5F00\u59CB\u6279\u91CF\u751F\u56FE\u540E\uFF0C\u4E0D\u8981\u968F\u610F\u53D8\u66F4\u8F93\u5165\u6587\u4EF6\u5939\u53CA\u5176\u4E2D\u7684\u56FE\u7247\uFF0C\u4EE5\u514D\u53D1\u751F\u672A\u77E5\u9519\u8BEF<br>
        \u5F00\u59CB\u6279\u91CF\u751F\u56FE\u540E\uFF0C\u4E0D\u8981\u4FEE\u6539\u6216\u5220\u9664\u8F93\u51FA\u76EE\u5F55\u4E2D\u7684JSON\u6587\u4EF6\uFF0C\u4EE5\u514D\u53D1\u751F\u672A\u77E5\u9519\u8BEF<br>
        \u6279\u5904\u7406\u65F6\uFF0C\u4E0D\u4F1A\u7EA6\u675F\u56FE\u7247\u6587\u4EF6\u7684\u5927\u5C0F\uFF0C\u8BF7\u5728\u5DE5\u4F5C\u6D41\u4E2D\u8FDB\u884C\u9650\u5B9A\uFF0C\u4EE5\u514D\u7206\u663E\u5B58<br>
        `,t.appendChild(n),e.appendChild(t),document.body.appendChild(e),e.showModal()}catch(e){V.error(e)}}var or;function ic(e,t,n,o,r){or=new fn,or.promptBatch(e,t,n,o,r)}var ht=!1;async function sc(){try{ht=!0,await yt.interrupt(),V.warn("\u5C1D\u8BD5\u4E2D\u6B62\u751F\u56FE...")}catch(e){V.error(e)}}rr.exports={promptBatch:ic,hasBatchTask:nc,createBatchTask:oc,checkBatchTask:rc,showHelp:ac,interruptPrompt:sc}});var lr=T((wf,sr)=>{"use strict";var ir=k(),be,Ee,pn,Ft,jt,gn,wn,yn,mn;function lc(){pn=document.getElementById("wfMgrNodeOutputDialog"),be=document.getElementById("wfMgrNodeOutputDialogListNode"),Ee=document.getElementById("wfMgrNodeOutputDialogListField"),Ft=document.getElementById("wfMgrNodeOutputDialogOKButton"),jt=document.getElementById("wfMgrNodeOutputDialogKind"),gn=document.getElementById("wfMgrNodeOutputDialogZoomDiv"),wn=document.getElementById("wfMgrNodeOutputDialogLess"),yn=document.getElementById("wfMgrNodeOutputDialogMore"),mn=document.getElementById("wfMgrNodeOutputDialogSearch"),be.addEventListener("click",e=>{try{if(e.target.tagName==="SP-MENU-ITEM"){be.querySelectorAll("sp-menu-item").forEach(n=>n.removeAttribute("selected")),e.target.setAttribute("selected",!0);let t=e.target.getAttribute("data-nodeid");hn(t)}}catch(t){throw console.error(t),alert(t),t;return}}),Ee.addEventListener("click",e=>{e.target.tagName==="SP-MENU-ITEM"&&(Ee.querySelectorAll("sp-menu-item").forEach(t=>t.removeAttribute("selected")),e.target.setAttribute("selected",!0))}),Ee.addEventListener("dblclick",e=>{e.target.tagName==="SP-MENU-ITEM"&&Ft.dispatchEvent(new Event("click"))}),jt.addEventListener("change",e=>{let t=e.currentTarget.value;gn.style.display=t===ir.OUTPUTIMAGE?"flex":"none"}),mn.addEventListener("input",e=>{let t=mn.value;cc(t)})}function cc(e){e=e.trim().toLowerCase(),be.querySelectorAll("sp-menu-item").forEach(n=>{let o=n.getAttribute("data-nodeid")||"",r=n.getAttribute("data-nodetitle")||"",a=o.toLowerCase()===e,i=r.toLowerCase().includes(e);!e||a||i?n.style.display="":n.style.display="none"})}function hn(e=null,t=null){Ee.innerHTML="";let n=Ht[e],o=n?n.fields:{},r=!1;for(let a in o){let i=document.createElement("sp-menu-item");i.textContent=a,i.setAttribute("data-field",a),i.setAttribute("data-value",o[a]),a===t&&i.setAttribute("selected",!0),Ee.appendChild(i)}!r&&Ee.children.length===1&&Ee.children[0].setAttribute("selected",!0)}function dc(){be.innerHTML="";for(let e in Ht){let t=Ht[e],n=t.fields,o=t.nodeclass,r=t.nodetitle;if(Object.keys(n).length===0)continue;let a=document.createElement("sp-menu-item");a.textContent=`${r}(\u7F16\u53F7${e})`,a.setAttribute("data-nodeid",e),a.setAttribute("data-nodetitle",r),a.setAttribute("data-nodeclass",o),be.appendChild(a)}}var Ht=null;function uc(e,t,n,o,r,a,i){Ht=e,dc();let s=null;t&&(s=be.querySelector(`sp-menu-item[data-nodeid="${t}"]`)),t&&s?(s.setAttribute("selected",!0),hn(t,n)):(be.querySelectorAll("sp-menu-item").forEach(l=>{l.removeAttribute("selected")}),hn()),jt.querySelectorAll("sp-menu-item").forEach(l=>{l.value===o?l.setAttribute("selected",!0):l.removeAttribute("selected")}),wn.querySelectorAll("sp-menu-item").forEach(l=>{l.value===r?l.setAttribute("selected",!0):l.removeAttribute("selected")}),yn.querySelectorAll("sp-menu-item").forEach(l=>{l.value===a?l.setAttribute("selected",!0):l.removeAttribute("selected")}),gn.style.display=o===ir.OUTPUTIMAGE?"flex":"none",Ft.addEventListener("click",async function l(){try{let c=be.querySelector("sp-menu-item[selected]"),d=Ee.querySelector("sp-menu-item[selected]");if(!c||!d)return;let u=c.getAttribute("data-nodeid"),f=c.getAttribute("data-nodetitle"),m=c.getAttribute("data-nodeclass"),g=d.getAttribute("data-field"),w=jt.value,p=wn.value,b=yn.value;Ft.removeEventListener("click",l),pn.close(),await i(u,f,m,g,w,p,b)}catch(c){throw console.error(c),alert(c),c;return}}),pn.showModal()}sr.exports={initShow:lc,show:uc}});var ur=T((yf,dr)=>{"use strict";var cr=N(),Qe,vn,En;function fc(){vn=document.getElementById("wfMgrRecoverDialog"),Qe=document.getElementById("wfMgrRecoverList"),En=document.getElementById("wfMgrRecoverDialogOKButton"),Qe.addEventListener("click",e=>{try{e.target.tagName==="SP-MENU-ITEM"&&(Qe.querySelectorAll("sp-menu-item").forEach(t=>t.removeAttribute("selected")),e.target.setAttribute("selected",!0))}catch(t){throw console.error(t),alert(t),t;return}})}function mc(e){Qe.innerHTML="";for(let t=0;t<e.length;t++){let n=e[t].wfname,o=e[t].deltime,r=document.createElement("sp-menu-item");r.textContent=`${n}(${o})`,r.setAttribute("data-wfname",n),r.setAttribute("data-wfcode",e[t].wfcode||""),r.setAttribute("data-wfid",e[t].wfid),Qe.appendChild(r)}}async function pc(e,t){let n=await cr.get_workflows_recover(e);mc(n),En.addEventListener("click",async function o(){En.removeEventListener("click",o);try{let r=Qe.querySelector("sp-menu-item[selected]");if(!r)return;let a=r.getAttribute("data-wfname"),i=r.getAttribute("data-wfcode"),s=r.getAttribute("data-wfid");await cr.workflows_recover({wfname:a,wfid:s,wfcode:i}),vn.close(),t(s)}catch(r){throw console.error(r),alert(r),r;return}}),vn.showModal()}dr.exports={initShow:fc,show:pc}});var mr=T((hf,fr)=>{"use strict";var _e=null,xe=null,xn=null,zt=null,bn;function gc(){xn=document.getElementById("wfMgrNodeFieldDialog"),_e=document.getElementById("wfMgrNodeFieldDialogListNode"),xe=document.getElementById("wfMgrNodeFieldDialogListField"),zt=document.getElementById("wfMgrNodeFieldDialogOKButton"),bn=document.getElementById("wfMgrNodeFieldDialogSearch"),_e.addEventListener("click",e=>{try{if(e.target.tagName==="SP-MENU-ITEM"){_e.querySelectorAll("sp-menu-item").forEach(n=>n.removeAttribute("selected")),e.target.setAttribute("selected",!0);let t=e.target.getAttribute("data-nodeid");_n(t)}}catch(t){throw console.error(t),alert(t),t;return}}),xe.addEventListener("click",e=>{e.target.tagName==="SP-MENU-ITEM"&&(xe.querySelectorAll("sp-menu-item").forEach(t=>t.removeAttribute("selected")),e.target.setAttribute("selected",!0))}),xe.addEventListener("dblclick",e=>{e.target.tagName==="SP-MENU-ITEM"&&zt.dispatchEvent(new Event("click"))}),bn.addEventListener("input",e=>{let t=bn.value;wc(t)})}function _n(e=null,t=null){xe.innerHTML="";let n=Wt[e],o=n?n.fields:{},r=!1;for(let a in o){let i=document.createElement("sp-menu-item");i.textContent=a,i.setAttribute("data-field",a),i.setAttribute("data-value",o[a]),a===t&&i.setAttribute("selected",!0),xe.appendChild(i)}!r&&xe.children.length===1&&xe.children[0].setAttribute("selected",!0)}function wc(e){e=e.trim().toLowerCase(),_e.querySelectorAll("sp-menu-item").forEach(n=>{let o=n.getAttribute("data-nodeid")||"",r=n.getAttribute("data-nodetitle")||"",a=o.toLowerCase()===e,i=r.toLowerCase().includes(e);!e||a||i?n.style.display="":n.style.display="none"})}function yc(){_e.innerHTML="";for(let e in Wt){let t=Wt[e],n=t.fields,o=t.nodeclass,r=t.nodetitle;if(Object.keys(n).length===0)continue;let a=document.createElement("sp-menu-item");a.textContent=`${r}(\u7F16\u53F7${e})`,a.setAttribute("data-nodeid",e),a.setAttribute("data-nodetitle",r),a.setAttribute("data-nodeclass",o),_e.appendChild(a)}}var Wt=null;function hc(e,t,n,o){Wt=e,yc();let r=null;t&&(r=_e.querySelector(`sp-menu-item[data-nodeid="${t}"]`)),t&&r?(r.setAttribute("selected",!0),_n(t,n)):(_e.querySelectorAll("sp-menu-item").forEach(a=>{a.removeAttribute("selected")}),_n()),zt.addEventListener("click",async function a(){try{let i=_e.querySelector("sp-menu-item[selected]"),s=xe.querySelector("sp-menu-item[selected]");if(!i||!s)return;let l=i.getAttribute("data-nodeid"),c=i.getAttribute("data-nodetitle"),d=i.getAttribute("data-nodeclass"),u=s.getAttribute("data-field"),f=s.getAttribute("data-value");zt.removeEventListener("click",a),xn.close(),await o(l,c,d,u,f)}catch(i){throw console.error(i),alert(i),i;return}}),xn.showModal()}fr.exports={initShow:gc,show:hc}});var gr=T((Ef,pr)=>{"use strict";var vf=k();function vc(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){let t=Math.random()*16|0;return(e==="x"?t:t&3|8).toString(16)})}function Ec(e){let t={};for(let n in e){if(!e.hasOwnProperty(n))continue;let o=e[n],r=o.class_type,a=o._meta?o._meta.title:o.class_type;t[n]={nodeclass:r,nodetitle:a,fields:{}};let i=t[n].fields;for(let s in o.inputs){if(!o.inputs.hasOwnProperty(s))continue;let l=o.inputs[s];Array.isArray(l)||(i[s]=l)}}return t}function bc(e){let t={};for(let n in e){if(!e.hasOwnProperty(n))continue;let o=e[n],r=o.class_type,a=o._meta?o._meta.title:o.class_type;t[n]={nodeclass:r,nodetitle:a,fields:{}};let i=t[n].fields;for(let s in o.inputs)o.inputs.hasOwnProperty(s)&&Array.isArray(o.inputs[s])&&(i[s]="")}return t}function xc(e){return!e||typeof e!="object"?!1:Object.keys(e).every(n=>/^\d+$/.test(n))}pr.exports={isWfAPI:xc,parsenodes:Ec,generateUUID:vc,parsenodeslist:bc}});var Ce=T((Cf,yr)=>{"use strict";var bf=F(),_c=N(),xf=k(),Cc=G(),Ic=Ot(),wr=q(),_f=document.getElementById("wfParamContainer");function Ac(e,t){let n=document.createElement("sp-action-button");return n.style.justifyContent="flex-end",n.setAttribute("quiet",!0),n.textContent=e,n.setAttribute("size","s"),n.addEventListener("click",t),n}function Tc(e){let t=document.createElement("sp-label");return t.setAttribute("data-input-label",!0),t.textContent=`${e}:`,t.style.marginRight="5px",t.style.width="25%",t}function Mc(){let e=document.createElement("div");return e.style.justifyContent="space-between",e.style.display="flex",e.style.width="100%",e}function Sc(e){try{e.focus()}catch{}}async function Lc(){let e=Cc.getActiveDocument()?.id||null;if(!e)throw new Error("\u8BF7\u5148\u6253\u5F00\u56FE\u7247");let t="psimage.jpg",n=await Ic.createPSImage(e,t);wr.log(n.nativePath);let o=await _c.uploadImage(n,t);return wr.log(o.path),o.path}yr.exports={create_param_ui_button:Ac,createParamLabel:Tc,createParamToolbar:Mc,scrollToTextFieldEnd:Sc,uploadImage:Lc}});var Cn=T((Lf,vr)=>{"use strict";var If=F(),Af=N(),Tf=k(),Mf=G(),Sf=q(),Pc=Ce(),kc=document.getElementById("wfParamContainer");function Gt(e){try{let t=JSON.parse(e.extra);if(!t.yes||!t.no||t.yes===t.no)throw new Error;return t}catch{throw new Error(`${e.title}: \u9644\u52A0\u6570\u636E\u683C\u5F0F\u9519\u8BEF\uFF0C\u5FC5\u987B\u662F '{yes:value1,no:value2}'`)}}function Dc(e,t){let n=e.value,o=Gt(e),r=Pc.createParamToolbar();kc.appendChild(r),r.style.justifyContent="flex-end";let a=document.createElement("sp-checkbox");return r.appendChild(a),a.textContent=e.title,a.size="s",a.checked=n===o.yes,a.addEventListener("change",i=>{a.checked?e.value=o.yes:e.value=o.no,console.log(e.value)}),a}var hr;function Oc(e,t){let n=document.getElementById("wfMgrParamCheckboxDialog");if(!n){n=document.createElement("dialog"),n.id="wfMgrParamCheckboxDialog",n.style.cssText="width:300px;height:200px;padding:10px;display:flex;flex-direction:column;justify-content:space-between;align-items:left;text-align:left;";let r=document.createElement("div");r.style.flex="1",r.style.display="flex",r.style.flexDirection="column",r.style.gap="10px",n.appendChild(r);let a=document.createElement("sp-label");a.textContent="\u9009\u4E2D\u65F6:";let i=document.createElement("sp-textfield");i.maxlength=200,i.id="edit-yes",i.style.width="100%",r.appendChild(a),r.appendChild(i);let s=document.createElement("sp-label");s.textContent="\u53D6\u6D88\u65F6:";let l=document.createElement("sp-textfield");l.maxlength=200,l.id="edit-no",l.style.width="100%",r.appendChild(s),r.appendChild(l);let c=document.createElement("div");c.style.display="flex",c.style.justifyContent="space-between",c.style.marginTop="20px";let d=document.createElement("sp-label");d.className="lmsg",d.textContent="",d.style.color="#ff5555",d.variant="warning",c.appendChild(d);let u=document.createElement("sp-action-button");u.textContent="\u786E\u5B9A",u.addEventListener("click",()=>{try{let f={yes:n.querySelector("#edit-yes").value,no:n.querySelector("#edit-no").value},m=JSON.stringify(f);Gt({title:"",extra:m}),n.close(),hr(m)}catch(f){d.textContent=`${f}`}}),c.appendChild(u),n.appendChild(c),document.body.appendChild(n)}n.querySelector(".lmsg").textContent="";let o;try{o=Gt({title:"",extra:e})}catch{o={yes:"",no:""}}hr=t,n.querySelector("#edit-yes").value=o.yes||"",n.querySelector("#edit-no").value=o.no||"",n.showModal()}function Bc(e){let t;try{return t=Gt({title:"",extra:e}),`\u9009\u4E2D:${t.yes},\u53D6\u6D88:${t.no}`.slice(0,15)}catch{return"\u53C2\u6570\u4E0D\u6B63\u786E"}}vr.exports={createParam:Dc,showConfigDialog:Oc,getmsg:Bc}});var In=T((Uf,xr)=>{"use strict";var Pf=F(),kf=N(),Df=k(),Of=G(),Bf=q(),Er=Ce(),Uc=document.getElementById("wfParamContainer");function Kt(e){let t=0,n=100,o=1;try{({min:t,max:n,step:o}=JSON.parse(e.extra)),[t,n,o]=[t,n,o].map(Number)}catch{try{e.extra&&([t,n,o]=e.extra.split(",").map(Number))}catch{throw new Error(`\u53C2\u6570'${e.title}'\u9644\u52A0\u6570\u636E\u683C\u5F0F\u4E0D\u6B63\u786E`)}}try{if(isNaN(t)||isNaN(n)||isNaN(o))throw new Error("\u6700\u5C0F\u503C, \u6700\u5927\u503C, \u548C step \u5FC5\u987B\u662F\u6709\u6548\u7684\u6570\u5B57\u3002");if(t>=n)throw new Error("min \u5FC5\u987B\u5C0F\u4E8E max\u3002");if(o>=n)throw new Error("step \u5FC5\u987B\u5C0F\u4E8E max\u3002");return{min:t+"",max:n+"",step:o+""}}catch{throw new Error(`\u53C2\u6570'${e.title}'\u9644\u52A0\u6570\u636E\u683C\u5F0F\u4E0D\u6B63\u786E`)}}function qc(e,t){let n=e.value,o=Er.createParamToolbar();Uc.appendChild(o);let r=Er.createParamLabel(e.title);o.appendChild(r);let a=Kt(e),i=document.createElement("sp-slider");i.setAttribute("min",a.min),i.setAttribute("max",a.max),i.setAttribute("step",a.step),i.setAttribute("variant","filled"),i.setAttribute("gradient","true"),t&&i.addEventListener("change",t),i.style.padding="0px",i.style.flexGrow="1",i.value=n,o.appendChild(i);let s=document.createElement("sp-label");return s.style.justifyContent="flex-end",Number.isInteger(i.value)?s.textContent=`${i.value}`:s.textContent=`${i.value.toFixed(2)}`,s.style.padding="0px",i.addEventListener("input",l=>{Number.isInteger(i.value)?s.textContent=`${i.value}`:s.textContent=`${i.value.toFixed(2)}`}),o.appendChild(s),i}var br;function Nc(e,t){let n=document.getElementById("wfMgrParamSlierDialog");if(!n){n=document.createElement("dialog"),n.id="wfMgrParamSlierDialog",n.style.cssText="width:300px;height:250px;padding:10px;display:flex;flex-direction:column;justify-content:space-between;align-items:left;text-align:left;";let r=document.createElement("div");r.style.flex="1",r.style.display="flex",r.style.flexDirection="column",r.style.gap="10px",n.appendChild(r);let a=document.createElement("sp-label");a.textContent="\u6700\u5C0F\u503C:";let i=document.createElement("sp-textfield");i.type="number",i.id="edit-min",i.style.width="100%",r.appendChild(a),r.appendChild(i);let s=document.createElement("sp-label");s.textContent="\u6700\u5927\u503C:";let l=document.createElement("sp-textfield");l.type="number",l.id="edit-max",l.style.width="100%",r.appendChild(s),r.appendChild(l);let c=document.createElement("sp-label");c.textContent="\u523B\u5EA6:";let d=document.createElement("sp-textfield");d.type="number",d.id="edit-step",d.style.width="100%",r.appendChild(c),r.appendChild(d);let u=document.createElement("div");u.style.display="flex",u.style.justifyContent="space-between",u.style.marginTop="20px";let f=document.createElement("sp-label");f.className="lmsg",f.textContent="",f.style.color="#ff5555",f.variant="warning",u.appendChild(f);let m=document.createElement("sp-action-button");m.textContent="\u786E\u5B9A",m.addEventListener("click",()=>{try{let g=n.querySelector("#edit-max").value,w=n.querySelector("#edit-min").value,p=n.querySelector("#edit-step").value;if(isNaN(g)||isNaN(w)||isNaN(p)){f.textContent="\u8BF7\u8F93\u5165\u6709\u6548\u7684\u6570\u5B57";return}let y=JSON.stringify({max:g,min:w,step:p});Kt({title:"",extra:y}),n.close(),br(y)}catch(g){f.textContent=`${g}`,console.error(g)}}),u.appendChild(m),n.appendChild(u),document.body.appendChild(n)}n.querySelector(".lmsg").textContent="";let o;try{o=Kt({title:"",extra:e})}catch(r){alert(r),o={max:"",min:"",step:""}}br=t,n.querySelector("#edit-max").value=o.max||"",n.querySelector("#edit-min").value=o.min||"",n.querySelector("#edit-step").value=o.step||"",n.showModal()}function $c(e){let t;try{return t=Kt({title:"",extra:e}),`${t.min},${t.max},${t.step}`}catch{return"\u53C2\u6570\u4E0D\u6B63\u786E"}}xr.exports={createParam:qc,showConfigDialog:Nc,getmsg:$c}});var An=T((jf,Ar)=>{"use strict";var qf=F(),Nf=N(),$f=k(),Rf=G(),Ff=q(),_r=Ce(),Rc=document.getElementById("wfParamContainer");function Ir(e){try{return JSON.parse(e.extra)}catch{throw new Error(`${e.title}: \u9644\u52A0\u6570\u636E\u9519\u8BEF`)}}function Fc(e,t){let n=e.value,o=Ir(e),r=_r.createParamToolbar();Rc.appendChild(r),r.style.justifyContent="flex-end";let a=_r.createParamToolbar();r.appendChild(a),a.style.justifyContent="flex-end",a.size="s";for(let i in o){let s=document.createElement("sp-radio");s.size="s",s.style.marginLeft="10px",s.textContent=i,s.value=o[i],o[i]===n&&(s.checked=!0),s.addEventListener("click",l=>{a.querySelectorAll("sp-radio").forEach(c=>{c.checked=!1}),l.target.checked=!0,e.value=l.target.value}),a.appendChild(s)}return a}var Cr;function jc(e,t){let n=document.getElementById("wfMgrParamRadioDialog");if(!n){n=document.createElement("dialog"),n.id="wfMgrParamRadioDialog",n.style.cssText="width:400px;height:420px;padding:10px;display:flex;flex-direction:column;gap:10px;";let i=document.createElement("div");i.id="keyValueEditorContainer",i.style.flex="1",i.style.display="flex",i.style.flexDirection="column",i.style.gap="10px",n.appendChild(i);let s=document.createElement("sp-action-button");s.textContent="+ \u6DFB\u52A0",s.addEventListener("click",()=>{a("","")});let l=document.createElement("div");l.style.display="flex",l.style.marginBottom="5px",l.style.justifyContent="flex-end",n.appendChild(l),l.appendChild(s);let c=document.createElement("div");c.style.display="flex",c.style.justifyContent="space-between",c.style.gap="10px";let d=document.createElement("sp-label");d.className="lmsg",d.textContent="",d.style.color="#ff5555",c.appendChild(d);let u=document.createElement("sp-action-button");u.textContent="\u786E\u5B9A",u.addEventListener("click",()=>{try{let f=n.querySelectorAll(".kv-row"),m={};if(f.forEach(w=>{let p=w.querySelector(".kv-key").value.trim(),b=w.querySelector(".kv-value").value;p&&(m[p]=b)}),Object.keys(m).length===0)throw new Error("\u6CA1\u6709\u586B\u5199\u6570\u636E");let g=JSON.stringify(m);n.close(),Cr(g)}catch(f){d.textContent=`${f}`}}),c.appendChild(u),n.appendChild(c),document.body.appendChild(n)}let o=n.querySelector("#keyValueEditorContainer");o.innerHTML="",n.querySelector(".lmsg").textContent="",Cr=t;let r={};try{r=JSON.parse(e||"{}")}catch{r={}}Object.entries(r).forEach(([i,s])=>{a(i,s)}),n.showModal();function a(i="",s=""){let l=n.querySelector("#keyValueEditorContainer");if(l.children.length>=10)return;let c=document.createElement("div");c.className="kv-row",c.style.display="flex",c.style.gap="5px",c.style.alignItems="center";let d=document.createElement("sp-textfield");d.maxlength=10,d.className="kv-key",d.placeholder="\u9879\u76EE\u540D",d.value=i,d.style.flex="1";let u=document.createElement("sp-textfield");u.maxlength=20,u.className="kv-value",u.placeholder="\u503C",u.value=s,u.style.flex="1";let f=document.createElement("sp-action-button");f.textContent="\u5220\u9664",f.variant="secondary",f.addEventListener("click",()=>{c.remove()}),c.appendChild(d),c.appendChild(u),c.appendChild(f),l.appendChild(c)}}function Hc(e){let t;try{return t=Ir({title:"",extra:e}),Object.entries(t).map(([o,r])=>`${o}:${r}`).join(",").slice(0,15)}catch{return"\u53C2\u6570\u4E0D\u6B63\u786E"}}Ar.exports={createParam:Fc,showConfigDialog:jc,getmsg:Hc}});var Un=T((Hf,qr)=>{"use strict";var ye=N(),Tr=lr(),Sn=ur(),Ln=mr(),He=gr(),Mr=Cn(),Sr=In(),Lr=An(),I=k();function zc(){let e=null;for(let t in oe){let o=oe[t].nodeclass;if(o==="SaveImage"){e=t;break}else o==="PreviewImage"&&(e=t)}if(e){let t=oe[e],n=t.nodetitle,o=t.nodeclass;x.setAttribute("data-nodeid",e),x.setAttribute("data-field","images"),x.setAttribute("data-kind",I.OUTPUTIMAGE),x.setAttribute("data-lesszoom",I.OUTPUT_LESSZOOM),x.setAttribute("data-morezoom",I.OUTPUT_MOREZOOM),x.setAttribute("data-nodetitle",n),x.setAttribute("data-nodeclass",o),x.textContent=`${n}(${e})`}else x.removeAttribute("data-nodeid"),x.removeAttribute("data-field"),x.removeAttribute("data-kind"),x.removeAttribute("data-lesszoom"),x.removeAttribute("data-morezoom"),x.removeAttribute("data-nodetitle"),x.removeAttribute("data-nodeclass"),x.textContent=""}function Wc(){let e=null,t=null;for(let n in oe){let o=oe[n];for(let r in o.fields){let a=o.fields[r];if(r==="image"){e=n,t=r;break}}}if(e){let n=oe[e],o=n.nodetitle,r=n.nodeclass,a=n.fields[t];Vt(null,e,o,r,t,"\u56FE\u7247",a,I.INPUTIMAGE,"",!1)}else Vt(null,null,null,null,"","\u56FE\u7247","",I.INPUTIMAGE,"",!1)}function Gc(){Vt(null,null,null,null,"","","",null,"",!0)}function Kc(e){try{let t=x.getAttribute("data-nodeid"),n=x.getAttribute("data-field"),o=x.getAttribute("data-kind"),r=x.getAttribute("data-lesszoom"),a=x.getAttribute("data-morezoom");Tr.show(we,t,n,o,r,a,(i,s,l,c,d,u,f)=>{x.setAttribute("data-nodeid",i),x.setAttribute("data-field",c),x.setAttribute("data-kind",d),x.setAttribute("data-lesszoom",u),x.setAttribute("data-morezoom",f),x.setAttribute("data-nodetitle",s),x.setAttribute("data-nodeclass",l),x.textContent=`${s}(\u7F16\u53F7${i})`})}catch(t){throw console.error(t),alert(t),t;return}}function Vc(e){try{let t=R.getAttribute("data-extranodeid")||"",n=R.getAttribute("data-extrafield")||"";Ln.show(we,t,n,async(o,r,a,i,s)=>{R.setAttribute("data-nodeid",o),R.setAttribute("data-nodetitle",r),R.setAttribute("data-nodeclass",a),R.setAttribute("data-field",i),R.textContent=`\u8282\u70B9=${r}(${o}),   \u5B57\u6BB5=${i}`})}catch(t){throw console.error(t),alert(t),t;return}}function Xc(e){try{let t=e.currentTarget.getAttribute("data-divid"),n=document.getElementById(t),o=n.querySelector(".wfMgrNode"),r=o.getAttribute("data-nodeid"),a=o.getAttribute("data-field");Ln.show(oe,r,a,async(i,s,l,c,d)=>{o.setAttribute("data-nodeid",i),o.setAttribute("data-nodetitle",s),o.setAttribute("data-nodeclass",l),o.textContent=`\u8282\u70B9=${s}(${i}),   \u5B57\u6BB5=${c}`,o.setAttribute("data-field",c);let u=n.querySelector(".wfMgrTitle");u.value.trim()||(u.value=c);let m=n.querySelector(".wfMgrValue");m.value||(m.value=String(d));let w=n.querySelector(".wfMgrKind");if(!w.value){let[p,b]=await ye.guessFieldKind(l,c),y=n.querySelector(".wfMgrExtra");p&&(w.querySelectorAll("sp-menu-item").forEach(h=>{h.value===p?h.setAttribute("selected",!0):h.removeAttribute("selected")}),p===I.SLIDER&&et(y,I.SLIDER,b))}})}catch(t){throw console.error(t),alert(t),t;return}}function Yc(e){if(!(window.buildin&&D.wfcode))return;let t=e.querySelector('[slot="options"]');t.appendChild(document.createElement("sp-menu-divider"));function n(o){let r=document.createElement("sp-menu-item");r.setAttribute("size","s"),r.textContent=o,r.value=o,t.appendChild(r)}}function Vt(e,t,n,o,r,a,i,s,l,c,d){let u=document.createElement("div");u.id=`wfMgrDiv-${He.generateUUID()}`,u.innerHTML=kr,Ie.appendChild(u);let f=u.querySelector(".wfMgrNode");f.setAttribute("data-nodeid",t),f.setAttribute("data-field",r),f.setAttribute("data-nodetitle",n),f.setAttribute("data-nodeclass",o),f.setAttribute("data-divid",u.id),f.addEventListener("click",Xc),t&&(f.textContent=`\u8282\u70B9=${n}(${t}),   \u5B57\u6BB5=${r}`),u.querySelector(".wfMgrTitle").value=a,e&&e.named&&f.setAttribute("data-named",e.named);let m=u.querySelector(".wfMgrValue");m.value=String(i),m.setAttribute("data-valuefolder",d);let g=u.querySelector(".wfMgrKind");Yc(g),g.setAttribute("data-divid",u.id),g.querySelectorAll("sp-menu-item").forEach(b=>{b.value===s&&b.setAttribute("selected",!0)}),g.addEventListener("change",b=>{let y=b.currentTarget.value,h=b.currentTarget.getAttribute("data-divid"),S=document.getElementById(h),B=S.querySelector(".wfMgrVisible"),P=S.querySelector(".wfMgrExtra"),ee=S.querySelector(".wfMgrValue");switch(P.style.display="block",ee.style.display="block",P.parentElement.querySelector("[data-label-extra]").style.display="block",ee.parentElement.querySelector("[data-label-value]").style.display="block",y){case I.SLIDER:let ce=P.getAttribute("data-extra");ce||(r==="denoise"?ce="0,1,0.01":r==="steps"?ce="1,40,1":ce="0,100,1",et(P,I.SLIDER,ce));break;case I.SEED:B.checked=!1;break;case I.INPUTIMAGE:case I.INPUTIMAGEMASK:case I.INPUTREGIONMASK:ee.style.display="none",ee.parentElement.querySelector("[data-label-value]").style.display="none";break;case I.FIELDENUM:break;default:break}});let w=u.querySelector(".wfMgrExtra");et(w,s,l),w.addEventListener("click",b=>{Jc(w,g)}),u.querySelector(".wfMgrVisible").checked=c;let p=u.querySelector(".wfMgrDel");switch(p.addEventListener("click",Zc),p.setAttribute("data-divid",u.id),s){case I.INPUTIMAGE:case I.INPUTIMAGEMASK:case I.INPUTREGIONMASK:m.style.display="none",m.parentElement.querySelector("[data-label-value]").style.display="none";break;case I.FIELDENUM:break;default:break}u.addEventListener("contextmenu",b=>{if(b.preventDefault(),vt>=0){let y=Ie.children[vt],h=b.currentTarget;if(!y||!h)return;vt=-1,Ie.insertBefore(y,h)}else vt=Array.from(Ie.children).indexOf(b.currentTarget)})}function Zc(e){let t=e.currentTarget.getAttribute("data-divid"),n=document.getElementById(t);Ie.removeChild(n)}function Jc(e,t){try{let n=e.getAttribute("data-extra");switch(t.value){case I.SLIDER:Sr.showConfigDialog(n,o=>{et(e,I.SLIDER,o)});break;case I.SEED:break;case I.INPUTIMAGE:case I.INPUTIMAGEMASK:case I.INPUTREGIONMASK:break;case I.FIELDENUM:break;case I.CHECKBOX:Mr.showConfigDialog(n,o=>{et(e,I.CHECKBOX,o)});break;case I.RADIO:Lr.showConfigDialog(n,o=>{et(e,I.RADIO,o)});break;default:break}}catch(n){throw console.error(n),alert(n),n}}function et(e,t,n){let o=n;switch(t){case I.SLIDER:o=Sr.getmsg(n);break;case I.SEED:break;case I.INPUTIMAGE:case I.INPUTIMAGEMASK:case I.INPUTREGIONMASK:break;case I.FIELDENUM:break;case I.CHECKBOX:o=Mr.getmsg(n);break;case I.RADIO:o=Lr.getmsg(n);break;default:break}e.setAttribute("data-extra",n),e.textContent=o}async function Pr(){try{let e=await ye.get_wf_api_run();return e.result?(le=e,!0):!1}catch(e){throw console.error(e),alert(`\u8BFB\u53D6\u5DE5\u4F5C\u6D41API\u65F6\u51FA\u9519:${e}`),e}}async function Qc(){if(await Pr())try{oe=He.parsenodes(le.apidata),we=He.parsenodeslist(le.apidata),ge.disabled=!1,ze.disabled=!1,ze.value="\u65B0\u589E\u5DE5\u4F5C\u6D41",nt.disabled=!1,Ge.disabled=!1,ot.disabled=!1,x.disabled=!1,R.disabled=!1,document.getElementById("tfwfMgrPath").value=le.lasttime,Ie.innerHTML="",zc(),Wc()}catch(e){throw console.error(e),alert(e),e}}async function ed(){if(await Pr())try{oe=He.parsenodes(le.apidata),we=He.parsenodeslist(le.apidata),document.getElementById("tfwfMgrPath").value=le.lasttime}catch(e){throw console.error(e),alert(e),e;return}}function We(){try{let e=document.getElementById("wfPromptContainer"),t=document.getElementById("wfManageContainer");t.style.display="none",e.style.display="flex",Ae&&document.dispatchEvent(new CustomEvent("wfRefreshWorkflowEvent",{detail:{}}))}catch(e){throw console.error(e),alert(e),e}}async function td(e){try{await Sn.show(!1,t=>{localStorage.setItem("last_wfid",t),Ae=!0,We()})}catch(t){throw console.error(t),alert(t),t;return}}async function nd(e){try{await Sn.show(!0,t=>{localStorage.setItem("last_wfid",t),Ae=!0,We()})}catch(t){throw console.error(t),alert(t),t;return}}var Et=!1,Ae=!1,Pn,ze,ge,Ie,Fe,tt,Tn,Mn,x,je,vt=-1,nt,kn,Dn,Ge,On,R,Bn,ot,kr,le,oe,we,D={};async function Dr(){Et=!1,Ae=!1,D={},le=null,oe=null,we=null,vt=-1,await window.loadHtml("wfManageContainer","html/wfmanage.html"),Pn=document.getElementById("wfMgrTitle"),ze=document.getElementById("tfwfMgrName"),nt=document.getElementById("tfwfMgrCode"),kn=document.getElementById("divWfMgrCode"),Ge=document.getElementById("spWfMgrRel"),Dn=document.getElementById("divWfMgrRel"),ge=document.getElementById("btnWfManageSave"),Ie=document.getElementById("wfManageContainerInner"),Fe=document.getElementById("btnWfManageDel"),tt=document.getElementById("btnWfManageCopy"),Tn=document.getElementById("btnWfManageRecover"),Mn=document.getElementById("btnWfManageRecoverBuildin"),x=document.getElementById("tfwfMgrOutput"),R=document.getElementById("tfwfMgrOutExtra"),On=document.getElementById("divWfMgrOutExtra"),Bn=document.getElementById("divWfMgrGroup"),ot=document.getElementById("spWfMgrGroup"),je=document.getElementById("wfManageLog"),kr=await(await fetch("html/wfparamtempelate.html")).text(),document.getElementById("btnWfManageHelp").addEventListener("click",t=>{document.getElementById("wfManageHelpDialog").showModal()}),document.getElementById("btnWfManageReturn").addEventListener("click",async t=>{(!Et||await window.confirm("\u5DE5\u4F5C\u6D41\u5C1A\u672A\u4FDD\u5B58\uFF0C\u786E\u5B9A\u8981\u8FD4\u56DE\u5417\uFF1F"))&&We()}),Fe.addEventListener("click",rd),tt.addEventListener("click",ad),document.getElementById("tfwfMgrAddParam").addEventListener("click",Gc),x.addEventListener("click",Kc),R.addEventListener("click",Vc),Tn.addEventListener("click",td),Mn.addEventListener("click",nd),Ln.initShow(),Tr.initShow(),od()}async function od(){let e=Ge.querySelector("sp-menu"),t=await ye.get_workflows_custom(),n=await ye.get_workflows_buildin(),o=[...t,...n];o=o.filter(r=>!r.wfidrel&&(!D.wfid||r.wfid!=D.wfid));for(let r=0;r<o.length;r++){let a=document.createElement("sp-menu-item");a.textContent=o[r].wfname,a.setAttribute("value",o[r].wfid),e.appendChild(a)}}async function rd(){try{if(!D.wfname||!await confirm("\u786E\u5B9A\u8981\u5220\u9664\u5DE5\u4F5C\u6D41\u5417\uFF1F"))return;Ae=!0,await ye.save_wf_del(D),We()}catch(e){throw console.error(e),alert(e),e}finally{Fe.disabled=!1}}async function ad(){try{if(!D.wfname||!await confirm("\u786E\u5B9A\u8981\u590D\u5236\u5DE5\u4F5C\u6D41\u5417\uFF1F"))return;Ae=!0;let e=await ye.save_wf_copy(D);Et=!1,Ae=!0,localStorage.setItem("last_wfid",e),We()}catch(e){throw console.error(e),alert(e),e}finally{tt.disabled=!1}}function Or(){let e=x.getAttribute("data-nodeid"),t=x.getAttribute("data-field"),n=x.getAttribute("data-kind"),o=x.getAttribute("data-lesszoom"),r=x.getAttribute("data-morezoom"),a=x.getAttribute("data-nodetitle"),i=x.getAttribute("data-nodeclass"),s=x.getAttribute("data-folderbatch"),l=R.getAttribute("data-nodeid")||"",c=R.getAttribute("data-field")||"",d=R.getAttribute("data-nodeclass")||"",u=R.getAttribute("data-nodetitle")||"";if(!e||!t){K("\u8BF7\u5148\u8BBE\u7F6E\u7ED3\u679C\u8282\u70B9\u53CA\u5B57\u6BB5");return}if(!(e in we)){K("\u7ED3\u679C\u8282\u70B9\u4E0D\u6B63\u786E");return}if(!(t in we[e].fields)){K("\u7ED3\u679C\u5B57\u6BB5\u4E0D\u6B63\u786E");return}if(!n){K("\u7ED3\u679C\u8282\u70B9\u6CA1\u6709\u6307\u5B9A\u8F93\u51FA\u7C7B\u578B");return}if(l&&!(l in we)){K("\u9644\u52A0\u7ED3\u679C\u8282\u70B9\u4E0D\u6B63\u786E");return}if(c&&!(c in we[l].fields)){K("\u9644\u52A0\u7ED3\u679C\u5B57\u6BB5\u4E0D\u6B63\u786E");return}let f=[],m=new Set;for(let w=0;w<Ie.children.length;w++){let p=Ie.children[w],b=p.querySelector(".wfMgrTitle").value.trim(),y=p.querySelector(".wfMgrNode"),h=y.getAttribute("data-nodetitle"),S=y.getAttribute("data-nodeclass"),B=y.getAttribute("data-nodeid"),P=y.getAttribute("data-field"),ee=y.getAttribute("data-named"),ce=p.querySelector(".wfMgrValue").value,en=p.querySelector(".wfMgrValue").getAttribute("data-valuefolder"),st=p.querySelector(".wfMgrKind").value,tn=p.querySelector(".wfMgrExtra").getAttribute("data-extra"),Ke=p.querySelector(".wfMgrVisible").checked;if(!st){K(`\u7B2C${w+1}\u4E2A\u6761\u4EF6\uFF0C\u6761\u4EF6\u7C7B\u578B\u4E0D\u80FD\u4E3A\u7A7A`);return}if(!B||!P){K(`\u7B2C${w+1}\u4E2A\u6761\u4EF6\uFF0C\u8282\u70B9\u53CA\u5B57\u6BB5\u4E0D\u80FD\u4E3A\u7A7A`);return}if(!(B in oe&&P in oe[B].fields)){K(`\u7B2C${w+1}\u4E2A\u6761\u4EF6\uFF0C\u8282\u70B9\u6216\u5B57\u6BB5\u4E0D\u6B63\u786E`);return}let Ve={title:b,kind:st,nodeid:B,nodetitle:h,nodeclass:S,field:P,value:ce,extra:tn,visible:Ke,valuefolder:en};ee&&(Ve.named=ee),f.push(Ve);let Qn=`${Ve.nodeid}-${Ve.field}`;if(m.has(Qn)){K(`\u627E\u5230\u91CD\u590D: \u8282\u70B9=${Ve.nodeid}, \u5B57\u6BB5=${Ve.field}`);return}m.add(Qn)}return{params:f,output:{nodeid:e,field:t,nodetitle:a,nodeclass:i,folderbatch:s,kind:n,lesszoom:o,morezoom:r},outputextra:{nodeid:l,field:c,nodetitle:u,nodeclass:d}}}function Br(e){je.textContent=e,je.style.color="lightgreen",setTimeout(()=>{je.textContent=""},800)}function K(e){je.textContent=e,je.style.color="orange",setTimeout(()=>{je.textContent=""},2e3)}async function id(){if(!le){K("\u8BF7\u5148\u63D0\u53D6\u5DE5\u4F5C\u6D41API,\u5982\u679C\u63D0\u53D6\u4E0D\u5230\uFF0C\u8BF7\u5728COMFYUI\u4E2D\u6267\u884C\u4E00\u6B21\u540E\u518D\u8BD5\uFF01");return}let e=ze.value.trim(),t=window.buildin?nt.value.trim():"",n=Ge.value,o=ot.value||"";if(!e){K("\u5DE5\u4F5C\u6D41\u540D\u79F0\u4E0D\u80FD\u4E3A\u7A7A");return}if(t&&!o){K("\u5185\u7F6E\u5DE5\u4F5C\u6D41\u5FC5\u987B\u8BBE\u7F6E\u5206\u7EC4");return}let r=Or();if(!r)return;let a=await ye.save_wf_new_run({apidata:le.apidata,wfname:e,wfcode:t,wfidrel:n,wfgroupid:o,params:r,visible:!0});Et=!1,Ae=!0,localStorage.setItem("last_wfid",a),Br("\u5DE5\u4F5C\u6D41\u4FDD\u5B58\u6210\u529F"),We()}async function Ur(){let e=ze.value.trim(),t=window.buildin?nt.value.trim():"";if(!e){K("\u5DE5\u4F5C\u6D41\u540D\u79F0\u4E0D\u80FD\u4E3A\u7A7A");return}if(D.wfcode&&!t){K("\u5185\u7F6E\u5DE5\u4F5C\u6D41\u7684\u5DE5\u4F5C\u6D41\u7F16\u53F7\u4E0D\u80FD\u4E3A\u7A7A");return}if(!D.wfcode&&t){K("\u81EA\u5B9A\u4E49\u5DE5\u4F5C\u6D41\u4E0D\u80FD\u586B\u5199\u5DE5\u4F5C\u6D41\u7F16\u53F7");return}let n=Ge.value,o=ot.value||"",r=Or();if(r){if(D.wfcode&&!o){K("\u5185\u7F6E\u5DE5\u4F5C\u6D41\u5FC5\u987B\u8BBE\u7F6E\u5206\u7EC4");return}await ye.save_wf_edit({wfname:D.wfname,wfnamenew:e,wfcode:t,wfidrel:n,wfgroupid:o,params:r,apidata:le?le.apidata:null}),Et=!1,Ae=!0,Br("\u5DE5\u4F5C\u6D41\u4FDD\u5B58\u6210\u529F"),We()}}async function sd(){await Dr(),Pn.textContent="\u65B0\u589E\u5DE5\u4F5C\u6D41\uFF1A",Sn.initShow(),document.getElementById("btnWfManageOpenFile").addEventListener("click",Qc),ge.disabled=!0,ze.disabled=!0,nt.disabled=!0,Ge.disabled=!0,ot.disabled=!0,kn.style.display=window.buildin?"flex":"none",Dn.style.display=window.buildin?"flex":"none",x.disabled=!0,R.disabled=!0,On.style.display=window.buildin?"flex":"none",Bn.style.display=window.buildin?"flex":"none",Fe.style.display="none",tt.style.display="none",Tn.style.display="block",Mn.style.display=window.buildin?"block":"none",ge.addEventListener("click",async e=>{try{ge.disabled=!0,D.wfname?await Ur():await id()}catch(t){throw console.error(t),alert(t),t}finally{ge.disabled=!1}}),document.getElementById("btnWfManageOpenFile").dispatchEvent(new Event("click"))}async function ld(e){try{await Dr(),Pn.textContent="\u4FEE\u6539\u5DE5\u4F5C\u6D41\uFF1A",D.wfname=e.wfname,D.wfid=e.wfid,D.wfcode=e.wfcode||"",D.wfidrel=e.wfidrel,D.group=e.wfgroupid,document.getElementById("btnWfManageOpenFile").addEventListener("click",ed),!window.buildin&&D.wfcode&&(Fe.style.display="none",ge.style.display="none"),Fe.disabled=!0,ge.disabled=!0,tt.style.display="block",ge.addEventListener("click",async o=>{try{await Ur()}catch(r){throw console.error(r),alert(r),r}}),document.getElementById("tfwfMgrPath").value="";let t=await ye.get_wf_api(D.wfname,D.wfcode);oe=He.parsenodes(t),we=He.parsenodeslist(t);let n=await ye.get_wf_params(D.wfname,D.wfcode);n.output.kind||(n.output.kind=I.PROMPTMODE_COMMON),n.output.lesszoom||(n.output.lesszoom=I.OUTPUT_LESSZOOM),n.output.morezoom||(n.output.morezoom=I.OUTPUT_MOREZOOM),ze.value=D.wfname,nt.value=D.wfcode,Ge.querySelectorAll("sp-menu-item").forEach(o=>{o.value===D.wfidrel?o.setAttribute("selected",!0):o.removeAttribute("selected")}),ot.querySelectorAll("sp-menu-item").forEach(o=>{o.value===D.group?o.setAttribute("selected",!0):o.removeAttribute("selected")}),kn.style.display=window.buildin?"flex":"none",Dn.style.display=window.buildin?"flex":"none",On.style.display=window.buildin?"flex":"none",Bn.style.display=window.buildin?"flex":"none",x.setAttribute("data-nodeid",n.output.nodeid),x.setAttribute("data-field",n.output.field),x.setAttribute("data-kind",n.output.kind),x.setAttribute("data-lesszoom",n.output.lesszoom),x.setAttribute("data-morezoom",n.output.morezoom),x.setAttribute("data-nodetitle",n.output.nodetitle),x.setAttribute("data-nodeclass",n.output.nodeclass),x.setAttribute("data-folderbatch",n.output.folderbatch),x.textContent=`${n.output.nodetitle}(${n.output.nodeid})`,R.setAttribute("data-nodeid",n.outputextra?.nodeid||""),R.setAttribute("data-field",n.outputextra?.field||""),R.setAttribute("data-nodeclass",n.outputextra?.nodeclass||""),R.setAttribute("data-nodetitle",n.outputextra?.nodetitle||""),R.textContent=n.output.extranodeid?`${n.output.extranodeid}(${n.output.extrafield})`:"",n.output.kind||(n.output.kind=I.OUTPUTIMAGE);for(let o of n.params)Vt(o,o.nodeid,o.nodetitle,o.nodeclass,o.field,o.title,o.value,o.kind,o.extra,o.visible,o.valuefolder)}catch(t){throw console.error(t),alert(t),t}finally{ge.disabled=!1,Fe.disabled=!1,tt.disabled=!1}}function cd(){window.loadCSS("../css/wfmgr.css")}qr.exports={initPanel:cd,showNew:sd,showEdit:ld}});var Rr=T((zf,$r)=>{"use strict";var qn=F(),dd=N(),bt=k(),Nn=G(),ud=q(),j=Ce(),Q=document.getElementById("wfParamContainer");function Nr(){let e=document.createElement("sp-divider");e.style.marginTop="2px",e.style.marginBottom="2px",e.size="s",Q.appendChild(e)}function fd(e){let t=e.output.folderbatch,n=j.createParamLabel("\u8F93\u51FA\u76EE\u5F55"),o=j.createParamToolbar();Q.appendChild(o),o.appendChild(n);let r=document.createElement("sp-textfield");r.value=t,r.setAttribute("data-output-batchfolder",!0),r.size="s",r.style.flexGrow="1",o.appendChild(r);let a=j.create_param_ui_button("",async i=>{let s=await qn.getFolder();if(s){let l=i.target.parentElement.querySelector("sp-textfield");l.value=s.nativePath,j.scrollToTextFieldEnd(l)}});return a.innerHTML='<sp-icon name="ui:FolderBreadcrumb" size="s" slot="icon"></sp-icon>',a.style.padding="0px",o.appendChild(a),Nr(),r}function md(e){let t=e.valuefolder,n=j.createParamToolbar();Q.appendChild(n);let o=j.createParamLabel(e.title);n.appendChild(o),o.addEventListener("click",i=>{let s=i.currentTarget.parentElement.querySelector("sp-textfield");Q.querySelectorAll("[data-input-batchfolder]").forEach(c=>{c.removeAttribute("data-batch-named");let d=c.getAttribute("data-title"),u=c.parentElement.querySelector("[data-input-label]");u.textContent=`${d}:`});let l=s.getAttribute("data-title");s.setAttribute("data-batch-named",!0),i.currentTarget.textContent=`${l}(*):`});let r=document.createElement("sp-textfield");r.setAttribute("data-input-batchfolder",!0),r.value=t,r.style.flexGrow="1",n.appendChild(r),e.batchnamed&&(o.textContent=`${e.title}(*):`,r.setAttribute("data-batch-named",!0));let a=j.create_param_ui_button("",async i=>{let s=await qn.getFolder();if(s){let l=i.target.parentElement.querySelector("sp-textfield");try{l.value=s.nativePath,j.scrollToTextFieldEnd(l);let c=qn.joinPath(s.nativePath,"output"),d=Q.querySelector("[data-output-batchfolder]");(!d.value||d.value==="")&&(d.value=c)}catch(c){console.log(c)}}});return a.innerHTML='<sp-icon name="ui:FolderBreadcrumb" size="s" slot="icon"></sp-icon>',a.style.padding="0px",n.appendChild(a),r}async function pd(e,t){e.innerHTML="";let n=!1,o=await dd.get_wf_nodefield_enum(t.nodeclass,t.field);for(let r=0;r<o.length;r++){let a=document.createElement("sp-menu-item");a.textContent=o[r],o[r]===t.value&&(a.setAttribute("selected",!0),n=!0),e.appendChild(a)}!n&&o.length>0&&e.children[0].setAttribute("selected",!0)}function gd(e,t){let n=e.value,o=j.createParamLabel(e.title),r=j.createParamToolbar();Q.appendChild(r),r.appendChild(o);let a=document.createElement("sp-picker"),i=document.createElement("sp-menu");return i.setAttribute("slot","options"),a.appendChild(i),pd(i,e),a.style.flexGrow="1",t&&a.addEventListener("change",t),r.appendChild(a),a}function wd(e,t){let n=j.createParamToolbar();Q.appendChild(n);let o=e.value,r=j.createParamLabel(e.title);n.appendChild(r);let a=document.createElement("sp-textfield");return a.value=o,a.style.flexGrow="1",a.setAttribute("maxlength","100"),t&&a.addEventListener("change",t),n.appendChild(a),a}function yd(){switch(window.config.promptMode){case bt.PROMPTMODE_COMMON:return"\u751F\u6210";case bt.PROMPTMODE_BATCH:return"\u6279\u91CF\u751F\u6210";case bt.PROMPTMODE_LIVE:return"\u5B9E\u65F6\u7ED8\u753B"}}function hd(e){let t=j.createParamToolbar();Q.appendChild(t);let n=j.createParamLabel("\u654F\u9510\u5EA6(\u79D2)");t.appendChild(n);let o=window.config.livePromptSensitivity,r=0,a=5,i=.1,s=document.createElement("sp-slider");s.setAttribute("min",r),s.setAttribute("max",a),s.setAttribute("step",i),s.setAttribute("variant","filled"),s.setAttribute("gradient","true"),s.style.flexGrow="1",s.style.padding="0px",s.value=o,s.addEventListener("change",e),t.appendChild(s);let l=document.createElement("sp-label");return l.style.justifyContent="flex-end",Number.isInteger(s.value)?l.textContent=`${s.value}`:l.textContent=`${s.value.toFixed(2)}`,l.style.padding="0px",s.addEventListener("input",c=>{Number.isInteger(s.value)?l.textContent=`${s.value}`:l.textContent=`${s.value.toFixed(2)}`}),t.appendChild(l),s}function vd(){let e=j.createParamToolbar();Q.appendChild(e);let t=j.createParamLabel("\u751F\u56FE\u6682\u505C(\u79D2):");t.setAttribute("data-keep-enabled",!0),e.appendChild(t);let n=window.config.batchPromptPause,o=0,r=60,a=1,i=document.createElement("sp-slider");i.setAttribute("data-keep-enabled",!0),i.setAttribute("min",o),i.setAttribute("max",r),i.setAttribute("step",a),i.setAttribute("variant","filled"),i.setAttribute("gradient","true"),i.style.flexGrow="1",i.style.padding="0px",i.value=n,e.appendChild(i),i.style.width="60%",i.addEventListener("input",c=>{try{Number.isInteger(i.value)?s.textContent=`${i.value}`:s.textContent=`${i.value.toFixed(2)}`;let d=c.currentTarget.value;window.config.batchPromptPause=d,window.saveConfig()}catch(d){console.error(d)}});let s=document.createElement("sp-label");s.setAttribute("data-keep-enabled",!0),s.style.justifyContent="flex-end",Number.isInteger(i.value)?s.textContent=`${i.value}`:s.textContent=`${i.value.toFixed(2)}`,s.style.padding="0px",e.appendChild(s);let l=j.create_param_ui_button("",c=>{});return l.textContent=window.config.batchPromptPreview?"\u{1F50D}":"---",l.setAttribute("quiet",!0),l.setAttribute("variant","secondary"),l.setAttribute("variant","overBackground"),l.style.padding="0px",l.setAttribute("data-keep-enabled",!0),l.addEventListener("click",()=>{window.config.batchPromptPreview=!window.config.batchPromptPreview,l.textContent=window.config.batchPromptPreview?"\u{1F50D}":"---",window.saveConfig(),ud.log(window.config.batchPromptPreview?"\u5F00\u542F\u9884\u89C8":"\u5173\u95ED\u9884\u89C8")}),e.appendChild(l),i}function Ed(e,t){let n=j.createParamToolbar();Q.appendChild(n);let o=document.createElement("div");o.style.display="flex",n.appendChild(o);let r=document.createElement("div");r.style.display="flex",r.style.justifyContent="flex-end",r.style.width="50%",(window.config.promptMode!==bt.PROMPTMODE_COMMON||e.params.output.kind!==bt.OUTPUTIMAGE)&&(r.style.display="none"),n.appendChild(r);let a=document.createElement("sp-label");a.textContent="\u8F93\u51FA\u5230:",r.appendChild(a);let i=document.createElement("sp-label");i.setAttribute("data-output-image-label",!0),i.style.textAlign="right",i.addEventListener("click",d=>{i.style.display="none",s.style.display="block",$n(l,e,t),s.parentElement.offsetWidth;let u=s.value;try{u>0&&Nn.activateDocument(u)}catch(f){console.error(f)}}),r.appendChild(i);let s=document.createElement("sp-picker");s.addEventListener("blur",()=>{console.log("sp-picker lost focus")}),s.setAttribute("data-output-image",!0);let l=document.createElement("sp-menu");l.setAttribute("slot","options"),s.appendChild(l),$n(l,e,t),s.addEventListener("change",d=>{let u=d.currentTarget.value;try{u>0&&Nn.activateDocument(u)}catch(m){console.error(m)}let f=l.querySelector("[selected]");i.textContent=f?.textContent||""}),s.style.flexGrow="1",s.size="s",s.style.display="none",r.appendChild(s);let c=l.querySelector("[selected]");i.textContent=c?.textContent||""}function $n(e,t,n){e.innerHTML="";let o=Nn.getDocuments();function r(a,i,s=!1){let l=document.createElement("sp-menu-item");l.textContent=a,l.setAttribute("value",i),s&&l.setAttribute("selected",!0),e.appendChild(l)}r("\u81EA\u52A8\u5224\u65AD",-1,n<=1),r("\u65B0\u521B\u5EFA\u7684\u6587\u6863",-2,n>1),e.appendChild(document.createElement("sp-menu-divider"));for(let a=0;a<o.length;a++)r(o[a].name,o[a].id)}function bd(e){return Q.querySelector("[data-output-image]").value}function xd(e,t,n){let r=Q.querySelector("[data-output-image]").querySelector('sp-menu[slot="options"]');$n(r,t,n),r.querySelectorAll("sp-menu-item").forEach(a=>{if(a.value===e){a.setAttribute("selected",!0);let i=Q.querySelector("[data-output-image-label]");i.textContent=a.textContent||""}else a.removeAttribute("selected")})}function _d(e){let t=Q.querySelector(`[data-nodeid="${e.nodeid}"][data-field="${e.field}"]`);return t||null}$r.exports={createParamImageBatch:md,createParamOutputBatch:fd,createParamFIELDENUM:gd,createParamDefault:wd,getPromptModeLabel:yd,createParamDivider:Nr,createParamLiveSensitivity:hd,createParamBatchPause:vd,createWfTitle:Ed,getUIParamsInput:_d,getOutputDocId:bd,refreshOutputImageMenu:xd}});var Hr=T((Kf,jr)=>{"use strict";var Cd=F(),Wf=N(),Be=k(),Ue=G(),Fr=Ot(),Gf=q(),Rn=Ce(),Id=document.getElementById("wfParamContainer");function xt(e,t){e.innerHTML="";let n=Ue.getDocuments(),o=!1;for(let r=0;r<n.length;r++){let a=document.createElement("sp-menu-item");a.textContent=n[r].name,a.setAttribute("value",n[r].id),(r===0&&t===-1||n[r].id===t)&&(a.setAttribute("selected",!0),o=!0),e.appendChild(a)}!o&&e.children.length>0&&e.children[0].setAttribute("selected",!0)}function Ad(e,t){let n=t.value,o=t.title;switch(t.kind){case Be.INPUTIMAGE:break;case Be.INPUTIMAGEMASK:o=`${t.title}(\u8499\u677F)`;break;case Be.INPUTREGIONMASK:o=`${t.title}(\u5C40\u90E8)`;break}let r=Rn.createParamLabel(o),a=Rn.createParamToolbar();Id.appendChild(a),a.appendChild(r),r.addEventListener("click",f=>{let m=l.value;try{m>0&&Ue.activateDocument(m)}catch(g){console.error(g)}});let i=document.createElement("sp-label");i.setAttribute("data-input-image-label",!0),i.style.flexGrow="1",i.addEventListener("click",f=>{i.style.display="none",l.style.display="block",xt(c,t.docid),l.parentElement.offsetWidth;let m=l.value;try{m>0&&Ue.activateDocument(m)}catch(g){console.error(g)}}),a.appendChild(i);function s(f){let m=f.currentTarget.value;try{Ue.activateDocument(m)}catch(w){console.error(w)}let g=c.querySelector("[selected]");i.textContent=g?.textContent||""}let l=document.createElement("sp-picker");l.setAttribute("data-input-image",!0);let c=document.createElement("sp-menu");c.setAttribute("slot","options"),l.appendChild(c),xt(c,t.docid),l.addEventListener("change",s),l.style.flexGrow="1",l.style.display="none",a.appendChild(l);let d=c.querySelector("[selected]");i.textContent=d?.textContent||"";let u=Rn.create_param_ui_button("",async f=>{try{let m=await Cd.getImageFilePath();if(!m)return;if(window.config.promptMode===Be.PROMPTMODE_COMMON&&t.kind==Be.INPUTIMAGE&&l.value&&Ue.existsDocument(l.value))if(e.params.params.filter(w=>w.kind===Be.INPUTIMAGEMASK||w.kind===Be.INPUTIMAGE||w.kind===Be.INPUTREGIONMASK).length>1){let w=await Ue.openImageFile(m);xt(c,w)}else Td(async w=>{if(w==="new"){let p=await Ue.openImageFile(m);xt(c,p)}else if(w==="appendRight")try{await Fr.appendRight(l.value,m)}catch(p){console.error(p)}else try{await Fr.resizeInPlace(l.value,m)}catch(p){console.error(p)}});else{let g=await Ue.openImageFile(m);xt(c,g)}}catch(m){console.error(m)}});return u.innerHTML=`
    <div slot="icon" style="fill: currentColor">
    <svg viewBox="0 0 36 36" style="width: 18px; height: 18px;">
      <path d="M6 6h24v24H6V6zm2 2v16l5-5 4 4 7-7 4 4V8H8z" fill="currentColor"/>
    </svg>
  </div>`,u.style.padding="0px",a.appendChild(u),l}function Td(e){let t=document.getElementById("paramImagePlacementDialog");if(!t){t=document.createElement("dialog"),t.id="paramImagePlacementDialog",t.style.cssText="width:320px;height:auto;padding:20px;display:flex;flex-direction:column;gap:15px;justify-content:space-between;align-items:stretch;text-align:left;";let r=document.createElement("sp-label");r.textContent="\u8BF7\u9009\u62E9\u653E\u7F6E\u65B9\u5F0F:",t.appendChild(r);let a=document.createElement("div");a.style.display="flex",a.style.flexDirection="column",a.style.gap="10px";let i=[{value:"new",label:"\u521B\u5EFA\u65B0\u6587\u6863"},{value:"appendRight",label:"\u62FC\u63A5\u5230\u5F53\u524D\u6587\u6863\u53F3\u4FA7"},{value:"resizeInPlace",label:"\u7F29\u5C0F\u5E76\u653E\u7F6E\u5230\u5F53\u524D\u56FE\u50CF\u4E2D"}],s={};for(let u of i){let f=document.createElement("sp-radio");f.value=u.value,f.textContent=u.label,u.value==="new"&&(f.checked=!0),f.addEventListener("click",()=>{for(let m in s)s[m].checked=!1;f.checked=!0,t.setAttribute("data-value",f.value)}),a.appendChild(f),s[u.value]=f}t.appendChild(a);let l=document.createElement("sp-label");l.className="lmsg",l.textContent="",l.style.color="#ff5555",t.appendChild(l);let c=document.createElement("div");c.style.display="flex",c.style.justifyContent="flex-end",c.style.gap="10px";let d=document.createElement("sp-button");d.variant="primary",d.textContent="\u786E\u5B9A",c.appendChild(d),t.appendChild(c),document.body.appendChild(t)}let n=t.querySelector("sp-button"),o=n.cloneNode(!0);n.replaceWith(o),o.addEventListener("click",()=>{t.querySelector("sp-radio");let r=t.getAttribute("data-value");if(!r){lMsg.textContent="\u8BF7\u5148\u9009\u62E9\u4E00\u4E2A\u9009\u9879\u3002";return}t.close(),e(r)}),t.showModal()}jr.exports={createParamImage:Ad}});var _t=T((Xf,ea)=>{"use strict";var Md=me(),Gr=F(),Vf=k(),Kr="promptHistory.json",zr=30,Z={items:[],favitems:[]},jn=!1;async function Vr(){try{let n=await(await(await Gr.getDataFolder()).getEntry(Kr)).read(),o=JSON.parse(n);Array.isArray(o.items)?(Z.items=o.items.map(r=>typeof r=="string"?r:typeof r=="object"&&r.text?r.text:null).filter(r=>r!==null),Z.favitems=o.favitems||[]):(console.warn("Invalid history format, resetting."),Z.items=[],Z.favitems=[])}catch{Z.items=[],Z.favitems=[]}finally{jn=!0}}async function Xr(){try{await(await(await Gr.getDataFolder()).createEntry(Kr,{overwrite:!0})).write(JSON.stringify(Z,null,2))}catch(e){console.error("Error saving history:",e)}}var Wr=!1;async function Sd(e){try{if(!e||typeof e!="string"||e.length<1||(jn||await Vr(),!Wr&&!window.config.transEnable&&Md.containsChinese(e)&&(alert("\u63D0\u793A\u8BCD\u5305\u542B\u6C49\u5B57\uFF0C\u4F46\u6CA1\u6709\u5F00\u542F\u7FFB\u8BD1\u529F\u80FD\uFF0C\u53EF\u80FD\u5BFC\u81F4\u51FA\u56FE\u5F02\u5E38\u3002\u5F53\u524D\u8FD0\u884C\u4E0D\u518D\u5F39\u51FA\u672C\u63D0\u793A\u6846\uFF01"),Wr=!0),Z.items[0]===e)||Z.favitems.some(t=>t===e)||Z.items.some(t=>t===e))return;Z.items.unshift(e),Z.items.length>zr&&(Z.items=Z.items.slice(0,zr)),await Xr(),Qr(e)}catch(t){console.error(t)}}async function Yr(){return jn||await Vr(),Z}var Zr=document.getElementById("wfParamContainer");function Fn(e,t,n=!1){let o=document.createElement("sp-menu-item");o.setAttribute("size","s"),o.textContent=t.slice(0,28),o.value=t,n?e.insertBefore(o,e.firstChild):e.appendChild(o)}async function Jr(e){e.innerHTML="";let t=await Yr();e.appendChild(document.createElement("sp-menu-divider"));for(let n=0;n<t.favitems.length;n++)Fn(e,t.favitems[n]);e.appendChild(document.createElement("sp-menu-divider"));for(let n=0;n<t.items.length;n++)Fn(e,t.items[n])}async function Qr(e){try{Zr.querySelectorAll("[data-prompt-history-menu]").forEach(t=>{Fn(t,e,!0)})}catch(t){console.log(t),alert(t)}}async function Ld(){Zr.querySelectorAll("[data-prompt-history-menu]").forEach(e=>{Jr(e)})}ea.exports={addHistory:Sd,getHistory:Yr,saveHistory:Xr,addPromptHistoryMenu:Qr,refreshPromptHistoryMenu:Ld,createPromptHistoryMenus:Jr}});var oa=T((Qf,na)=>{"use strict";var Yf=me(),Zf=F(),Jf=k(),ta=_t(),Xt=!1;async function Pd(){Xt=!1;let e=document.getElementById("promptTextHistoryConfigDialg");e&&e.remove();let t=document.createElement("dialog");t.id="promptTextHistoryConfigDialg",t.style.cssText="width:600px;height:600px; padding:10px; display:flex; flex-direction:column;justify-content:space-between; align-items:left; text-align:left;";let n=await ta.getHistory(),o=document.createElement("div"),r=document.createElement("div");r.style.cssText="display:flex;align-items:center;flex-direction:row;margin-bottom:10px;height:30px";let a=document.createElement("sp-label");a.textContent="\u6536\u85CF",a.style.width="50px",a.style.paddingRight="5px",a.size="s",r.appendChild(a);let i=document.createElement("sp-label");i.style.flexGrow="1",r.appendChild(i),o.appendChild(r),o.style.cssText="display:flex;flex-direction:column;overflow-y: auto;overflow-x: auto;";function s(d,u){let f=document.createElement("div");f.style.cssText="display:flex;width:100%;align-items:center;margin-bottom:6px;";let m=document.createElement("sp-label");m.textContent=d;let g=document.createElement("sp-checkbox");g.style.paddingRight="5px",g.size="s",g.checked=u,g.addEventListener("change",w=>{g.checked?(n.items=n.items.filter(y=>y!==d),n.favitems.some(y=>y===d)||n.favitems.push(d)):(n.favitems=n.favitems.filter(y=>y!==d),n.items.some(y=>y===d)||n.items.push(d)),Xt=!0,ta.saveHistory()}),f.appendChild(g),f.appendChild(m),o.appendChild(f)}for(let d=0;d<n.items.length;d++)s(n.items[d],!1);for(let d=0;d<n.favitems.length;d++)s(n.favitems[d],!0);let l=document.createElement("div");l.style.display="flex",l.style.justifyContent="flex-end";let c=document.createElement("sp-action-button");c.textContent="\u5173\u95ED",c.style.marginTop="15px",c.addEventListener("click",()=>t.close()),l.appendChild(c),t.appendChild(o),t.appendChild(l),document.body.appendChild(t),t.addEventListener("close",()=>{Xt&&(Xt=!1,document.dispatchEvent(new CustomEvent("refreshPromptTextHistoryEvent",{detail:{}})))}),t.showModal()}na.exports={showPromptTextHistoryConfigDialg:Pd}});var Hn=T((rm,aa)=>{"use strict";var em=Ce(),tm=q(),nm=N(),om=document.getElementById("wfParamContainer"),ra;function kd(e,t,n){let o=document.getElementById("promptZhipuChatDialog");if(!o){o=document.createElement("dialog"),o.id="promptZhipuChatDialog",o.style.cssText="width:450px;height:300px; padding:10px; display:flex; flex-direction:column;justify-content:space-between; align-items:left; text-align:left;";let a=document.createElement("div");o.appendChild(a);let i=document.createElement("sp-textarea");i.style.height="180px",i.setAttribute("maxlength","2500"),a.appendChild(i),i.style.width="100%",a.appendChild(i);let s=document.createElement("div");s.style.display="flex",s.style.flexDirection="column",o.appendChild(s);let l=document.createElement("sp-label");l.style.justifyContent="center",l.style.height="25px",l.textContent=t;let c=document.createElement("div");c.style.display="flex",c.style.marginTop="15px",c.style.flexDirection="row",c.style.justifyContent="flex-end";let d=document.createElement("sp-action-button");d.textContent="\u63D0\u4EA4",d.style.height="25px",d.style.justifyContent="center",d.style.marginLeft="15px",d.addEventListener("click",()=>{let u=o.querySelector("sp-textarea");o.close(),ra(u.value)}),c.appendChild(l),c.appendChild(d),s.appendChild(c),document.body.appendChild(o)}ra=n;let r=o.querySelector("sp-textarea");r.value=e,r.focus(),o.showModal()}aa.exports={showZhipuChatDialg:kd}});var la=T((im,sa)=>{"use strict";var at=Ce(),rt=q(),Dd=N(),Od=Hn(),Bd=_t(),ia=G(),Ud=F(),am=document.getElementById("wfParamContainer");async function qd(e,t){e.innerHTML="";for(let n=0;n<t.length;n++){let o=t[n];if(o.title==="---"){e.appendChild(document.createElement("sp-menu-divider"));continue}let r=document.createElement("sp-menu-item");r.setAttribute("size","s"),r.textContent=o.title,r.value=o.value,e.appendChild(r)}}function Nd(e,t,n,o){$d(e,t,n,o),Rd(e,t,n,o)}var zn=[{title:"\u79FB\u9664",value:"\u5C06\u56FE\u50CF\u4E2D\u7684__\u5B8C\u5168\u79FB\u9664\uFF0C\u4E0D\u7559\u4EFB\u4F55\u75D5\u8FF9\u3002",prompt:"\u79FB\u9664\u56FE\u50CF\u4E2D\u7684\u6587\u5B57"},{title:"\u6DFB\u52A0",value:"\u5728__\u4E0A\u653E\u7F6E__\u7269\u4F53",prompt:"\u5728\u9676\u74F6\u4E0A\u6DFB\u52A0\u9C9C\u82B1"},{title:"\u62FF\u8D77",value:"\u8BA9\u4EBA\u7269\u7684\u624B\u4E0A\u62FF\u7740__",prompt:"\u5973\u5B69\u624B\u81C2\u4E0A\u630E\u7740\u5305"},{title:"\u66FF\u6362",value:"\u5C06__\u66FF\u6362\u4E3A__",prompt:"\u5C06\u56FE\u50CF\u4E2D\u7684\u732B\u66FF\u6362\u4E3A\u4E00\u53EA\u72D7"},{title:"\u9AD8\u6E05",value:"\u4F7F\u753B\u9762\u5185\u5BB9\u53D8\u6E05\u6670\uFF0C\u6D88\u9664\u6A21\u7CCA",prompt:"\u5C06\u56FE\u50CF\u4E2D\u7684\u6A21\u7CCA\u611F\u6D88\u9664\uFF0C\u4F7F\u753B\u9762\u5185\u5BB9\u53D8\u5F97\u6E05\u6670\u9510\u5229\u3002\u786E\u4FDD\u7EC6\u8282\u5206\u660E\uFF0C\u8F6E\u5ED3\u6E05\u6670\uFF0C\u5149\u5F71\u8FC7\u6E21\u81EA\u7136\uFF0C\u6574\u4F53\u56FE\u50CF\u8D28\u91CF\u663E\u8457\u63D0\u5347\u3002\u753B\u9762\u6E05\u6670\uFF0C\u6700\u4F73\u54C1\u8D28\uFF0C\u9AD8\u5206\u8FA8\u7387\uFF0C4K\uFF0C\u9AD8\u54C1\u8D28\uFF0C\u6770\u4F5C\uFF0C\u903C\u771F"},{title:"---",value:"",prompt:""},{title:"\u6B63\u9762",value:"\u5C06\u62CD\u6444\u89D2\u5EA6\u8C03\u6574\u4E3A\u6B63\u9762\u89C6\u89D2",prompt:"\u5C06\u56FE\u50CF\u7684\u62CD\u6444\u89D2\u5EA6\u8C03\u6574\u4E3A\u6B63\u9762\u89C6\u89D2\uFF0C\u786E\u4FDD\u4EBA\u7269\u6216\u4E3B\u4F53\u5728\u753B\u9762\u4E2D\u592E\uFF0C\u6BD4\u4F8B\u5747\u8861\u3002\u80CC\u666F\u6E05\u6670\uFF0C\u5149\u5F71\u81EA\u7136\uFF0C\u7A81\u51FA\u4E3B\u4F53\u7279\u5F81\u3002\u753B\u9762\u5448\u73B0\u7535\u5F71\u611F\uFF0C\u7EC6\u8282\u4E30\u5BCC\uFF0C\u8D28\u91CF\u4E0A\u4E58\uFF0C\u9AD8\u5206\u8FA8\u7387\uFF0C4K\uFF0C\u6700\u4F73\u54C1\u8D28\uFF0C\u903C\u771F"},{title:"\u4FA7\u9762",value:"\u5C06\u62CD\u6444\u89D2\u5EA6\u8C03\u6574\u4E3A\u4FA7\u9762\u89C6\u89D2",prompt:"\u5C06\u56FE\u50CF\u7684\u62CD\u6444\u89D2\u5EA6\u8C03\u6574\u4E3A\u4FA7\u9762\u89C6\u89D2"},{title:"\u80CC\u9762",value:"\u5C06\u62CD\u6444\u89D2\u5EA6\u8C03\u6574\u4E3A\u80CC\u9762\u89C6\u89D2",prompt:"\u5C06\u56FE\u50CF\u7684\u62CD\u6444\u89D2\u5EA6\u8C03\u6574\u4E3A\u80CC\u9762\u89C6\u89D2"},{title:"\u4FEF\u89C6",value:"\u5C06\u62CD\u6444\u89D2\u5EA6\u8C03\u6574\u4E3A\u4FEF\u89C6\u89C6\u89D2",prompt:""},{title:"\u503E\u659C",value:"\u5C06\u62CD\u6444\u89D2\u5EA6\u8C03\u6574\u4E3A\u503E\u659C\u89C6\u89D2",prompt:""},{title:"\u8FDC\u666F",value:"\u5C06\u955C\u5934\u62C9\u8FDC",prompt:"\u5C06\u955C\u5934\u62C9\u8FDC"},{title:"\u8FD1\u666F",value:"\u5C06\u955C\u5934\u79FB\u8FD1",prompt:"\u5C06\u955C\u5934\u79FB\u8FD1"},{title:"---",value:""},{title:"\u771F\u5B9E\u7167\u7247",value:"\u5C06\u56FE\u7247\u98CE\u683C\u8F6C\u6362\u6210\u771F\u5B9E\u7167\u7247\u98CE\u683C",prompt:"\u5C06\u56FE\u7247\u98CE\u683C\u8F6C\u6362\u6210\u771F\u5B9E\u7167\u7247\u98CE\u683C\u3002\u786E\u4FDD\u8F6C\u6362\u540E\u7684\u56FE\u50CF\u5177\u6709\u903C\u771F\u7684\u5149\u5F71\u6548\u679C\u3001\u7EC6\u817B\u7684\u7EB9\u7406\u548C\u81EA\u7136\u7684\u8272\u5F69\uFF0C\u6574\u4F53\u753B\u9762\u5E94\u5C55\u73B0\u51FA\u9AD8\u6E05\u3001\u6E05\u6670\u7684\u89C6\u89C9\u6548\u679C\uFF0C\u8D28\u91CF\u4E0A\u4E58\uFF0C\u9AD8\u5206\u8FA8\u7387\uFF0C4K\uFF0C\u9AD8\u54C1\u8D28\uFF0C\u6770\u4F5C\uFF0C\u903C\u771F"},{title:"3D\u5361\u901A",value:"\u5C06\u56FE\u7247\u98CE\u683C\u8F6C\u6362\u62103D\u5361\u901A\u98CE\u683C",prompt:"\u5C06\u56FE\u7247\u98CE\u683C\u8F6C\u6362\u62103D\u5361\u901A\u98CE\u683C"},{title:"\u5BAB\u5D0E\u9A8F\u52A8\u6F2B",value:"\u5C06\u56FE\u7247\u98CE\u683C\u8F6C\u6362\u6210\u5BAB\u5D0E\u9A8F\u52A8\u6F2B\u98CE\u683C",prompt:"\u5C06\u56FE\u7247\u98CE\u683C\u8F6C\u6362\u6210\u5BAB\u5D0E\u9A8F\u52A8\u6F2B\u98CE\u683C"},{title:"\u8D5B\u535A\u670B\u514B",value:"\u5C06\u56FE\u7247\u98CE\u683C\u8F6C\u6362\u6210\u8D5B\u535A\u670B\u514B\u98CE\u683C",prompt:"\u5C06\u56FE\u7247\u98CE\u683C\u8F6C\u6362\u6210\u8D5B\u535A\u670B\u514B\u98CE\u683C"},{title:"\u94C5\u7B14\u753B",value:" \u5C06\u56FE\u7247\u98CE\u683C\u8F6C\u6362\u6210\u7A00\u758F\u7B80\u7EC3\u7684\u9ED1\u767D\u94C5\u7B14\u753B",prompt:"\u5C06\u56FE\u7247\u98CE\u683C\u8F6C\u6362\u6210\u7A00\u758F\u7B80\u7EC3\u7684\u9ED1\u767D\u94C5\u7B14\u753B"},{title:"---",value:""},{title:"\u751F\u6210\u6A21\u7279",value:"\u4E3A\u670D\u88C5\u751F\u6210\u6A21\u7279",prompt:"\u5C06\u670D\u88C5\u5C55\u793A\u5728\u6A21\u7279\u8EAB\u4E0A\uFF0C\u786E\u4FDD\u670D\u88C5\u4E0E\u6A21\u7279\u8EAB\u6750\u6BD4\u4F8B\u534F\u8C03\uFF0C\u6750\u8D28\u7EC6\u8282\u6E05\u6670\u53EF\u89C1\uFF0C\u5982\u4E1D\u7EF8\u7684\u5149\u6CFD\u6216\u68C9\u5E03\u7684\u8936\u76B1\u3002\u6A21\u7279\u59FF\u6001\u4F18\u96C5\uFF0C\u80CC\u666F\u4E3A\u7B80\u6D01\u7684\u767D\u8272\u6216\u6D45\u8272\u8C03\uFF0C\u4EE5\u7A81\u51FA\u670D\u88C5\u8BBE\u8BA1\u3002\u6574\u4F53\u753B\u9762\u8272\u5F69\u67D4\u548C\uFF0C\u8425\u9020\u6E05\u65B0\u81EA\u7136\u7684\u6C1B\u56F4\uFF0C\u98CE\u683C\u4E3A\u65F6\u5C1A\u6444\u5F71\uFF0C\u6700\u4F73\u54C1\u8D28\uFF0C\u9AD8\u5206\u8FA8\u7387\uFF0C4K\uFF0C\u9AD8\u54C1\u8D28\uFF0C\u6770\u4F5C\uFF0C\u903C\u771F"},{title:"\u4EBA\u7269\u7F8E\u989C",value:"\u4E3A\u4EBA\u7269\u7F8E\u989C",prompt:"\u4E3A\u56FE\u50CF\u4E2D\u7684\u4EBA\u7269\u8FDB\u884C\u7F8E\u989C\u5904\u7406\u3002\u63D0\u5347\u4EBA\u7269\u7684\u76AE\u80A4\u8D28\u611F\uFF0C\u4F7F\u5176\u5E73\u6ED1\u7EC6\u817B\uFF0C\u65E0\u7455\u75B5\u3002\u8C03\u6574\u4E94\u5B98\u6BD4\u4F8B\uFF0C\u4F7F\u5176\u66F4\u52A0\u7ACB\u4F53\u548C\u8C10\u3002\u589E\u52A0\u773C\u795E\u7684\u4EAE\u5EA6\u4E0E\u795E\u91C7\uFF0C\u4F7F\u4EBA\u7269\u770B\u8D77\u6765\u66F4\u52A0\u751F\u52A8\u6709\u9B45\u529B\u3002\u6574\u4F53\u753B\u9762\u5E94\u5448\u73B0\u51FA\u81EA\u7136\u4E14\u9AD8\u8D28\u91CF\u7684\u7F8E\u989C\u6548\u679C\uFF0C\u6700\u4F73\u54C1\u8D28\uFF0C\u9AD8\u5206\u8FA8\u7387\uFF0C4K\uFF0C\u9AD8\u54C1\u8D28\uFF0C\u6770\u4F5C\uFF0C\u903C\u771F"},{title:"\u968F\u673A\u4F20\u9001",value:"\u5C06\u4E3B\u4F53\u4F20\u9001\u5230\u4E00\u4E2A\u968F\u673A\u7684\u4F4D\u7F6E\u3001\u573A\u666F\u3001\u98CE\u683C\u4E2D\u3002\u4F46\u4E0D\u8981\u6307\u793A\u66FF\u6362\u6216\u6539\u53D8\u4E3B\u4F53\uFF0C\u4EC5\u6539\u53D8\u573A\u666F\u3001\u98CE\u683C\u3001\u670D\u88C5\u3001\u914D\u9970\u3001\u80CC\u666F\u7B49\u3002\u4FDD\u6301\u4EBA\u7269\u9762\u90E8\u7279\u5F81\u548C\u670D\u9970\u4E0D\u53D8",prompt:"\u5C06\u4E3B\u4F53\u4F20\u9001\u5230\u4E00\u4E2A\u795E\u79D8\u7684\u68EE\u6797\u573A\u666F\u4E2D\uFF0C\u5468\u56F4\u73AF\u7ED5\u7740\u53E4\u8001\u7684\u6811\u6728\u548C\u8FF7\u96FE\uFF0C\u98CE\u683C\u8BBE\u5B9A\u4E3A\u6D6A\u6F2B\u63D2\u753B\u98CE\uFF0C\u8272\u5F69\u4EE5\u6DF1\u7EFF\u548C\u7D2B\u8272\u4E3A\u4E3B\uFF0C\u5149\u7EBF\u900F\u8FC7\u6811\u53F6\u6D12\u4E0B\u6591\u9A73\u7684\u5149\u5F71\uFF0C\u80CC\u666F\u4E2D\u9690\u7EA6\u53EF\u89C1\u53D1\u5149\u7684\u8611\u83C7\u548C\u85E4\u8513\u3002\u753B\u9762\u5145\u6EE1\u795E\u79D8\u4E0E\u6D6A\u6F2B\u6C14\u606F\uFF0C\u4FDD\u6301\u4EBA\u7269\u9762\u90E8\u7279\u5F81\u548C\u670D\u9970\u4E0D\u53D8"},{title:"\u91CD\u65B0\u6253\u5149",value:"\u4E3A\u56FE\u50CF\u5EFA\u8BAE\u65B0\u7684\u6253\u5149\u8BBE\u7F6E\uFF0C\u91CD\u70B9\u5728\u4E8E\u4E13\u4E1A\u7684\u5F71\u68DA\u7167\u660E\u3002",prompt:"\u4E3A\u56FE\u50CF\u8BBE\u7F6E\u4E13\u4E1A\u7684\u5F71\u68DA\u7167\u660E\uFF0C\u786E\u4FDD\u5149\u7EBF\u5747\u5300\u4E14\u5177\u6709\u65B9\u5411\u6027\uFF0C\u4EA7\u751F\u6E05\u6670\u7684\u8F6E\u5ED3\u548C\u9AD8\u5149\u4E0E\u9634\u5F71\u5BF9\u6BD4\u3002\u7167\u660E\u5E94\u7CBE\u51C6\u5730\u7A81\u51FA\u4E3B\u4F53\uFF0C\u540C\u65F6\u4FDD\u6301\u80CC\u666F\u7684\u81EA\u7136\u8FC7\u6E21\u3002\u5149\u5F71\u6548\u679C\u9700\u7EC6\u817B\u903C\u771F\uFF0C\u8272\u5F69\u9971\u548C\u5EA6\u9002\u4E2D\uFF0C\u6574\u4F53\u6C1B\u56F4\u4E13\u4E1A\u4E14\u5BCC\u6709\u5C42\u6B21\u611F\u3002\u753B\u9762\u6E05\u6670\uFF0C\u6700\u4F73\u54C1\u8D28\uFF0C\u9AD8\u5206\u8FA8\u7387\uFF0C4K\uFF0C\u9AD8\u54C1\u8D28\uFF0C\u6770\u4F5C\uFF0C\u903C\u771F"},{title:"\u4EA7\u54C1\u5C55\u793A",value:"\u5C06\u56FE\u50CF\u8F6C\u6362\u4E3A\u4E13\u4E1A\u4EA7\u54C1\u7167\u7247\u7684\u98CE\u683C\uFF0C\u5C06\u4EA7\u54C1\u653E\u7F6E\u5728\u4E00\u4E2A\u9AD8\u7AEF\u7684\u5177\u4F53\u7684\u80CC\u666F\u4E2D\uFF0C\u8981\u63CF\u8FF0\u6E05\u695A\u4EA7\u54C1\u6240\u5904\u7684\u80CC\u666F\u53CA\u73AF\u5883\u3002",prompt:"\u5C06\u56FE\u50CF\u8F6C\u6362\u4E3A\u4E13\u4E1A\u4EA7\u54C1\u7167\u7247\u7684\u98CE\u683C\uFF0C\u5C06\u4EA7\u54C1\u653E\u7F6E\u5728\u4E00\u4E2A\u9AD8\u7AEF\u7684\u3001\u5145\u6EE1\u73B0\u4EE3\u611F\u7684\u73BB\u7483\u5C55\u793A\u67DC\u4E2D\uFF0C\u80CC\u666F\u4E3A\u7B80\u6D01\u7684\u767D\u8272\u8C03\uFF0C\u4EA7\u54C1\u5468\u56F4\u6709\u67D4\u548C\u7684\u73AF\u5F62\u805A\u5149\u706F\u7167\u5C04\uFF0C\u7A81\u51FA\u4EA7\u54C1\u8D28\u611F\u4E0E\u7EC6\u8282\u3002\u786E\u4FDD\u4EA7\u54C1\u4E0E\u80CC\u666F\u5B8C\u7F8E\u878D\u5408\uFF0C\u73AF\u5883\u663E\u5F97\u7CBE\u81F4\u800C\u5BCC\u6709\u5C42\u6B21\u3002\u753B\u9762\u6E05\u6670\uFF0C\u8D28\u91CF\u4E0A\u4E58\uFF0C\u6700\u4F73\u54C1\u8D28\uFF0C\u9AD8\u5206\u8FA8\u7387\uFF0C4K\uFF0C\u9AD8\u54C1\u8D28\uFF0C\u6770\u4F5C\uFF0C\u903C\u771F"},{title:"\u6269\u56FE",value:"\u5C06\u56FE\u7247\u4E2D\u7684\u767D\u8272\u533A\u57DF\u66FF\u6362\u4E3A\u80CC\u666F\u6216\u524D\u666F",tip:'\u4F7F\u7528"\u56FE\u50CF"--"\u753B\u5E03\u5927\u5C0F"\u529F\u80FD\u6269\u5927\u56FE\u7247\u540E\uFF0C\u518D\u751F\u6210\u56FE\u7247',prompt:"\u5C06\u56FE\u7247\u4E2D\u7684\u767D\u8272\u533A\u57DF\u66FF\u6362\u4E3A\u80CC\u666F\u6216\u524D\u666F"}];function $d(e,t,n,o){let r=at.createParamLabel("Kontext\u63D0\u793A\u8BCD\u6A21\u677F");r.style.width="35%";let a=at.createParamToolbar();n.appendChild(a),a.appendChild(r);let i=at.createParamToolbar();i.style.justifyContent="flex-end",i.style.display="flex",i.style.width="100%",i.style.flexGrow="1",a.appendChild(i);let s=document.createElement("sp-picker");s.setAttribute("size","s");let l=document.createElement("sp-menu");l.setAttribute("slot","options"),s.appendChild(l),qd(l,zn),s.addEventListener("change",c=>{let d=s.value;if(!d)return;let u=l.querySelector("[selected]");if(u&&u.removeAttribute("selected"),!window.config.ZhipuAPIKey){alert("\u8BF7\u70B9\u51FB\u7A97\u53E3\u5DE6\u4E0A\u89D2\u7684\u8BBE\u7F6E\u6309\u94AE\uFF0C\u7533\u8BF7\u5E76\u586B\u5199\u667A\u8C31API-Key");return}if(!ia.getActiveDocument()){rt.error("\u8BF7\u5148\u6253\u5F00\u56FE\u7247");return}Od.showZhipuChatDialg(d,"\u5C06\u56FE\u7247\u53CA\u6587\u672C\u53D1\u7ED9\u667A\u8C31AI\u6765\u5B8C\u5584\u63D0\u793A\u8BCD:",async f=>{try{rt.log("\u670D\u52A1\u7AEF\u6B63\u5728\u751F\u6210\u63D0\u793A\u8BCD\uFF0C\u8BF7\u7A0D\u7B49...");let m=window.config.ZhipuAPIKey,g="glm-4-flash-250414";document.dispatchEvent(new CustomEvent("disabledAllUIEvent",{detail:{disabled:!0,showInterrupt:!1}}));let w=await at.uploadImage(),{text:p,price:b,success:y}=await Dd.cloud_zhipu_kontext({api:m,model_name:g,user_prompt:f,image_url:w});y?(o.value=p,Bd.addHistory(p)):rt.error(p),rt.log("")}catch(m){rt.error(m),alert(m)}finally{document.dispatchEvent(new CustomEvent("disabledAllUIEvent",{detail:{disabled:!1,showInterrupt:!1}}))}})}),i.appendChild(s)}function Rd(e,t,n,o){let r=at.createParamToolbar();n.appendChild(r);let a=document.createElement("div");a.style.justifyContent="flex-end",a.style.width="100%",a.style.display="flex",r.appendChild(a);let i=at.create_param_ui_button("Kontext\u6837\u4F8B",async s=>{try{await jd(o)}catch(l){console.error(l),alert(l)}});i.style.margin="0px",i.style.padding="0px",a.appendChild(i)}async function Fd(e,t){document.getElementById("kontextSampleDialogOKButton").addEventListener("click",async()=>{try{let l=o.querySelector("sp-menu-item[selected]");if(!l)return;let c=l.value;if(!c)return;let d=l.getAttribute("data-prompt");if(!d)return;t.value=d;let u=await Ud.getPluginFile(`images/kontext/${c}_input.jpg`);console.log(u.nativePath),await ia.openImageFile(u),e.close()}catch(l){rt.error(l),alert(l)}});let o=document.getElementById("kontextSampleDialogList"),r=document.getElementById("kontextSampleDialogPrompt"),a=document.getElementById("kontextSampleDialogInput"),i=document.getElementById("kontextSampleDialogOutput");o.innerHTML="";for(let l=0;l<zn.length;l++){let c=zn[l];if(c.title==="---"){o.appendChild(document.createElement("sp-menu-divider"));continue}if(!c.prompt)continue;let d=document.createElement("sp-menu-item");d.setAttribute("size","s"),d.textContent=c.title,d.value=c.title,d.setAttribute("data-prompt",c.prompt),l===0&&d.setAttribute("selected",!0),o.appendChild(d)}function s(l){let c=l.value;if(!c)return;let d=l.getAttribute("data-prompt");d&&(r.value=d,a.src=`images/kontext/${c}_input.jpg`,i.src=`images/kontext/${c}_output.jpg`)}o.addEventListener("change",l=>{let c=o.querySelector(`sp-menu-item[value="${o.value}"]`);c&&s(c)}),s(o.querySelector("sp-menu-item[selected]"))}async function jd(e){let t=document.getElementById("kontextSampleDialog");if(!t){let n=`
<dialog id="kontextSampleDialog" style="width:1200px;height:600px;padding:5px;display:flex;flex-direction:column;gap:5px;box-sizing:border-box;">
  <!-- \u4E3B\u4F53\u5185\u5BB9 -->
  <div style="flex:1; display:flex; flex-direction:row; gap:5px; overflow:hidden;">
    
    <!-- \u5DE6\u4FA7\u83DC\u5355\u533A\u57DF -->
    <div style="width:150px; overflow-y:auto; border-right:1px solid #ccc; padding-right:5px; box-sizing:border-box;">
      <sp-menu id="kontextSampleDialogList" style="width:100%;gap:0px; " size="s"></sp-menu>
    </div>

    <!-- \u53F3\u4FA7\u5185\u5BB9\u533A\u57DF -->
    <div style="flex:1; display:flex; flex-direction:column; gap:5px; overflow:hidden;">
      
      <!-- \u63D0\u793A\u8BCD\u533A\u57DF -->
      <sp-textarea id="kontextSampleDialogPrompt" size="s" quiet style="width:100%; height:80px;">\u8FD9\u91CC\u663E\u793A\u63D0\u793A\u8BCD</sp-textarea>

      <!-- \u56FE\u7247\u5BF9\u6BD4\u533A\u57DF -->
    <div style="flex:1; display:flex; gap:20px; justify-content: space-between;">
      <div style="flex:1; display:flex; flex-direction:column; align-items:center; gap:0px;">
        <sp-label size="s" quiet>\u539F\u56FE\uFF1A</sp-label>
        <div style="width:500px; height:500px;  display:flex; align-items:center; justify-content:center;">
          <img id="kontextSampleDialogInput" src="" alt="\u539F\u56FE" style="max-width:100%; max-height:100%; object-fit:contain;">
        </div>
      </div>
      <div style="flex:1; display:flex; flex-direction:column; align-items:center; gap:0px; margin-left:3px;">
        <sp-label size="s" quiet>\u7ED3\u679C\u56FE\uFF1A</sp-label>
        <div style="width:500px; height:500px;  display:flex; align-items:center; justify-content:center;">
          <img id="kontextSampleDialogOutput" src="" alt="\u7ED3\u679C\u56FE" style="max-width:100%; max-height:100%; object-fit:contain;">
        </div>
      </div>
    </div>

    </div>
  </div>

  <!-- \u5E95\u90E8\u6309\u94AE\u533A\u57DF -->
  <div class="dialog-footer" style="text-align:right;">
    <sp-action-button id="kontextSampleDialogOKButton">\u52A0\u8F7D</sp-action-button>
  </div>
</dialog>

      `,o=document.createElement("div");o.innerHTML=n,document.body.appendChild(o.firstElementChild),t=document.getElementById("kontextSampleDialog"),await Fd(t,e)}t.showModal()}sa.exports={createParamPromptTextTopKontextChange:Nd}});var fa=T((sm,ua)=>{"use strict";var Hd=me(),da=k(),Ct=N(),Te=q(),qe=Ce(),zd=G(),Wd=oa(),Wn=_t(),Gd=la(),Kd=Hn(),Vd=document.getElementById("wfParamContainer"),ca={};function Xd(e,t,n){let o=document.createElement("div");o.style.flexDirection="column",o.style.display="flex",Vd.appendChild(o);let r=document.createElement("sp-textarea");r.style.height=160,r.style.overflow="auto",r.setAttribute("grows",!0),r.setAttribute("size","l"),r.setAttribute("maxlength","1500"),r.id=`wfInputText-${Hd.generateUUID()}`,r.style.width="100%";let a=`${e.wfid}${t.nodeid}${t.field}`;switch(r.value=ca[a]||t.value,r.addEventListener("change",i=>{ca[a]=i.target.value}),n&&r.addEventListener("change",n),Yd(e,t,o,r),t.extra){case da.EXTRA_BUILDIN_KONTEXT_CHANGE:Gd.createParamPromptTextTopKontextChange(e,t,o,r);break}return o.appendChild(r),Zd(e,t,o,r),r}function Yd(e,t,n,o){let r=qe.createParamLabel(t.title),a=document.createElement("div");a.style.justifyContent="space-between",a.style.display="flex",a.appendChild(r),n.appendChild(a),a.setAttribute("data-prompt-history",!0);let i=document.createElement("div");i.style.flexGrow="1",i.style.justifyContent="flex-end",i.style.display="flex",a.appendChild(i);let s=document.createElement("sp-label");s.style.textAlign="right",s.textContent="\u70B9\u51FB\u67E5\u770B\u5386\u53F2\u8BB0\u5F55",i.appendChild(s),s.addEventListener("click",d=>{s.style.display="none",Wn.createPromptHistoryMenus(c),l.style.display="block"});let l=document.createElement("sp-picker");l.style.width="100%",l.setAttribute("size","s"),l.style.display="none";let c=document.createElement("sp-menu");c.setAttribute("data-prompt-history-menu",!0),c.setAttribute("slot","options"),l.appendChild(c),l.addEventListener("change",d=>{if(c.value){o.value=c.value;let u=c.querySelector("[selected]");u&&u.removeAttribute("selected")}}),i.appendChild(l),r.addEventListener("click",d=>{Wd.showPromptTextHistoryConfigDialg()})}function Zd(e,t,n,o){let r=qe.createParamToolbar();n.appendChild(r),r.style.justifyContent="flex-end";let a=document.createElement("div");a.style.justifyContent="flex-end",a.style.display="flex",r.appendChild(a);let i=qe.create_param_ui_button("\u4E2D",async u=>{try{let f=o.value.trim();if(!f)return;let m=await Ct.translateToZH(f);o.value=m}catch(f){throw console.error(f),alert(`\u7FFB\u8BD1\u65F6\u51FA\u9519${f}`),f}});i.setAttribute("data-trans-button",!0),a.appendChild(i),i.style.padding="0px",i.style.width="50px";let s=qe.create_param_ui_button("\u82F1",async u=>{try{let f=o.value.trim();if(!f)return;let m=await Ct.translateToEN(f);o.value=m}catch(f){throw console.error(f),alert(`\u7FFB\u8BD1\u65F6\u51FA\u9519${f}`),f}});s.setAttribute("data-trans-button",!0),s.style.padding="0px",s.style.width="50px",a.appendChild(s);let l=qe.create_param_ui_button("\u53CD\u63A8",async u=>{if(!window.config.ZhipuAPIKey){alert("\u8BF7\u70B9\u51FB\u7A97\u53E3\u5DE6\u4E0A\u89D2\u7684\u8BBE\u7F6E\u6309\u94AE\uFF0C\u7533\u8BF7\u5E76\u586B\u5199\u667A\u8C31AI\u7684API-Key");return}if(!zd.getActiveDocument()){Te.error("\u8BF7\u5148\u6253\u5F00\u56FE\u7247");return}try{Te.log("\u670D\u52A1\u7AEF\u6B63\u5728\u53CD\u63A8\u56FE\u7247\uFF0C\u8BF7\u7A0D\u7B49...");let f=window.config.ZhipuAPIKey,m="glm-4v-flash";document.dispatchEvent(new CustomEvent("disabledAllUIEvent",{detail:{disabled:!0,showInterrupt:!1}}));let g=await qe.uploadImage(),{text:w,price:p,success:b}=await Ct.cloud_zhipu_vision({api:f,model_name:m,image_url:g});b?(o.value=w,Wn.addHistory(w)):Te.error(w),Te.log("")}catch(f){Te.error(f),alert(f)}finally{document.dispatchEvent(new CustomEvent("disabledAllUIEvent",{detail:{disabled:!1,showInterrupt:!1}}))}});l.style.padding="0px",l.style.width="50px",a.appendChild(l);let c=qe.create_param_ui_button("\u6269\u5199",async u=>{let f=o.value;if(f){if(!window.config.ZhipuAPIKey){alert("\u8BF7\u70B9\u51FB\u7A97\u53E3\u5DE6\u4E0A\u89D2\u7684\u8BBE\u7F6E\u6309\u94AE\uFF0C\u7533\u8BF7\u5E76\u586B\u5199\u667A\u8C31AI\u7684API-Key");return}Kd.showZhipuChatDialg(`\u8BF7\u6269\u5199\u5173\u4E8E"${f}"\u7684\u56FE\u50CF\u751F\u6210\u63D0\u793A\u8BCD\u3002`,"\u5C06\u6587\u672C\u53D1\u7ED9\u667A\u8C31AI\u6765\u5B8C\u5584\u63D0\u793A\u8BCD:",async m=>{try{Te.log("\u670D\u52A1\u7AEF\u6B63\u5728\u751F\u6210\u63D0\u793A\u8BCD\uFF0C\u8BF7\u7A0D\u7B49...");let g=window.config.ZhipuAPIKey,w="glm-4-flash-250414";document.dispatchEvent(new CustomEvent("disabledAllUIEvent",{detail:{disabled:!0,showInterrupt:!1}}));let{text:p,price:b,success:y}=await Ct.cloud_zhipu_chat({api:g,model_name:w,user_prompt:m});y?(o.value=p,Wn.addHistory(p)):Te.error(p),Te.log("")}catch(g){Te.error(g),alert(g)}finally{document.dispatchEvent(new CustomEvent("disabledAllUIEvent",{detail:{disabled:!1,showInterrupt:!1}}))}})}});c.style.padding="0px",c.style.width="50px",a.appendChild(c);let d=qe.create_param_ui_button("\u8A00",async u=>{try{o.value="\u8BF7\u5BF9\u7740\u8BDD\u7B52\u8BF4\u8BDD...",document.dispatchEvent(new CustomEvent("disabledAllUIEvent",{detail:{disabled:!0,showInterrupt:!1}})),d.textContent="\u{1F50A}";let f=await Ct.soundToText();if(f.length==0){o.value="\u6CA1\u6709\u83B7\u53D6\u5230\u8BED\u97F3";return}else if(f.length<=5){o.value=`${f}(\u5185\u5BB9\u592A\u77ED)`;return}o.value=f,document.getElementById("btnPrompt").dispatchEvent(new Event("click"))}catch(f){throw console.error(f),alert(`\u8BED\u97F3\u751F\u56FE\u65F6\u51FA\u9519${f}`),f}finally{d.textContent="\u8A00",document.dispatchEvent(new CustomEvent("disabledAllUIEvent",{detail:{disabled:!1,showInterrupt:!1}}))}});d.setAttribute("data-sound-prompt-button",!0),d.style.padding="0px",d.style.width="30px",d.style.display=window.config.promptMode===da.PROMPTMODE_COMMON&&window.config.soundPromptEnabled?"flex":"none",a.appendChild(d)}ua.exports={createParamPromptText:Xd}});var ga=T((lm,pa)=>{"use strict";var Jd=N();function Qd(){let e=document.getElementById("userInfoDialog");if(e)return;e=document.createElement("dialog"),e.id="userInfoDialog",e.style.cssText="width:300px; padding:20px; display:flex; flex-direction:column; align-items:center; text-align:center;";let t=document.createElement("sp-body");t.id="tfUserInfoMessage",t.textContent="\u8BF7\u8F93\u5165\u4F60\u7684\u624B\u673A\u53F7\u7801\uFF1A",t.style.marginBottom="15px";let n=document.createElement("sp-textfield");n.id="tfUserInfoPhone",n.setAttribute("maxlength","20"),n.setAttribute("placeholder","\u8BF7\u8F93\u5165\u624B\u673A\u53F7"),n.style.width="100%",n.style.margin="0 auto";let o=document.createElement("sp-action-button");o.id="btnUserInfoSubmit",o.textContent="\u63D0\u4EA4",o.style.marginTop="15px",e.appendChild(t),e.appendChild(n),e.appendChild(o),document.body.appendChild(e)}function eu(e){try{let{error:t}=e.detail;if(t.needinfo){Qd();let n=document.getElementById("userInfoDialog"),o=document.getElementById("btnUserInfoSubmit"),r=document.getElementById("tfUserInfoMessage");r.textContent=t.message,n.showModal(),o.removeEventListener("click",ma),o.addEventListener("click",ma,{once:!0})}else alert(t.message)}catch(t){alert(t)}}async function ma(){try{let e=document.getElementById("userInfoDialog"),n=document.getElementById("tfUserInfoPhone").value.trim();if(n.length<7||!/^\d+$/.test(n)){alert("\u8F93\u5165\u4E0D\u6B63\u786E");return}await Jd.registry_user(n),e.close()}catch(e){alert(e)}}pa.exports={verifyUserHandler:eu}});var Sa=T((cm,Ma)=>{"use strict";var{app:Gn}=H("photoshop"),tu=F(),Yt=G(),Me=N(),At=Go(),Tt=Qo(),it=ar(),wa=Un(),Yn=q(),re=Rr(),nu=In(),ou=Cn(),ru=An(),Kn=Hr(),St=sn(),xa=me(),C=k(),_a=_t(),au=fa(),iu=ga(),Zt=document.getElementById("btnPrompt"),Lt=document.getElementById("wfParamContainer"),It=document.getElementById("lSimpleLog"),Zn=document.getElementById("wfMainToolbar"),Xn=document.getElementById("btnInterrupt"),ya=document.getElementById("wfPromptContainer"),ha=document.getElementById("wfManageContainer"),su=document.getElementById("btnAddWorkflow"),Ca=document.getElementById("btnEditWorkflow"),lu=document.getElementById("btnWfConfig"),cu=document.getElementById("btnWfRefresh"),Ia=document.getElementById("btnSettings");function du(e,t){St.disabledWorkflowButtons(e,v),Zn.querySelectorAll("*").forEach(n=>{n.disabled=e}),Zt.disabled=e,Ia.disabled=e,Xn.disabled=!e,Xn.style.display=t?"flex":"none",Lt.querySelectorAll("*").forEach(n=>{n.hasAttribute("data-keep-enabled")||(n.disabled=e)}),It.textContent="",e?It.style.display=window.config.promptMode===C.PROMPTMODE_BATCH?"block":"none":It.style.display="none"}function Mt(e){Zn.children.forEach(t=>{t.disabled=e}),Lt.children.forEach(t=>{t.hasAttribute("data-keep-enabled")||(t.disabled=e)}),St.disabledWorkflowButtons(e,v)}function Jt(){try{Zn.children.forEach(n=>{n.disabled=!1}),St.disabledWorkflowButtons(!1,v);let t=Lt.querySelector(".btnWfEdit");t&&(t.disabled=!1),Ia.disabled=!1}catch(e){console.error(e)}}function Vn(e,t,n){let o=null,r=0;switch(t.kind){case C.PROMPTTEXT:o=au.createParamPromptText(e,t,n);break;case C.SLIDER:o=nu.createParam(t,n);break;case C.INPUTIMAGE:switch(window.config.promptMode){case C.PROMPTMODE_BATCH:o=re.createParamImageBatch(t);break;default:o=Kn.createParamImage(e,t)}r=1;break;case C.INPUTIMAGEMASK:o=Kn.createParamImage(t),r=1;break;case C.INPUTREGIONMASK:o=Kn.createParamImage(t),r=1;break;case C.FIELDENUM:o=re.createParamFIELDENUM(t,n);break;case C.CHECKBOX:o=ou.createParam(t,n);break;case C.RADIO:o=ru.createParam(t,n);break;default:o=re.createParamDefault(t,n)}return o.setAttribute("data-kind",t.kind),o.setAttribute("data-nodeid",t.nodeid),o.setAttribute("data-field",t.field),o.setAttribute("data-title",t.title),o.size="s",re.createParamDivider(),r}async function va(e){try{Lt.innerHTML="",It.textContent="",It.style.display="none",await Ta(e);let t=0;v.params.params.forEach(n=>{n.visible?window.config.promptMode===C.PROMPTMODE_LIVE?Vn(v,n,Tt.paramChanged):t+=Vn(v,n):window.config.promptMode===C.PROMPTMODE_BATCH&&n.kind===C.INPUTIMAGE&&Vn(v,n)}),window.config.promptMode===C.PROMPTMODE_BATCH?(re.createParamOutputBatch(v.params),re.createParamBatchPause()):window.config.promptMode===C.PROMPTMODE_LIVE&&re.createParamLiveSensitivity(Tt.sensitivityChanged),re.createWfTitle(v,t),Yn.clearLog(),window.showSingle(document.getElementById("logContainer")),Mt(!1)}catch(t){throw Mt(!0),Jt(),t}}function Aa(e){window.buildin=e}async function uu(e){if(!e.wfname)return;let[t,n]=await Me.connect_comfyui(window.config.comfyuiURL);if(t===!0){Aa(n),await va(e);return}Mt(!0);let o=new CustomEvent("comfyuiConnectEvent",{detail:{data:e,callback:va}});document.dispatchEvent(o)}async function Ea(){let e=re.getOutputDocId(v);if(e>0&&!Yt.existsDocument(e))throw new Error("\u6307\u5B9A\u7684\u8F93\u51FA\u6587\u6863\u4E0D\u6B63\u786E\uFF0C\u8BF7\u68C0\u67E5\u662F\u5426\u5DF2\u6253\u5F00");let t=new Set;for(let n of v.params.params){let o=null,r=re.getUIParamsInput(n);switch(r&&(o=r.value),n.kind){case C.SEED:o=o==null||o.trim()===""?xa.randInt(10**13,10**15-1):o,n.value=o;break;case C.PROMPTTEXT:o=o??n.value,n.value=o;let a=o;window.config.transEnable&&o&&(a=await Me.translateToEN(o)),n.valueen=a,_a.addHistory(o);break;case C.INPUTIMAGE:if(window.config.promptMode===C.PROMPTMODE_COMMON){if(!Gn.activeDocument)throw new Error("\u8BF7\u5148\u6253\u5F00\u56FE\u7247");if(o=o??-1,r&&o===-1)throw new Error(`${n.title}:\u6CA1\u6709\u9009\u5B9A\u56FE\u7247`);if(n.docid=o,t.has(n.docid))throw new Error(`"${n.title}":\u5176\u5B83\u6761\u4EF6\u5DF2\u7ECF\u6307\u5B9A\u4E86\u8BE5\u56FE\u7247`);if(t.add(n.docid),n.docid>=0&&!Yt.existsDocument(n.docid))throw new Error(`"${n.title}":\u56FE\u7247\u4E0D\u6B63\u786E\uFF0C\u8BF7\u68C0\u67E5\u662F\u5426\u5DF2\u6253\u5F00`)}else window.config.promptMode===C.PROMPTMODE_LIVE&&(o=o??-1,n.docid=o);break;case C.INPUTIMAGEMASK:if(window.config.promptMode===C.PROMPTMODE_LIVE)throw new Error(`"${n.title}":\u5B9E\u65F6\u751F\u56FE\u4E0D\u652F\u6301\u56FE\u7247\u8499\u677F\u6761\u4EF6\u3002`);if(window.config.promptMode===C.PROMPTMODE_COMMON){if(!Gn.activeDocument)throw new Error("\u8BF7\u5148\u6253\u5F00\u56FE\u7247");if(o=o??-1,r&&o===-1)throw new Error(`${n.title}:\u6CA1\u6709\u9009\u5B9A\u56FE\u7247`);if(n.docid=o,t.has(n.docid))throw new Error(`"${n.title}":\u5176\u5B83\u6761\u4EF6\u5DF2\u7ECF\u6307\u5B9A\u4E86\u8BE5\u56FE\u7247`);if(t.add(n.docid),n.docid>=0&&!Yt.existsDocument(n.docid))throw new Error(`"${n.title}":\u56FE\u7247\u4E0D\u6B63\u786E\uFF0C\u8BF7\u68C0\u67E5\u662F\u5426\u5DF2\u6253\u5F00`)}break;case C.INPUTREGIONMASK:if(window.config.promptMode===C.PROMPTMODE_LIVE)throw new Error(`"${n.title}":\u6279\u91CF\u751F\u56FE\u4E0D\u652F\u6301\u9009\u533A\u8499\u677F`);if(window.config.promptMode===C.PROMPTMODE_COMMON){if(!Gn.activeDocument)throw new Error("\u8BF7\u5148\u6253\u5F00\u56FE\u7247");if(o=o??-1,r&&o===-1)throw new Error(`${n.title}:\u6CA1\u6709\u9009\u5B9A\u56FE\u7247`);if(n.docid=o,t.has(n.docid))throw new Error(`"${n.title}":\u5176\u5B83\u6761\u4EF6\u5DF2\u7ECF\u6307\u5B9A\u4E86\u8BE5\u56FE\u7247`);if(t.add(n.docid),n.docid>=0&&!Yt.existsDocument(n.docid))throw new Error(`"${n.title}":\u56FE\u7247\u4E0D\u6B63\u786E\uFF0C\u8BF7\u68C0\u67E5\u662F\u5426\u5DF2\u6253\u5F00`)}break;case C.CHECKBOX:break;case C.RADIO:break;default:o=o??n.value,n.value=o}}return e}async function fu(){let e=[],t=new Set;for(let r of v.params.params){let a=null,i=re.getUIParamsInput(r);switch(i&&(a=i.value),r.kind){case C.SEED:a=a??xa.randInt(10**13,10**15-1),r.value=a;break;case C.PROMPTTEXT:a=a??r.value,r.value=a;let s=a;window.config.transEnable&&a&&(s=await Me.translateToEN(a)),_a.addHistory(a),r.valueen=s;break;case C.INPUTIMAGE:if(!a||a.trim()==="")throw new Error(`${r.title}:\u6CA1\u6709\u6307\u5B9A\u76EE\u5F55`);if(t.has(a))throw new Error(`"${r.title}":\u5176\u5B83\u6761\u4EF6\u5DF2\u7ECF\u6307\u5B9A\u4E86\u8BE5\u76EE\u5F55`);t.add(a),r.valuefolder=a,i&&i.hasAttribute("data-batch-named")?r.batchnamed=!0:r.batchnamed=!1,e.push(r);break;case C.INPUTIMAGEMASK:throw new Error(`"${r.title}":\u6279\u91CF\u751F\u56FE\u4E0D\u652F\u6301\u56FE\u7247\u8499\u677F\u6761\u4EF6\u3002`);case C.INPUTREGIONMASK:throw new Error(`"${r.title}":\u6279\u91CF\u751F\u56FE\u4E0D\u652F\u6301\u9009\u533A\u8499\u677F`);default:a=a??r.value,r.value=a}}if(e.length===0)throw new Error("\u6CA1\u6709\u627E\u5230\u201C\u83B7\u53D6\u56FE\u7247\u201D\u6761\u4EF6");if(e.length>3)throw new Error("\u6682\u4E0D\u652F\u63013\u4E2A\u4EE5\u4E0A\u7684\u201C\u83B7\u53D6\u56FE\u7247\u201D\u6761\u4EF6");let o=Lt.querySelector("[data-output-batchfolder]").value;if(!o)throw new Error("\u6CA1\u6709\u6307\u5B9A\u8F93\u51FA\u56FE\u50CF\u7684\u76EE\u5F55");if(t.has(o))throw new Error('"\u8F93\u51FA\u56FE\u50CF":\u5176\u5B83\u6761\u4EF6\u5DF2\u7ECF\u6307\u5B9A\u4E86\u8BE5\u76EE\u5F55');return v.params.output.folderbatch=o,e}async function mu(){try{if(!v.wfname){alert("\u8BF7\u9009\u62E9\u4E00\u4E2A\u5DE5\u4F5C\u6D41");return}if(!v.params){alert("\u672A\u6B63\u786E\u52A0\u8F7D\u5DE5\u4F5C\u6D41");return}if(window.config.promptMode===C.PROMPTMODE_BATCH){let e=await fu(),t;try{t=await tu.getFolderWithCreate(v.params.output.folderbatch)}catch(n){throw new Error(`"\u8F93\u51FA\u56FE\u50CF":${n.message}`)}if(await it.hasBatchTask(v.params.output.folderbatch)){if(await it.checkBatchTask(v.wfname,v.params,v.apidata,e),!await confirm('"\u8F93\u51FA\u56FE\u50CF":\u8BE5\u76EE\u5F55\u5DF2\u5B58\u5728\u6279\u91CF\u4EFB\u52A1\uFF0C\u5C06\u81EA\u52A8\u8DF3\u8FC7\u5DF2\u5904\u7406\u7684\u56FE\u7247\uFF0C\u8981\u7EE7\u7EED\u751F\u56FE\u5417\uFF1F'))return}else await it.createBatchTask(v.wfname,v.params,v.apidata,e);it.promptBatch(v.wfname,v.wfcode,v.params,v.apidata,e)}else if(window.config.promptMode===C.PROMPTMODE_LIVE){if(v.params.output.kind!==C.OUTPUTIMAGE){alert("\u5B9E\u65F6\u751F\u56FE\u65F6\uFF0C\u8F93\u51FA\u7C7B\u578B\u53EA\u80FD\u662F\u56FE\u50CF");return}await Ea(),Tt.promptLive(v.wfname,v.wfcode,v.params,v.apidata)}else{let e=await Ea();v.params.output.kind===C.OUTPUTIMAGE?At.prompt(v.wfname,v.wfcode,v.params,v.apidata,e):At.promptOutputText(v.wfname,v.wfcode,v.params,v.apidata)}}catch(e){throw Yn.error(e),e}}async function ba(){try{Yn.clearLog(),window.showSingle(document.getElementById("logContainer"));let e=await St.showWorkflowsPanel(v,uu);e||Jt(),Ca.style.display=e?"flex":"none",Zt.style.display=e?"flex":"none",Zt.textContent=re.getPromptModeLabel(),document.getElementById("btnWfBatchPromptHelp").style.display=window.config.promptMode===C.PROMPTMODE_BATCH||window.config.promptMode===C.PROMPTMODE_LIVE?"flex":"none"}catch(e){throw Mt(!0),Jt(),e}}async function pu(){try{Mt(!0),await Ta(null);let[e,t]=await Me.connect_comfyui(window.config.comfyuiURL);if(e===!0){Aa(t),await ba();return}let n=new CustomEvent("comfyuiConnectEvent",{detail:{data:{},callback:ba}});document.dispatchEvent(n)}catch(e){throw Jt(),console.error(e),alert(`\u52A0\u8F7D\u5DE5\u4F5C\u6D41\u5217\u8868\u65F6\u51FA\u9519:${e}`),e}}async function gu(e){try{let{textarea_id:t}=e.detail;if(!window.config.reverseWfName){alert("\u8BF7\u5728\u53C2\u6570\u8BBE\u7F6E\u4E2D\u6307\u5B9A\u53CD\u63A8\u5DE5\u4F5C\u6D41");return}let n=await Me.get_wf_params(window.config.reverseWfName,window.config.reverseWfCode),o=await Me.get_wf_api(window.config.reverseWfName,window.config.reverseWfCode);At.promptOutputText(window.config.reverseWfName,window.config.reverseWfCode,n,o,async r=>{let a=document.getElementById(t);if(window.config.transEnable){let i=await Me.translateToZH(r);a.value=i}else a.value=r})}catch(t){alert(t)}}function wu(){su.addEventListener("click",t=>{try{ha.style.display="flex",ya.style.display="none",wa.showNew()}catch(n){throw console.error(n),alert(n),n}}),Ca.addEventListener("click",t=>{try{if(!v.wfname)return;ha.style.display="flex",ya.style.display="none",wa.showEdit(v)}catch(n){throw console.error(n),alert(n),n}}),lu.addEventListener("click",t=>{try{St.showWorkflowsConfigDialg()}catch(n){throw console.error(n),alert(n),n}}),Zt.addEventListener("click",mu),Xn.addEventListener("click",async()=>{window.config.promptMode===C.PROMPTMODE_LIVE?Tt.interruptPrompt():window.config.promptMode===C.PROMPTMODE_BATCH?it.interruptPrompt():At.interruptPrompt()}),document.getElementById("btnWfBatchPromptHelp").addEventListener("click",async()=>{window.config.promptMode===C.PROMPTMODE_LIVE?Tt.showHelp():it.showHelp()}),document.addEventListener("wfRefreshWorkflowEvent",pu),document.addEventListener("verifyUserEvent",iu.verifyUserHandler),document.addEventListener("wfReverseEvent",gu),cu.addEventListener("click",async()=>{document.dispatchEvent(new CustomEvent("wfRefreshWorkflowEvent",{detail:{}}))}),document.dispatchEvent(new CustomEvent("wfRefreshWorkflowEvent",{detail:{}})),document.addEventListener("wfLoadTempImageEvent",async t=>{try{At.loadTempImage(t.detail)}catch(n){console.error(n)}}),document.addEventListener("refreshOutputImageMenuEvent",async t=>{try{re.refreshOutputImageMenu(t.detail.docid,v,t.detail.imageInputNum)}catch(n){console.error(n)}}),document.addEventListener("disabledAllUIEvent",async t=>{du(t.detail.disabled,t.detail.showInterrupt)})}var v={wfid:null,wfidrel:null,wfgroupid:null,wfname:null,params:null,apidata:null,userRole:"ADMIN"};async function Ta(e){e?(v.wfid=e.wfid,v.wfname=e.wfname,v.wfcode=e.wfcode||"",v.wfidrel=e.wfidrel,v.wfgroupid=e.wfgroupid,v.params=await Me.get_wf_params(v.wfname,v.wfcode),v.params.output.kind||(v.params.output.kind=C.OUTPUTIMAGE),v.params.output.field||(v.params.output.field="images"),v.apidata=await Me.get_wf_api(v.wfname,v.wfcode)):(v.wfid=null,v.wfname=null,v.wfcode=null,v.params=null,v.apidata=null,v.wfidrel=null,v.wfgroupid=null)}Ma.exports={initPanel:wu}});var Oa=T((dm,Da)=>{"use strict";var yu=N(),La=F(),Jn=k(),M={comfyuiURL:"http://127.0.0.1:8188",setAILayer:Jn.SETAILAYEROMIT,wfDisplayType:"button",wfNameLength:12,pszoomMinsize:"512",pszoomMaxsize:"1024",showDetailLog:!1,outputPreview:!1,transEnable:!1,transBaiduAppID:"",transBaiduAppKey:"",promptMode:Jn.PROMPTMODE_COMMON,livePromptSensitivity:2,batchPromptPause:2,batchPromptPreview:!0,reverseWfName:"",loadTempImage:!0,soundPromptEnabled:!1,QWenAPIKey:"",ZhipuAPIKey:""};window.config=M;var Pa="pluginConfig.json";async function hu(){try{let n=await(await(await La.getDataFolder()).getEntry(Pa)).read(),o=JSON.parse(n);Object.assign(M,o)}catch{console.log("\u4F7F\u7528\u9ED8\u8BA4\u53C2\u6570")}}async function ae(){try{await(await(await La.getDataFolder()).createEntry(Pa,{overwrite:!0})).write(JSON.stringify(M,null,2))}catch(e){console.error("Error saving config:",e)}}window.saveConfig=ae;function Qt(e,t){e.forEach(n=>{n.getAttribute("data-value")===t?n.removeAttribute("quiet"):n.setAttribute("quiet","")})}function vu(){setTimeout(()=>{},50)}async function ka(){try{if(document.getElementById("settingsContainer").children.length===0)return;let t=document.getElementById("spSetReverse"),n=await yu.get_workflows_i2t(),o=t.querySelector('sp-menu[slot="options"]');o.innerHTML="";for(let r=0;r<n.length;r++){let a=document.createElement("sp-menu-item");a.textContent=n[r].wfname,a.setAttribute("data-wfcode",n[r].wfcode||""),n[r].wfname===M.reverseWfName&&a.setAttribute("selected",!0),o.appendChild(a)}}catch(e){console.error(e)}}async function Eu(){let e=document.getElementById("btnSetAILayerClose"),t=document.getElementById("btnSetAILayerDel"),n=document.getElementById("btnSetAILayerOmit");document.getElementById("btnSetComfyuiURL").addEventListener("click",y=>{document.getElementById("wfSettingsDialog").close(),setTimeout(()=>{let S=P=>{vu()},B=new CustomEvent("comfyuiConnectEvent",{detail:{data:{},callback:S}});document.dispatchEvent(B)},50)});let o=[e,t,n];o.forEach(y=>{y.addEventListener("click",h=>{let S=h.currentTarget.getAttribute("data-value");S!==M.setAILayer&&(M.setAILayer=S,ae(),Qt([e,t,n],M.setAILayer),M.setAILayer===Jn.SETAILAYERDEL&&alert("\u542F\u7528\u8BE5\u53C2\u6570\u65F6\uFF0CAI\u751F\u56FE\u540E\u4F1A\u5220\u9664\u5176\u5B83\u7531AI\u751F\u6210\u7684\u56FE\u5C42\uFF0C\u8BF7\u8C28\u614E\u64CD\u4F5C\uFF01"))})}),Qt(o,M.setAILayer);let r=document.getElementById("spSetMaxSize"),a=document.getElementById("spSetMinSize");r.querySelectorAll("sp-menu-item").forEach(y=>{y.value===M.pszoomMaxsize&&y.setAttribute("selected",!0)}),a.querySelectorAll("sp-menu-item").forEach(y=>{y.value===M.pszoomMinsize&&y.setAttribute("selected",!0)}),r.addEventListener("change",y=>{let h=y.currentTarget.value;M.pszoomMaxsize=h,ae()}),a.addEventListener("change",y=>{let h=y.currentTarget.value;M.pszoomMinsize=h,ae()});let i=document.getElementById("cbSetLoadTempImage");i.checked=M.loadTempImage,i.addEventListener("change",async y=>{try{let h=document.getElementById("cbSetLoadTempImage").checked;M.loadTempImage=h,ae()}catch(h){throw console.error(h),alert(h),h}});let s=document.getElementById("cbSetTransEnable");s.checked=M.transEnable,s.addEventListener("change",async y=>{try{let h=document.getElementById("cbSetTransEnable").checked;M.transEnable=h,ae()}catch(h){throw console.error(h),alert(h),h}});let l=document.getElementById("cbSetTransBaiduAppID");l.value=M.transBaiduAppID,l.addEventListener("change",async y=>{try{let h=document.getElementById("cbSetTransBaiduAppID").value;M.transBaiduAppID=h,ae()}catch(h){throw console.error(h),alert(h),h}});let c=document.getElementById("cbSetTransBaiduAppKey");c.value=M.transBaiduAppKey,c.addEventListener("change",async y=>{try{let h=document.getElementById("cbSetTransBaiduAppKey").value;M.transBaiduAppKey=h,ae()}catch(h){throw console.error(h),alert(h),h}}),document.getElementById("btnSetTransBaiduHelp").addEventListener("click",y=>{document.getElementById("cbSetTransHelpBaiduDialog").showModal()});let d=document.getElementById("tfSetQWenAPIKey");d.value=M.QWenAPIKey,d.addEventListener("change",async y=>{try{let h=d.value;M.QWenAPIKey=h,ae()}catch(h){throw console.error(h),alert(h),h}}),document.getElementById("btnSetQWenHelp").addEventListener("click",y=>{document.getElementById("setQWenHelpDialog").showModal()});let u=document.getElementById("tfSetZhipuAPIKey");u.value=M.ZhipuAPIKey,u.addEventListener("change",async y=>{try{let h=u.value;M.ZhipuAPIKey=h,ae()}catch(h){throw console.error(h),alert(h),h}}),document.getElementById("btnSetZhipuHelp").addEventListener("click",y=>{document.getElementById("setZhipuHelpDialog").showModal()}),ka(),document.getElementById("spSetReverse").addEventListener("change",y=>{let h=y.currentTarget.value;M.reverseWfName=h,M.reverseWfCode=y.currentTarget.getAttribute("data-wfcode")||"",ae()});let m=document.getElementById("btnSetPromptCommon"),g=document.getElementById("btnSetPromptBatch"),w=document.getElementById("btnSetPromptLive"),p=[m,g,w];p.forEach(y=>{y.addEventListener("click",h=>{let S=h.currentTarget.getAttribute("data-value");S!==M.promptMode&&(M.promptMode=S,ae(),Qt(p,M.promptMode),document.dispatchEvent(new CustomEvent("wfRefreshWorkflowEvent",{detail:{}})))})}),Qt(p,M.promptMode);let b=document.getElementById("cbSetSoundPromptEnabled");b.checked=M.soundPromptEnabled,b.addEventListener("change",async y=>{try{let h=b.checked;M.soundPromptEnabled=h,ae(),document.getElementById("wfParamContainer").querySelectorAll("[data-sound-prompt-button]").forEach(B=>{B.style.display=M.soundPromptEnabled?"flex":"none"})}catch(h){throw console.error(h),alert(h),h}})}async function bu(){let e=document.getElementById("wfSettingsDialog");if(!e){let n=await(await fetch("html/settings.html")).text(),o=document.createElement("div");o.innerHTML=n,document.body.appendChild(o.firstElementChild),e=document.getElementById("wfSettingsDialog"),await Eu()}ka(),e.showModal()}Da.exports={loadConfig:hu,show:bu}});var Ua=T(()=>{var{entrypoints:xu}=H("uxp"),um=Io();typeof window.alert!="function"&&(window.alert=async function(e=""){let t=document.getElementById("alertDialog");t||(t=document.createElement("dialog"),t.innerHTML=`
      <sp-body>${e}</sp-body>
      <div style="width:100%;display: flex; justify-content:center;">
        <sp-action-button id="alertDialogOK" >\u786E\u5B9A</sp-action-button>
      </div>
      `,document.body.appendChild(t),t.querySelector("#alertDialogOK").addEventListener("click",()=>{t.close()})),t.querySelector("sp-body").textContent=e,t.style.width="350px",t.id="alertDialog",t.showModal()});typeof window.confirm!="function"&&(window.confirm=async function(e="\u786E\u5B9A\u8981\u7EE7\u7EED\u5417\uFF1F"){let t=document.getElementById("confirmDialog");return t||(t=document.createElement("dialog"),t.innerHTML=`
          <sp-body  style="width=100%;">${e}</sp-body>
          <div style="width:100%;display: flex; justify-content:center;">
            <sp-action-button id="confirmDialogCancel">\u53D6\u6D88</sp-action-button>
            <sp-action-button id="confirmDialogOK" >\u786E\u5B9A</sp-action-button>
          </div>
      `,t.id="confirmDialog",t.style.width="350px",document.body.appendChild(t)),t.querySelector("sp-body").textContent=e,new Promise(n=>{let o=t.querySelector("#confirmDialogOK"),r=o.cloneNode(!0);o.replaceWith(r);let a=t.querySelector("#confirmDialogCancel"),i=a.cloneNode(!0);a.replaceWith(i),r.addEventListener("click",()=>{t.close(),n(!0)}),i.addEventListener("click",()=>{t.close(),n(!1)}),t.showModal()})});xu.setup({panels:{"jinn_ps_ai.panel_main":{show(e){},create(){},hide(){},destroy(){},menuItems:[],invokeMenu(e){}}}});window.loadHtml=async function(t,n){try{let r=await(await fetch(n)).text();document.getElementById(t).innerHTML=r}catch(o){throw console.log(`\u52A0\u8F7D${n}\u5931\u8D25`,o),o}};window.loadCSS=function(t){var n=document.createElement("link");n.rel="stylesheet",n.type="text/css",n.href=t,document.head.appendChild(n)};window.showSingle=function(e){Array.from(Au.children).forEach(t=>{t===e?t.style.display="flex":t.style.display="none"})};document.body.innerHTML=`
  <div id="wfPromptContainer">
    <div id="wfMainToolbar" style="display: flex; align-items: center;  justify-content:space-between; ">
      <div style="display: flex; ">
      
        <sp-action-button id="btnSettings" title="\u8BBE\u7F6E" style=" justify-content: flex-end;" quiet>
          <div slot="icon" style="fill: currentColor">
            <svg viewBox="8 8 16 16" style="width: 18px; height: 18px;"><path fill="currentColor"  d="M21.6809 16.2095C21.6809 16.5068 21.8334 16.772 22.0878 16.9206C23.1918 17.5625 23.5706 18.9877 22.9343 20.0987C22.6239 20.6386 22.1235 21.0244 21.5246 21.1855C20.9294 21.3427 20.307 21.2618 19.7725 20.9513C19.5197 20.8036 19.2186 20.8036 18.9657 20.9497C18.709 21.0968 18.5558 21.3637 18.5558 21.6616C18.5558 22.9446 17.5179 23.9894 16.242 23.9894C14.9653 23.9894 13.9275 22.9446 13.9275 21.6616C13.9275 21.3628 13.7742 21.0968 13.5176 20.949C13.2647 20.8036 12.9636 20.8036 12.7123 20.9513C12.1771 21.2618 11.5539 21.3442 10.9572 21.1847C10.3589 21.0237 9.85945 20.6379 9.54981 20.0987C8.91342 18.9877 9.29308 17.5617 10.3963 16.9199C10.6507 16.7728 10.8024 16.5068 10.8024 16.2095C10.8024 15.9123 10.6507 15.6463 10.3963 15.4985C9.29308 14.8582 8.91342 13.4329 9.54981 12.3212C9.85945 11.7812 10.3589 11.3954 10.958 11.2343C11.5554 11.074 12.1771 11.1581 12.7123 11.4685C12.9643 11.6163 13.2655 11.6148 13.5176 11.4701C13.7742 11.3222 13.9275 11.0561 13.9275 10.7574C13.9275 9.47452 14.9653 8.42969 16.242 8.42969C17.5179 8.42969 18.5558 9.47452 18.5558 10.7574C18.5558 11.0554 18.709 11.3222 18.9657 11.4692C19.2193 11.6163 19.5205 11.6163 19.7725 11.4685C20.3063 11.1581 20.9285 11.0756 21.5246 11.2335C22.1235 11.3946 22.6239 11.7805 22.9343 12.3204C23.5706 13.4321 23.1918 14.8574 22.0885 15.4992C21.8334 15.647 21.6809 15.9123 21.6809 16.2095ZM16.2419 18.5434C14.955 18.5434 13.9079 17.4962 13.9079 16.2094C13.9079 14.9226 14.955 13.8755 16.2419 13.8755C17.5287 13.8755 18.5758 14.9226 18.5758 16.2094C18.5758 17.4962 17.5287 18.5434 16.2419 18.5434Z"></path> </svg>
          </div>
        </sp-action-button>

        <sp-action-button id="btnWfConfig" title="\u7BA1\u7406\u5DE5\u4F5C\u6D41" style="justify-content: flex-end;" quiet>
          <div slot="icon" style="fill: currentColor">
            <svg viewBox="8 8 16 16" style="width: 18px; height: 18px;">
            <g transform="translate(0, 1)"> 
              <path fill="currentColor" d="
                M10 9C9.72386 9 9.5 9.22386 9.5 9.5V22.5C9.5 22.7761 9.72386 23 10 23H22
                C22.2761 23 22.5 22.7761 22.5 22.5V9.5C22.5 9.22386 22.2761 9 22 9H10Z
                M11 11H21V12.5H11V11Z
                M11 14H21V15.5H11V14Z
                M11 17H17V18.5H11V17Z"/>
              </g>
            </svg>
          </div>
        </sp-action-button>
      </div>

      <div style="display: flex; align-items: center;  justify-content: flex-end;">
        <sp-action-button id="btnWfBatchPromptHelp" title="\u5E2E\u52A9" style="display: none;" quiet><sp-icon name="ui:HelpSmall" size="s" slot="icon"></sp-icon></sp-action-button>

        <sp-action-button id="btnEditWorkflow" title="\u4FEE\u6539\u5DE5\u4F5C\u6D41" style="display: none;" quiet>
          <div slot="icon" style="fill: currentColor"><svg viewBox="0 0 36 36" style="width: 18px; height: 18px;"><g scale(0.75)  transform="translate(4, 4)"> <path d="M32 9l-6-6-21 21-3 9 9-3L32 9z" /></g></svg></div>
        </sp-action-button>
        
        <sp-action-button id="btnAddWorkflow" title="\u6DFB\u52A0\u5DE5\u4F5C\u6D41" size="s" style="display: flex;" quiet>
          <div slot="icon" style="fill: currentColor"><svg viewBox="0 0 36 36" style="width: 18px; height: 18px;"><path d="M16 2v14H2v4h14v14h4V20h14v-4H20V2h-4z" fill="currentColor" /></svg></div>
        </sp-action-button>
        <sp-action-button id="btnWfRefresh" title="\u5237\u65B0" size="s" style="display: flex;" quiet>
          <div slot="icon" style="fill: currentColor">
            <svg viewBox="0 0 36 36" style="width: 18px; height: 18px;"><path d="M18 4a14 14 0 1 0 13.86 16h-3.02a11 11 0 1 1-2.68-9.29l-3.46 3.47H32V4l-3.92 3.92A13.95 13.95 0 0 0 18 4z" fill="currentColor"/></svg>
          </div>
        </sp-action-button>
      </div>
    </div>
    

    <div id="wfGroupContainer" style="display: flex;flex-wrap: wrap; color: #666;"></div>
    <sp-divider  id="wfGroupContainerDivider" size="s" style="margin-top: 3px;  "></sp-divider>
    <sp-divider  id="wfGroupContainerDivider2" size="s" style=""></sp-divider>
    
    <div id="wfButtonContainer" style="display: flex;flex-wrap: wrap; margin-top: 10px;  "></div>
    <sp-divider size="s" style="margin-top: 5px; margin-bottom: 0px;"></sp-divider>
    <sp-divider size="s" style="margin-bottom: 0px;"></sp-divider>

    <div id="wfButtonContainerRel" style="display: flex; justify-content: flex-end;padding:0px 10px;"></div>

    <div id="wfParamContainer" class="wfParamContainer">
    </div>
    
    <div id="buttonContainer" style="display: flex;flex-direction: row;  justify-content: space-between; align-items: center; width: 100%;margin-top: 25px;margin-bottom: 10px;">
      <div style="width: 30%; display: flex; justify-content:flex-start;">
        <sp-action-button id="btnInterrupt" title="\u4E2D\u65AD"  size="xxs" style="display: none; justify-content: flex-end;margin-right: 0px;" variant="warning" quiet>\u2715</sp-action-button>
      </div>
      
      <sp-button id="btnPrompt" style="width: 30%;  position: absolute;left: 50%;transform: translateX(-50%);">\u751F\u6210</sp-button>
      

      <div style="width: 30%;height:100%; display: flex; justify-content:flex-end; ">
        <sp-label id="lSimpleLog" style="display: none; justify-content: flex-end;text-align: right;"></sp-label>
        
      </div>
      

    </div>

    <div id='singleContainer' style="margin-top: 15px;">
      <div id="logContainer" style="display: flex;flex-direction: column;width: 100%;"></div>
      <div id="settingsContainer" style="display: none;flex-direction: column; overflow-y: auto;"></div>
      <div id="connContainer" style="display: none;"></div>
    </div>
    <div style="display: none; flex-direction: column; height: 200px; overflow: hidden;">
      <img id="wfPreviewImage" src="" alt="Preview" style="width: auto; height: auto; max-width: 100%; max-height: 100%; object-fit: contain;" >
    </div>
  </div>
  
  
  <div id="wfManageContainer" style="display: none;"></div>

`;var _u=Sa(),Cu=Un(),Iu=q(),Ba=Oa(),Au=document.getElementById("singleContainer");document.getElementById("btnSettings").addEventListener("click",Ba.show);document.addEventListener("DOMContentLoaded",async()=>{try{await Ba.loadConfig(),await window.loadHtml("logContainer","html/logger.html"),Iu.initPanel(),_u.initPanel(),Cu.initPanel()}catch(e){throw console.log(e),e}})});Ua();})();
